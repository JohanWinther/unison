<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeInType #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-comment">-- So we can keep using the old prettyprinter modules (which have a better</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- compatibility range) for now.</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-deprecations #-}</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-comment">{-|
Handles the &quot;Language.LSP.Types.TextDocumentDidChange&quot; \/
&quot;Language.LSP.Types.TextDocumentDidOpen&quot; \/
&quot;Language.LSP.Types.TextDocumentDidClose&quot; messages to keep an in-memory
`filesystem` of the current client workspace.  The server can access and edit
files in the client workspace by operating on the &quot;VFS&quot; in &quot;LspFuncs&quot;.
-}</span><span>
</span><span id="line-28"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.LSP.VFS</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">(</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier">VFS</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier">vfsMap</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#vfsTempDir"><span class="hs-identifier">vfsTempDir</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier">VirtualFile</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#lsp_version"><span class="hs-identifier">lsp_version</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#file_version"><span class="hs-identifier">file_version</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#file_text"><span class="hs-identifier">file_text</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileText"><span class="hs-identifier">virtualFileText</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileVersion"><span class="hs-identifier">virtualFileVersion</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier">VfsLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Managing the VFS</span></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#initVFS"><span class="hs-identifier">initVFS</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#openVFS"><span class="hs-identifier">openVFS</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier">changeFromClientVFS</span></a></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#changeFromServerVFS"><span class="hs-identifier">changeFromServerVFS</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#persistFileVFS"><span class="hs-identifier">persistFileVFS</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#closeVFS"><span class="hs-identifier">closeVFS</span></a></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Positions and transformations</span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier">CodePointPosition</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#line"><span class="hs-identifier">line</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#character"><span class="hs-identifier">character</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier">codePointPositionToPosition</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier">positionToCodePointPosition</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier">CodePointRange</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#start"><span class="hs-identifier">start</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#end"><span class="hs-identifier">end</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#codePointRangeToRange"><span class="hs-identifier">codePointRangeToRange</span></a></span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#rangeToCodePointRange"><span class="hs-identifier">rangeToCodePointRange</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><span class="hs-comment">-- * manipulating the file contents</span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#rangeLinesFromVfs"><span class="hs-identifier">rangeLinesFromVfs</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier">PosPrefixInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#getCompletionPrefix"><span class="hs-identifier">getCompletionPrefix</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="hs-comment">-- * for tests</span></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier">applyChanges</span></a></span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier">applyChange</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier">changeChars</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-operator">(&lt;.&gt;)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">parts</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Colog.Core</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogAction</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">WithSeverity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Severity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;&amp;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isUpper</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isAlphaNum</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Int</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Row</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Ord</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Rope</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">URope</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Text.Utf16.Rope</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Rope</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Utf16.Rope</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rope</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Text.Prettyprint.Doc</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">line</span></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Types</span></span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Lens</span></span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Message</span></span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.IO.Temp</span></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">traverse_</span></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-100"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">module</span><span> </span><span class="hs-pragma">(</span><span class="annot"><span class="hs-pragma">&quot;hlint: ignore Eta reduce&quot;</span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="annot"><span class="hs-pragma hs-type">String</span></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-101"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">module</span><span> </span><span class="hs-pragma">(</span><span class="annot"><span class="hs-pragma">&quot;hlint: ignore Redundant do&quot;</span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="annot"><span class="hs-pragma hs-type">String</span></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-keyword">data</span><span> </span><span id="VirtualFile"><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-105"></span><span>  </span><span id="VirtualFile"><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-106"></span><span>      </span><span id="%24sel%3A_lsp_version%3AVirtualFile"><span class="annot"><span class="annottext">VirtualFile -&gt; Int32
</span><a href="Language.LSP.VFS.html#%24sel%3A_lsp_version%3AVirtualFile"><span class="hs-identifier hs-var hs-var">_lsp_version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span>  </span><span class="hs-comment">-- ^ The LSP version of the document</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_file_version%3AVirtualFile"><span class="annot"><span class="annottext">VirtualFile -&gt; Int
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_version%3AVirtualFile"><span class="hs-identifier hs-var hs-var">_file_version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ This number is only incremented whilst the file</span><span>
</span><span id="line-108"></span><span>                           </span><span class="hs-comment">-- remains in the map.</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_file_text%3AVirtualFile"><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var hs-var">_file_text</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span>  </span><span class="hs-comment">-- ^ The full contents of the document</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210483"><span id="local-6989586621679210485"><span id="local-6989586621679210494"><span class="annot"><span class="annottext">Int -&gt; VirtualFile -&gt; ShowS
[VirtualFile] -&gt; ShowS
VirtualFile -&gt; [Char]
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [VirtualFile] -&gt; ShowS
$cshowList :: [VirtualFile] -&gt; ShowS
show :: VirtualFile -&gt; [Char]
$cshow :: VirtualFile -&gt; [Char]
showsPrec :: Int -&gt; VirtualFile -&gt; ShowS
$cshowsPrec :: Int -&gt; VirtualFile -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-keyword">data</span><span> </span><span id="VFS"><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-var">VFS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="VFS"><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-var">VFS</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="%24sel%3A_vfsMap%3AVFS"><span class="annot"><span class="annottext">VFS -&gt; Map NormalizedUri VirtualFile
</span><a href="Language.LSP.VFS.html#%24sel%3A_vfsMap%3AVFS"><span class="hs-identifier hs-var hs-var">_vfsMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_vfsTempDir%3AVFS"><span class="annot"><span class="annottext">VFS -&gt; [Char]
</span><a href="Language.LSP.VFS.html#%24sel%3A_vfsTempDir%3AVFS"><span class="hs-identifier hs-var hs-var">_vfsTempDir</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-comment">-- ^ This is where all the temporary files will be written to</span><span>
</span><span id="line-114"></span><span>               </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679210464"><span id="local-6989586621679210466"><span id="local-6989586621679210476"><span class="annot"><span class="annottext">Int -&gt; VFS -&gt; ShowS
[VFS] -&gt; ShowS
VFS -&gt; [Char]
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [VFS] -&gt; ShowS
$cshowList :: [VFS] -&gt; ShowS
show :: VFS -&gt; [Char]
$cshow :: VFS -&gt; [Char]
showsPrec :: Int -&gt; VFS -&gt; ShowS
$cshowsPrec :: Int -&gt; VFS -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-keyword">data</span><span> </span><span id="VfsLog"><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-var">VfsLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-117"></span><span>  </span><span id="SplitInsideCodePoint"><span class="annot"><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-var">SplitInsideCodePoint</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Position</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="URINotFound"><span class="annot"><a href="Language.LSP.VFS.html#URINotFound"><span class="hs-identifier hs-var">URINotFound</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Opening"><span class="annot"><a href="Language.LSP.VFS.html#Opening"><span class="hs-identifier hs-var">Opening</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Closing"><span class="annot"><a href="Language.LSP.VFS.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PersistingFile"><span class="annot"><a href="Language.LSP.VFS.html#PersistingFile"><span class="hs-identifier hs-var">PersistingFile</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CantRecursiveDelete"><span class="annot"><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-var">CantRecursiveDelete</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DeleteNonExistent"><span class="annot"><a href="Language.LSP.VFS.html#DeleteNonExistent"><span class="hs-identifier hs-var">DeleteNonExistent</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210431"><span id="local-6989586621679210433"><span id="local-6989586621679210453"><span class="annot"><span class="annottext">Int -&gt; VfsLog -&gt; ShowS
[VfsLog] -&gt; ShowS
VfsLog -&gt; [Char]
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [VfsLog] -&gt; ShowS
$cshowList :: [VfsLog] -&gt; ShowS
show :: VfsLog -&gt; [Char]
$cshow :: VfsLog -&gt; [Char]
showsPrec :: Int -&gt; VfsLog -&gt; ShowS
$cshowsPrec :: Int -&gt; VfsLog -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679210428"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-127"></span><span>  </span><span id="local-6989586621679210405"><span class="annot"><span class="annottext">pretty :: forall ann. VfsLog -&gt; Doc ann
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-type">SplitInsideCodePoint</span></a></span><span> </span><span id="local-6989586621679210403"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679210403"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679210402"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679210402"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: asked to make change inside code point. Position&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679210403"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;in&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679210402"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#URINotFound"><span class="hs-identifier hs-type">URINotFound</span></a></span><span> </span><span id="local-6989586621679210399"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210399"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: don't know about URI&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210399"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#Opening"><span class="hs-identifier hs-type">Opening</span></a></span><span> </span><span id="local-6989586621679210398"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210398"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: opening&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210398"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#Closing"><span class="hs-identifier hs-type">Closing</span></a></span><span> </span><span id="local-6989586621679210397"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210397"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: closing&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210397"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#PersistingFile"><span class="hs-identifier hs-type">PersistingFile</span></a></span><span> </span><span id="local-6989586621679210396"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210396"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span id="local-6989586621679210395"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679210395"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: Writing virtual file for&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210396"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;to&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679210395"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-type">CantRecursiveDelete</span></a></span><span> </span><span id="local-6989586621679210394"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210394"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: can't recursively delete&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210394"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;because we don't track directory status&quot;</span></span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#DeleteNonExistent"><span class="hs-identifier hs-type">DeleteNonExistent</span></a></span><span> </span><span id="local-6989586621679210393"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210393"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: asked to delete non-existent file&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210393"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="local-6989586621679210383"><span id="local-6989586621679210387"><span id="local-6989586621679210391"><span id="file_text"><span id="file_version"><span id="lsp_version"><span id="HasFile_text"><span id="local-6989586621679210931"><span id="local-6989586621679210932"><span id="HasFile_version"><span id="local-6989586621679210934"><span id="local-6989586621679210935"><span id="HasLsp_version"><span id="local-6989586621679210938"><span id="local-6989586621679210939"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">VirtualFile</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-138"></span><span id="local-6989586621679210354"><span id="local-6989586621679210358"><span id="vfsTempDir"><span id="vfsMap"><span id="HasVfsMap"><span id="local-6989586621679210919"><span id="local-6989586621679210920"><span id="HasVfsTempDir"><span id="local-6989586621679210922"><span id="local-6989586621679210923"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">VFS</span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">---</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileText"><span class="hs-identifier hs-type">virtualFileText</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-143"></span><span id="virtualFileText"><span class="annot"><span class="annottext">virtualFileText :: VirtualFile -&gt; Text
</span><a href="Language.LSP.VFS.html#virtualFileText"><span class="hs-identifier hs-var hs-var">virtualFileText</span></a></span></span><span> </span><span id="local-6989586621679210339"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210339"><span class="hs-identifier hs-var">vf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210339"><span class="hs-identifier hs-var">vf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileVersion"><span class="hs-identifier hs-type">virtualFileVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span>
</span><span id="line-146"></span><span id="virtualFileVersion"><span class="annot"><span class="annottext">virtualFileVersion :: VirtualFile -&gt; Int32
</span><a href="Language.LSP.VFS.html#virtualFileVersion"><span class="hs-identifier hs-var hs-var">virtualFileVersion</span></a></span></span><span> </span><span id="local-6989586621679210337"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210337"><span class="hs-identifier hs-var">vf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Int32
</span><a href="Language.LSP.VFS.html#%24sel%3A_lsp_version%3AVirtualFile"><span class="hs-identifier hs-var">_lsp_version</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210337"><span class="hs-identifier hs-var">vf</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">---</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span id="local-6989586621679210914"><span class="annot"><a href="Language.LSP.VFS.html#initVFS"><span class="hs-identifier hs-type">initVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679210914"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679210914"><span class="hs-identifier hs-type">r</span></a></span></span><span>
</span><span id="line-151"></span><span id="initVFS"><span class="annot"><span class="annottext">initVFS :: forall r. (VFS -&gt; IO r) -&gt; IO r
</span><a href="Language.LSP.VFS.html#initVFS"><span class="hs-identifier hs-var hs-var">initVFS</span></a></span></span><span> </span><span id="local-6989586621679210328"><span class="annot"><span class="annottext">VFS -&gt; IO r
</span><a href="#local-6989586621679210328"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, MonadMask m) =&gt;
[Char] -&gt; ([Char] -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withSystemTempDirectory</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;haskell-lsp&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679210326"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679210326"><span class="hs-identifier hs-var">temp_dir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VFS -&gt; IO r
</span><a href="#local-6989586621679210328"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map NormalizedUri VirtualFile -&gt; [Char] -&gt; VFS
</span><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-var">VFS</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679210326"><span class="hs-identifier hs-var">temp_dir</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | Applies the changes from a 'J.DidOpenTextDocument' to the 'VFS'</span><span>
</span><span id="line-156"></span><span id="local-6989586621679210902"><span class="annot"><a href="Language.LSP.VFS.html#openVFS"><span class="hs-identifier hs-type">openVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210902"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210902"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_TextDocumentDidOpen</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210902"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-157"></span><span id="openVFS"><span class="annot"><span class="annottext">openVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidOpen
-&gt; m ()
</span><a href="Language.LSP.VFS.html#openVFS"><span class="hs-identifier hs-var hs-var">openVFS</span></a></span></span><span> </span><span id="local-6989586621679210313"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210313"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679210312"><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidOpen
</span><a href="#local-6989586621679210312"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentItem</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679210300"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210300"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679210299"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679210299"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679210298"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679210298"><span class="hs-identifier hs-var">text</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidOpen
</span><a href="#local-6989586621679210312"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasParams s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.params</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasTextDocument s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.textDocument</span></span><span>
</span><span id="line-159"></span><span>      </span><span id="local-6989586621679210293"><span class="annot"><span class="annottext">vfile :: VirtualFile
</span><a href="#local-6989586621679210293"><span class="hs-identifier hs-var hs-var">vfile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int -&gt; Rope -&gt; VirtualFile
</span><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679210299"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679210298"><span class="hs-identifier hs-var">text</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210313"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#Opening"><span class="hs-identifier hs-var">Opening</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210300"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Debug</span></span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210300"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210293"><span class="hs-identifier hs-var">vfile</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="hs-comment">-- | Applies a 'DidChangeTextDocumentNotification' to the 'VFS'</span><span>
</span><span id="line-166"></span><span id="local-6989586621679210851"><span class="annot"><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier hs-type">changeFromClientVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210851"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210851"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_TextDocumentDidChange</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210851"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-167"></span><span id="changeFromClientVFS"><span class="annot"><span class="annottext">changeFromClientVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidChange
-&gt; m ()
</span><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier hs-var hs-var">changeFromClientVFS</span></a></span></span><span> </span><span id="local-6989586621679210269"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210269"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679210268"><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679210268"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">J.DidChangeTextDocumentParams</span></span><span> </span><span id="local-6989586621679210262"><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679210262"><span class="hs-identifier hs-var">vid</span></a></span></span><span> </span><span id="local-6989586621679210261"><span class="annot"><span class="annottext">[TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679210261"><span class="hs-identifier hs-var">changes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679210268"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasParams s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.params</span></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-comment">-- the client shouldn't be sending over a null version, only the server, but we just use 0 if that happens</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">J.VersionedTextDocumentIdentifier</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679210259"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210259"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679210258"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679210258"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679210262"><span class="hs-identifier hs-var">vid</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span id="local-6989586621679210257"><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679210257"><span class="hs-identifier hs-var">vfs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679210257"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210259"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-174"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679210255"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679210255"><span class="hs-identifier hs-var">file_ver</span></a></span></span><span> </span><span id="local-6989586621679210254"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679210254"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>      </span><span id="local-6989586621679210253"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679210253"><span class="hs-identifier hs-var">contents'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; [TextDocumentContentChangeEvent] -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier hs-var">applyChanges</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210269"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679210254"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">[TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679210261"><span class="hs-identifier hs-var">changes</span></a></span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210259"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32 -&gt; Int -&gt; Rope -&gt; VirtualFile
</span><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679210258"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679210255"><span class="hs-identifier hs-var">file_ver</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679210253"><span class="hs-identifier hs-var">contents'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="annottext">Maybe VirtualFile
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210269"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#URINotFound"><span class="hs-identifier hs-var">URINotFound</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210259"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span id="local-6989586621679210843"><span class="annot"><a href="Language.LSP.VFS.html#applyCreateFile"><span class="hs-identifier hs-type">applyCreateFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210843"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.CreateFile</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210843"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-182"></span><span id="applyCreateFile"><span class="annot"><span class="annottext">applyCreateFile :: forall (m :: * -&gt; *). MonadState VFS m =&gt; CreateFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyCreateFile"><span class="hs-identifier hs-var hs-var">applyCreateFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFile</span></span><span> </span><span id="local-6989586621679210239"><span class="annot"><span class="annottext">Maybe ChangeAnnotationIdentifier
</span><a href="#local-6989586621679210239"><span class="hs-identifier hs-var">_ann</span></a></span></span><span> </span><span id="local-6989586621679210238"><span class="annot"><span class="annottext">AString &quot;create&quot;
</span><a href="#local-6989586621679210238"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679210237"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210237"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679210236"><span class="annot"><span class="annottext">Maybe CreateFileOptions
</span><a href="#local-6989586621679210236"><span class="hs-identifier hs-var">options</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insertWith</span></span><span>
</span><span id="line-184"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679210233"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210233"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span id="local-6989586621679210232"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210232"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679210231"><span class="hs-identifier hs-var">shouldOverwrite</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210233"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679210232"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>                </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210237"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-186"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32 -&gt; Int -&gt; Rope -&gt; VirtualFile
</span><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="#local-6989586621679210231"><span class="hs-identifier hs-type">shouldOverwrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621679210231"><span class="annot"><span class="annottext">shouldOverwrite :: Bool
</span><a href="#local-6989586621679210231"><span class="hs-identifier hs-var hs-var">shouldOverwrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CreateFileOptions
</span><a href="#local-6989586621679210236"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="annottext">Maybe CreateFileOptions
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- default</span><span>
</span><span id="line-191"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- default</span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `ignoreIfExists` is True</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `ignoreIfExists` is False</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>   </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-196"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-197"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span id="local-6989586621679210831"><span class="annot"><a href="Language.LSP.VFS.html#applyRenameFile"><span class="hs-identifier hs-type">applyRenameFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210831"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.RenameFile</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210831"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-202"></span><span id="applyRenameFile"><span class="annot"><span class="annottext">applyRenameFile :: forall (m :: * -&gt; *). MonadState VFS m =&gt; RenameFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyRenameFile"><span class="hs-identifier hs-var hs-var">applyRenameFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFile</span></span><span> </span><span id="local-6989586621679210187"><span class="annot"><span class="annottext">Maybe ChangeAnnotationIdentifier
</span><a href="#local-6989586621679210187"><span class="hs-identifier hs-var">_ann</span></a></span></span><span> </span><span id="local-6989586621679210186"><span class="annot"><span class="annottext">AString &quot;rename&quot;
</span><a href="#local-6989586621679210186"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679210185"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210185"><span class="hs-identifier hs-var">oldUri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679210184"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210184"><span class="hs-identifier hs-var">newUri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679210183"><span class="annot"><span class="annottext">Maybe RenameFileOptions
</span><a href="#local-6989586621679210183"><span class="hs-identifier hs-var">options</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>  </span><span id="local-6989586621679210182"><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679210182"><span class="hs-identifier hs-var">vfs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679210182"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210185"><span class="hs-identifier hs-var">oldUri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-comment">-- nothing to rename</span><span>
</span><span id="line-206"></span><span>      </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679210181"><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><a href="#local-6989586621679210181"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679210182"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210184"><span class="hs-identifier hs-var">newUri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-comment">-- the target does not exist, just move over</span><span>
</span><span id="line-209"></span><span>        </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-210"></span><span>          </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210185"><span class="hs-identifier hs-var">oldUri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-211"></span><span>          </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210184"><span class="hs-identifier hs-var">newUri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><a href="#local-6989586621679210181"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-212"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679210179"><span class="hs-identifier hs-var">shouldOverwrite</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>          </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210185"><span class="hs-identifier hs-var">oldUri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-214"></span><span>          </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210184"><span class="hs-identifier hs-var">newUri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><a href="#local-6989586621679210181"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="#local-6989586621679210179"><span class="hs-identifier hs-type">shouldOverwrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621679210179"><span class="annot"><span class="annottext">shouldOverwrite :: Bool
</span><a href="#local-6989586621679210179"><span class="hs-identifier hs-var hs-var">shouldOverwrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe RenameFileOptions
</span><a href="#local-6989586621679210183"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">Maybe RenameFileOptions
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- default</span><span>
</span><span id="line-219"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- default</span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `ignoreIfExists` is True</span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `ignoreIfExists` is False</span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>   </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-226"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span id="local-6989586621679210823"><span class="annot"><a href="Language.LSP.VFS.html#applyDeleteFile"><span class="hs-identifier hs-type">applyDeleteFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210823"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210823"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DeleteFile</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210823"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-230"></span><span id="applyDeleteFile"><span class="annot"><span class="annottext">applyDeleteFile :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DeleteFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDeleteFile"><span class="hs-identifier hs-var hs-var">applyDeleteFile</span></a></span></span><span> </span><span id="local-6989586621679210140"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210140"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.DeleteFile</span></span><span> </span><span id="local-6989586621679210138"><span class="annot"><span class="annottext">Maybe ChangeAnnotationIdentifier
</span><a href="#local-6989586621679210138"><span class="hs-identifier hs-var">_ann</span></a></span></span><span> </span><span id="local-6989586621679210137"><span class="annot"><span class="annottext">AString &quot;delete&quot;
</span><a href="#local-6989586621679210137"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679210136"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210136"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679210135"><span class="annot"><span class="annottext">Maybe DeleteFileOptions
</span><a href="#local-6989586621679210135"><span class="hs-identifier hs-var">options</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-comment">-- NOTE: we are ignoring the `recursive` option here because we don't know which file is a directory</span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeleteFileOptions
</span><a href="#local-6989586621679210135"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasRecursive s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.recursive</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210140"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-var">CantRecursiveDelete</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210136"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-comment">-- Remove and get the old value so we can check if it was missing</span><span>
</span><span id="line-235"></span><span>  </span><span id="local-6989586621679210131"><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><a href="#local-6989586621679210131"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210136"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m b
</span><span class="hs-operator hs-var">&lt;.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><a href="#local-6989586621679210131"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-comment">-- It's not entirely clear what the semantics of 'ignoreIfNotExists' are, but if it</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-comment">-- doesn't exist and we're not ignoring it, let's at least log it.</span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe DeleteFileOptions
</span><a href="#local-6989586621679210135"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasIgnoreIfNotExists s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.ignoreIfNotExists</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>              </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210140"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-var">CantRecursiveDelete</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679210136"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span id="local-6989586621679210798"><span class="annot"><a href="Language.LSP.VFS.html#applyTextDocumentEdit"><span class="hs-identifier hs-type">applyTextDocumentEdit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210798"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210798"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210798"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-244"></span><span id="applyTextDocumentEdit"><span class="annot"><span class="annottext">applyTextDocumentEdit :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; TextDocumentEdit -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyTextDocumentEdit"><span class="hs-identifier hs-var hs-var">applyTextDocumentEdit</span></a></span></span><span> </span><span id="local-6989586621679210028"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210028"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentEdit</span></span><span> </span><span id="local-6989586621679210026"><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
</span><a href="#local-6989586621679210026"><span class="hs-identifier hs-var">vid</span></a></span></span><span> </span><span id="local-6989586621679210025"><span class="annot"><span class="annottext">[TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679210025"><span class="hs-identifier hs-var">edits</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-comment">-- all edits are supposed to be applied at once</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-comment">-- so apply from bottom up so they don't affect others</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210020"><span class="annot"><span class="annottext">sortedEdits :: [TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679210020"><span class="hs-identifier hs-var hs-var">sortedEdits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Down a
</span><span class="hs-identifier hs-var">Down</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TextEdit |? AnnotatedTextEdit) -&gt; Range
</span><a href="#local-6989586621679210017"><span class="hs-identifier hs-var">editRange</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679210025"><span class="hs-identifier hs-var">edits</span></a></span><span>
</span><span id="line-248"></span><span>      </span><span id="local-6989586621679210016"><span class="annot"><span class="annottext">changeEvents :: [TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679210016"><span class="hs-identifier hs-var hs-var">changeEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(TextEdit |? AnnotatedTextEdit) -&gt; TextDocumentContentChangeEvent
</span><a href="#local-6989586621679210015"><span class="hs-identifier hs-var">editToChangeEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679210020"><span class="hs-identifier hs-var">sortedEdits</span></a></span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-comment">-- TODO: is this right?</span><span>
</span><span id="line-250"></span><span>      </span><span id="local-6989586621679210007"><span class="annot"><span class="annottext">vid' :: VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679210007"><span class="hs-identifier hs-var hs-var">vid'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; Int32 -&gt; VersionedTextDocumentIdentifier
</span><span class="hs-identifier hs-var">J.VersionedTextDocumentIdentifier</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
</span><a href="#local-6989586621679210026"><span class="hs-identifier hs-var">vid</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasUri s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.uri</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
</span><a href="#local-6989586621679210026"><span class="hs-identifier hs-var">vid</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasVersion s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.version</span></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679210003"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679210003"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679210003"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="annot"><span class="annottext">Null
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>      </span><span id="local-6989586621679210001"><span class="annot"><span class="annottext">ps :: DidChangeTextDocumentParams
</span><a href="#local-6989586621679210001"><span class="hs-identifier hs-var hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
-&gt; [TextDocumentContentChangeEvent] -&gt; DidChangeTextDocumentParams
</span><span class="hs-identifier hs-var">J.DidChangeTextDocumentParams</span></span><span> </span><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679210007"><span class="hs-identifier hs-var">vid'</span></a></span><span> </span><span class="annot"><span class="annottext">[TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679210016"><span class="hs-identifier hs-var">changeEvents</span></a></span><span>
</span><span id="line-252"></span><span>      </span><span id="local-6989586621679209998"><span class="annot"><span class="annottext">notif :: TNotificationMessage @'ClientToServer 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679209998"><span class="hs-identifier hs-var hs-var">notif</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: MessageDirection) (m :: Method f 'Notification).
Text
-&gt; SMethod @f @'Notification m
-&gt; MessageParams @f @'Notification m
-&gt; TNotificationMessage @f m
</span><span class="hs-identifier hs-var">J.TNotificationMessage</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SMethod
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
</span><span class="hs-identifier hs-var">J.SMethod_TextDocumentDidChange</span></span><span> </span><span class="annot"><span class="annottext">DidChangeTextDocumentParams
</span><a href="#local-6989586621679210001"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidChange
-&gt; m ()
</span><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier hs-var">changeFromClientVFS</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679210028"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TNotificationMessage @'ClientToServer 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679209998"><span class="hs-identifier hs-var">notif</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><a href="#local-6989586621679210017"><span class="hs-identifier hs-type">editRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextEdit</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">J.|?</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.AnnotatedTextEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621679210017"><span class="annot"><span class="annottext">editRange :: (TextEdit |? AnnotatedTextEdit) -&gt; Range
</span><a href="#local-6989586621679210017"><span class="hs-identifier hs-var hs-var">editRange</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679209995"><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679209995"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679209995"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasRange s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.range</span></span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><a href="#local-6989586621679210017"><span class="hs-identifier hs-var">editRange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679209993"><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679209993"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679209993"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasRange s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.range</span></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><a href="#local-6989586621679210015"><span class="hs-identifier hs-type">editToChangeEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextEdit</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">J.|?</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.AnnotatedTextEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621679210015"><span class="annot"><span class="annottext">editToChangeEvent :: (TextEdit |? AnnotatedTextEdit) -&gt; TextDocumentContentChangeEvent
</span><a href="#local-6989586621679210015"><span class="hs-identifier hs-var hs-var">editToChangeEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679209992"><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679209992"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Rec
   ((.+)
      @(*)
      (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
      ((.+)
         @(*)
         (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
 |? Rec
      ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; TextDocumentContentChangeEvent
</span><span class="hs-identifier hs-var">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;range&quot; a =&gt; a
</span><span class="">#range</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679209992"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasRange s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.range</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;rangeLength&quot; a =&gt; a
</span><span class="">#rangeLength</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;text&quot; a =&gt; a
</span><span class="">#text</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679209992"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasNewText s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.newText</span></span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><a href="#local-6989586621679210015"><span class="hs-identifier hs-var">editToChangeEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679209987"><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679209987"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Rec
   ((.+)
      @(*)
      (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
      ((.+)
         @(*)
         (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
 |? Rec
      ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; TextDocumentContentChangeEvent
</span><span class="hs-identifier hs-var">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;range&quot; a =&gt; a
</span><span class="">#range</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679209987"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasRange s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.range</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;rangeLength&quot; a =&gt; a
</span><span class="">#rangeLength</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;text&quot; a =&gt; a
</span><span class="">#text</span></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679209987"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasNewText s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.newText</span></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span id="local-6989586621679210725"><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-type">applyDocumentChange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210725"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210725"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DocumentChange</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210725"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-265"></span><span id="applyDocumentChange"><span class="annot"><span class="annottext">applyDocumentChange :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DocumentChange -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var hs-var">applyDocumentChange</span></a></span></span><span> </span><span id="local-6989586621679209980"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209980"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span>               </span><span id="local-6989586621679209979"><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679209979"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; TextDocumentEdit -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyTextDocumentEdit"><span class="hs-identifier hs-var">applyTextDocumentEdit</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209980"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679209979"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-266"></span><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span>        </span><span id="local-6989586621679209978"><span class="annot"><span class="annottext">CreateFile
</span><a href="#local-6989586621679209978"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadState VFS m =&gt; CreateFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyCreateFile"><span class="hs-identifier hs-var">applyCreateFile</span></a></span><span> </span><span class="annot"><span class="annottext">CreateFile
</span><a href="#local-6989586621679209978"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-267"></span><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679209977"><span class="annot"><span class="annottext">RenameFile
</span><a href="#local-6989586621679209977"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadState VFS m =&gt; RenameFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyRenameFile"><span class="hs-identifier hs-var">applyRenameFile</span></a></span><span> </span><span class="annot"><span class="annottext">RenameFile
</span><a href="#local-6989586621679209977"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-268"></span><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span id="local-6989586621679209976"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209976"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679209975"><span class="annot"><span class="annottext">DeleteFile
</span><a href="#local-6989586621679209975"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DeleteFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDeleteFile"><span class="hs-identifier hs-var">applyDeleteFile</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209976"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DeleteFile
</span><a href="#local-6989586621679209975"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="hs-comment">-- | Applies the changes from a 'ApplyWorkspaceEditRequest' to the 'VFS'</span><span>
</span><span id="line-271"></span><span class="annot"><a href="Language.LSP.VFS.html#changeFromServerVFS"><span class="hs-identifier hs-type">changeFromServerVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679210722"><span class="annot"><a href="#local-6989586621679210722"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210722"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210722"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_WorkspaceApplyEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210722"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span id="changeFromServerVFS"><span class="annot"><span class="annottext">changeFromServerVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage @'ServerToClient @'Request 'Method_WorkspaceApplyEdit
-&gt; m ()
</span><a href="Language.LSP.VFS.html#changeFromServerVFS"><span class="hs-identifier hs-var hs-var">changeFromServerVFS</span></a></span></span><span> </span><span id="local-6989586621679209958"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209958"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679209957"><span class="annot"><span class="annottext">TMessage @'ServerToClient @'Request 'Method_WorkspaceApplyEdit
</span><a href="#local-6989586621679209957"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.ApplyWorkspaceEditParams</span></span><span> </span><span id="local-6989586621679209950"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679209950"><span class="hs-identifier hs-var">_label</span></a></span></span><span> </span><span id="local-6989586621679209949"><span class="annot"><span class="annottext">WorkspaceEdit
</span><a href="#local-6989586621679209949"><span class="hs-identifier hs-var">edit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage @'ServerToClient @'Request 'Method_WorkspaceApplyEdit
</span><a href="#local-6989586621679209957"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasParams s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.params</span></span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">J.WorkspaceEdit</span></span><span> </span><span id="local-6989586621679209947"><span class="annot"><span class="annottext">Maybe (Map Uri [TextEdit])
</span><a href="#local-6989586621679209947"><span class="hs-identifier hs-var">mChanges</span></a></span></span><span> </span><span id="local-6989586621679209946"><span class="annot"><span class="annottext">Maybe [DocumentChange]
</span><a href="#local-6989586621679209946"><span class="hs-identifier hs-var">mDocChanges</span></a></span></span><span> </span><span id="local-6989586621679209945"><span class="annot"><span class="annottext">Maybe (Map ChangeAnnotationIdentifier ChangeAnnotation)
</span><a href="#local-6989586621679209945"><span class="hs-identifier hs-var">_anns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkspaceEdit
</span><a href="#local-6989586621679209949"><span class="hs-identifier hs-var">edit</span></a></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [DocumentChange]
</span><a href="#local-6989586621679209946"><span class="hs-identifier hs-var">mDocChanges</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679209944"><span class="annot"><span class="annottext">[DocumentChange]
</span><a href="#local-6989586621679209944"><span class="hs-identifier hs-var">docChanges</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DocumentChange] -&gt; m ()
</span><a href="#local-6989586621679209943"><span class="hs-identifier hs-var">applyDocumentChanges</span></a></span><span> </span><span class="annot"><span class="annottext">[DocumentChange]
</span><a href="#local-6989586621679209944"><span class="hs-identifier hs-var">docChanges</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">Maybe [DocumentChange]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Map Uri [TextEdit])
</span><a href="#local-6989586621679209947"><span class="hs-identifier hs-var">mChanges</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679209942"><span class="annot"><span class="annottext">Map Uri [TextEdit]
</span><a href="#local-6989586621679209942"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DocumentChange] -&gt; m ()
</span><a href="#local-6989586621679209943"><span class="hs-identifier hs-var">applyDocumentChanges</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a k b. (a -&gt; k -&gt; b -&gt; a) -&gt; a -&gt; Map k b -&gt; a
</span><span class="hs-identifier hs-var">Map.foldlWithKey'</span></span><span> </span><span class="annot"><span class="annottext">[TextDocumentEdit] -&gt; Uri -&gt; [TextEdit] -&gt; [TextDocumentEdit]
</span><a href="#local-6989586621679209940"><span class="hs-identifier hs-var">changeToTextDocumentEdit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Map Uri [TextEdit]
</span><a href="#local-6989586621679209942"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Map Uri [TextEdit])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-282"></span><span>    </span><span id="local-6989586621679209940"><span class="annot"><span class="annottext">changeToTextDocumentEdit :: [TextDocumentEdit] -&gt; Uri -&gt; [TextEdit] -&gt; [TextDocumentEdit]
</span><a href="#local-6989586621679209940"><span class="hs-identifier hs-var hs-var">changeToTextDocumentEdit</span></a></span></span><span> </span><span id="local-6989586621679209936"><span class="annot"><span class="annottext">[TextDocumentEdit]
</span><a href="#local-6989586621679209936"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679209935"><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679209935"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span id="local-6989586621679209934"><span class="annot"><span class="annottext">[TextEdit]
</span><a href="#local-6989586621679209934"><span class="hs-identifier hs-var">edits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-283"></span><span>      </span><span class="annot"><span class="annottext">[TextDocumentEdit]
</span><a href="#local-6989586621679209936"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
-&gt; [TextEdit |? AnnotatedTextEdit] -&gt; TextDocumentEdit
</span><span class="hs-identifier hs-var">J.TextDocumentEdit</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; (Int32 |? Null) -&gt; OptionalVersionedTextDocumentIdentifier
</span><span class="hs-identifier hs-var">J.OptionalVersionedTextDocumentIdentifier</span></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679209935"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">[TextEdit]
</span><a href="#local-6989586621679209934"><span class="hs-identifier hs-var">edits</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><a href="#local-6989586621679209943"><span class="hs-identifier hs-type">applyDocumentChanges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">J.DocumentChange</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210722"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621679209943"><span class="annot"><span class="annottext">applyDocumentChanges :: [DocumentChange] -&gt; m ()
</span><a href="#local-6989586621679209943"><span class="hs-identifier hs-var hs-var">applyDocumentChanges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DocumentChange -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209958"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">DocumentChange -&gt; Maybe Int32
</span><a href="#local-6989586621679209932"><span class="hs-identifier hs-var">project</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-comment">-- for sorting [DocumentChange]</span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><a href="#local-6989586621679209932"><span class="hs-identifier hs-type">project</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DocumentChange</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Int32</span></span><span>
</span><span id="line-290"></span><span>    </span><span id="local-6989586621679209932"><span class="annot"><span class="annottext">project :: DocumentChange -&gt; Maybe Int32
</span><a href="#local-6989586621679209932"><span class="hs-identifier hs-var hs-var">project</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679209931"><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679209931"><span class="hs-identifier hs-var">textDocumentEdit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679209931"><span class="hs-identifier hs-var">textDocumentEdit</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasTextDocument s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.textDocument</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasVersion s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.version</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679209930"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679209930"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679209930"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-292"></span><span>      </span><span class="annot"><span class="annottext">Int32 |? Null
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><a href="#local-6989586621679209932"><span class="hs-identifier hs-var">project</span></a></span><span> </span><span class="annot"><span class="annottext">DocumentChange
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-296"></span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileName"><span class="hs-identifier hs-type">virtualFileName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-297"></span><span id="virtualFileName"><span class="annot"><span class="annottext">virtualFileName :: [Char] -&gt; NormalizedUri -&gt; VirtualFile -&gt; [Char]
</span><a href="Language.LSP.VFS.html#virtualFileName"><span class="hs-identifier hs-var hs-var">virtualFileName</span></a></span></span><span> </span><span id="local-6989586621679209928"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209928"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621679209927"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209927"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679209926"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679209926"><span class="hs-identifier hs-var">file_ver</span></a></span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209925"><span class="annot"><span class="annottext">uri_raw :: Uri
</span><a href="#local-6989586621679209925"><span class="hs-identifier hs-var hs-var">uri_raw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Uri
</span><span class="hs-identifier hs-var">J.fromNormalizedUri</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209927"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-299"></span><span>      </span><span id="local-6989586621679209921"><span class="annot"><span class="annottext">basename :: [Char]
</span><a href="#local-6989586621679209921"><span class="hs-identifier hs-var hs-var">basename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><span class="hs-identifier hs-var">takeFileName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; Maybe [Char]
</span><span class="hs-identifier hs-var">J.uriToFilePath</span></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679209925"><span class="hs-identifier hs-var">uri_raw</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>      </span><span class="hs-comment">-- Given a length and a version number, pad the version number to</span><span>
</span><span id="line-301"></span><span>      </span><span class="hs-comment">-- the given n. Does nothing if the version number string is longer</span><span>
</span><span id="line-302"></span><span>      </span><span class="hs-comment">-- than the given length.</span><span>
</span><span id="line-303"></span><span>      </span><span class="annot"><a href="#local-6989586621679209917"><span class="hs-identifier hs-type">padLeft</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-304"></span><span>      </span><span id="local-6989586621679209917"><span class="annot"><span class="annottext">padLeft :: Int -&gt; Int -&gt; [Char]
</span><a href="#local-6989586621679209917"><span class="hs-identifier hs-var hs-var">padLeft</span></a></span></span><span> </span><span id="local-6989586621679209916"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679209916"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679209915"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679209915"><span class="hs-identifier hs-var">num</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209913"><span class="annot"><span class="annottext">numString :: [Char]
</span><a href="#local-6989586621679209913"><span class="hs-identifier hs-var hs-var">numString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679209915"><span class="hs-identifier hs-var">num</span></a></span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679209916"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209913"><span class="hs-identifier hs-var">numString</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'0'</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209913"><span class="hs-identifier hs-var">numString</span></a></span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209928"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209921"><span class="hs-identifier hs-var">basename</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [Char]
</span><a href="#local-6989586621679209917"><span class="hs-identifier hs-var">padLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679209926"><span class="hs-identifier hs-var">file_ver</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">hash</span></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679209925"><span class="hs-identifier hs-var">uri_raw</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><span class="hs-identifier hs-var">takeExtensions</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209921"><span class="hs-identifier hs-var">basename</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">-- | Write a virtual file to a temporary file if it exists in the VFS.</span><span>
</span><span id="line-310"></span><span id="local-6989586621679210695"><span class="annot"><a href="Language.LSP.VFS.html#persistFileVFS"><span class="hs-identifier hs-type">persistFileVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679210695"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-311"></span><span id="persistFileVFS"><span class="annot"><span class="annottext">persistFileVFS :: forall (m :: * -&gt; *).
MonadIO m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; VFS -&gt; NormalizedUri -&gt; Maybe ([Char], m ())
</span><a href="Language.LSP.VFS.html#persistFileVFS"><span class="hs-identifier hs-var hs-var">persistFileVFS</span></a></span></span><span> </span><span id="local-6989586621679209896"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209896"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679209895"><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679209895"><span class="hs-identifier hs-var">vfs</span></a></span></span><span> </span><span id="local-6989586621679209894"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209894"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679209895"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209894"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">Maybe VirtualFile
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679209893"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209893"><span class="hs-identifier hs-var">vf</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209890"><span class="annot"><span class="annottext">tfn :: [Char]
</span><a href="#local-6989586621679209890"><span class="hs-identifier hs-var hs-var">tfn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; NormalizedUri -&gt; VirtualFile -&gt; [Char]
</span><a href="Language.LSP.VFS.html#virtualFileName"><span class="hs-identifier hs-var">virtualFileName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679209895"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasVfsTempDir s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsTempDir"><span class="hs-identifier hs-var">vfsTempDir</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209894"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209893"><span class="hs-identifier hs-var">vf</span></a></span><span>
</span><span id="line-316"></span><span>          </span><span id="local-6989586621679209884"><span class="annot"><span class="annottext">action :: m ()
</span><a href="#local-6989586621679209884"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>            </span><span id="local-6989586621679209883"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679209883"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO Bool
</span><span class="hs-identifier hs-var">doesFileExist</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209890"><span class="hs-identifier hs-var">tfn</span></a></span><span>
</span><span id="line-318"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679209883"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>               </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209879"><span class="annot"><span class="annottext">contents :: Text
</span><a href="#local-6989586621679209879"><span class="hs-identifier hs-var hs-var">contents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209893"><span class="hs-identifier hs-var">vf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>                   </span><span id="local-6989586621679209875"><span class="annot"><span class="annottext">writeRaw :: Handle -&gt; IO ()
</span><a href="#local-6989586621679209875"><span class="hs-identifier hs-var hs-var">writeRaw</span></a></span></span><span> </span><span id="local-6989586621679209874"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679209874"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-321"></span><span>                    </span><span class="hs-comment">-- We honour original file line endings</span><span>
</span><span id="line-322"></span><span>                    </span><span class="annot"><span class="annottext">Handle -&gt; NewlineMode -&gt; IO ()
</span><span class="hs-identifier hs-var">hSetNewlineMode</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679209874"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">NewlineMode
</span><span class="hs-identifier hs-var">noNewlineTranslation</span></span><span>
</span><span id="line-323"></span><span>                    </span><span class="annot"><span class="annottext">Handle -&gt; TextEncoding -&gt; IO ()
</span><span class="hs-identifier hs-var">hSetEncoding</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679209874"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TextEncoding
</span><span class="hs-identifier hs-var">utf8</span></span><span>
</span><span id="line-324"></span><span>                    </span><span class="annot"><span class="annottext">Handle -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">T.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679209874"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209879"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-325"></span><span>               </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209896"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; [Char] -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#PersistingFile"><span class="hs-identifier hs-var">PersistingFile</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209894"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209890"><span class="hs-identifier hs-var">tfn</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Debug</span></span><span>
</span><span id="line-326"></span><span>               </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall r. [Char] -&gt; IOMode -&gt; (Handle -&gt; IO r) -&gt; IO r
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209890"><span class="hs-identifier hs-var">tfn</span></a></span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">WriteMode</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><a href="#local-6989586621679209875"><span class="hs-identifier hs-var">writeRaw</span></a></span><span>
</span><span id="line-327"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679209890"><span class="hs-identifier hs-var">tfn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679209884"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span id="local-6989586621679210686"><span class="annot"><a href="Language.LSP.VFS.html#closeVFS"><span class="hs-identifier hs-type">closeVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210686"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210686"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_TextDocumentDidClose</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210686"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-332"></span><span id="closeVFS"><span class="annot"><span class="annottext">closeVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidClose
-&gt; m ()
</span><a href="Language.LSP.VFS.html#closeVFS"><span class="hs-identifier hs-var hs-var">closeVFS</span></a></span></span><span> </span><span id="local-6989586621679209857"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209857"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679209856"><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidClose
</span><a href="#local-6989586621679209856"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DidCloseTextDocumentParams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentIdentifier</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679209849"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209849"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidClose
</span><a href="#local-6989586621679209856"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall s a. HasParams s a =&gt; Lens' s a
</span><span class="hs-identifier hs-var">J.params</span></span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209857"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209849"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Debug</span></span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><span class="annottext">forall s a. HasVfsMap s a =&gt; Lens' s a
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679209849"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span class="hs-comment">-- | Apply the list of changes.</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- Changes should be applied in the order that they are</span><span>
</span><span id="line-341"></span><span class="hs-comment">-- received from the client.</span><span>
</span><span id="line-342"></span><span id="local-6989586621679210845"><span class="annot"><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier hs-type">applyChanges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679210845"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210845"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210845"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span></span><span>
</span><span id="line-343"></span><span id="applyChanges"><span class="annot"><span class="annottext">applyChanges :: forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; [TextDocumentContentChangeEvent] -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier hs-var hs-var">applyChanges</span></a></span></span><span> </span><span id="local-6989586621679209844"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209844"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; TextDocumentContentChangeEvent -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-var">applyChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209844"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span id="local-6989586621679210676"><span class="annot"><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-type">applyChange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679210676"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210676"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210676"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span></span><span>
</span><span id="line-348"></span><span id="applyChange"><span class="annot"><span class="annottext">applyChange :: forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; TextDocumentContentChangeEvent -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-var hs-var">applyChange</span></a></span></span><span> </span><span id="local-6989586621679209821"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209821"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679209820"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209820"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679209819"><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
</span><a href="#local-6989586621679209819"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679209816"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209816"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621679209815"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209815"><span class="hs-identifier hs-var">sc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679209814"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209814"><span class="hs-identifier hs-var">fl</span></a></span></span><span> </span><span id="local-6989586621679209813"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209813"><span class="hs-identifier hs-var">fc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
</span><a href="#local-6989586621679209819"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; (.!) @(*) r l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;range&quot; a =&gt; a
</span><span class="">#range</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209811"><span class="annot"><span class="annottext">(.!)
  @(*)
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
  &quot;text&quot;
</span><a href="#local-6989586621679209811"><span class="hs-identifier hs-var">txt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
</span><a href="#local-6989586621679209819"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; (.!) @(*) r l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;text&quot; a =&gt; a
</span><span class="">#text</span></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; Position -&gt; Position -&gt; Text -&gt; m Rope
</span><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier hs-var">changeChars</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209821"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209820"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Position
</span><span class="hs-identifier hs-var">Rope.Position</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209816"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209815"><span class="hs-identifier hs-var">sc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Position
</span><span class="hs-identifier hs-var">Rope.Position</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209814"><span class="hs-identifier hs-var">fl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209813"><span class="hs-identifier hs-var">fc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(.!)
  @(*)
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
  &quot;text&quot;
</span><a href="#local-6989586621679209811"><span class="hs-identifier hs-var">txt</span></a></span><span>
</span><span id="line-350"></span><span class="annot"><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-var">applyChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679209809"><span class="annot"><span class="annottext">Rec ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
</span><a href="#local-6989586621679209809"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
</span><a href="#local-6989586621679209809"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; (.!) @(*) r l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;text&quot; a =&gt; a
</span><span class="">#text</span></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span class="hs-comment">-- | Given a 'Rope', start and end positions, and some new text, replace</span><span>
</span><span id="line-356"></span><span class="hs-comment">-- the given range with the new text. If the given positions lie within</span><span>
</span><span id="line-357"></span><span class="hs-comment">-- a code point then this does nothing (returns the original 'Rope') and logs.</span><span>
</span><span id="line-358"></span><span id="local-6989586621679210670"><span class="annot"><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier hs-type">changeChars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679210670"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679210670"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210670"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span></span><span>
</span><span id="line-359"></span><span id="changeChars"><span class="annot"><span class="annottext">changeChars :: forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; Position -&gt; Position -&gt; Text -&gt; m Rope
</span><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier hs-var hs-var">changeChars</span></a></span></span><span> </span><span id="local-6989586621679209800"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209800"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679209799"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209799"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span id="local-6989586621679209798"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209798"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679209797"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209797"><span class="hs-identifier hs-var">finish</span></a></span></span><span> </span><span id="local-6989586621679209796"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209796"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtPosition</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209797"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209799"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-361"></span><span>   </span><span class="annot"><span class="annottext">Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209800"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-var">SplitInsideCodePoint</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209797"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209799"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209799"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-362"></span><span>   </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209794"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209794"><span class="hs-identifier hs-var">before</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209793"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209793"><span class="hs-identifier hs-var">after</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtPosition</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209798"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209794"><span class="hs-identifier hs-var">before</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-363"></span><span>     </span><span class="annot"><span class="annottext">Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679209800"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-var">SplitInsideCodePoint</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209798"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209794"><span class="hs-identifier hs-var">before</span></a></span><span> </span><span class="annot"><span class="annottext">forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209799"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-364"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209792"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209792"><span class="hs-identifier hs-var">before'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209792"><span class="hs-identifier hs-var">before'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209796"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209793"><span class="hs-identifier hs-var">after</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="hs-comment">-- | A position, like a 'J.Position', but where the offsets in the line are measured in</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- Unicode code points instead of UTF-16 code units.</span><span>
</span><span id="line-370"></span><span class="hs-keyword">data</span><span> </span><span id="CodePointPosition"><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-var">CodePointPosition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-371"></span><span>  </span><span id="CodePointPosition"><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-var">CodePointPosition</span></a></span></span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Line position in a document (zero-based).</span><span>
</span><span id="line-373"></span><span>      </span><span id="%24sel%3A_line%3ACodePointPosition"><span class="annot"><span class="annottext">CodePointPosition -&gt; UInt
</span><a href="Language.LSP.VFS.html#%24sel%3A_line%3ACodePointPosition"><span class="hs-identifier hs-var hs-var">_line</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.UInt</span></span><span>
</span><span id="line-374"></span><span>      </span><span class="hs-comment">-- | Character offset on a line in a document in *code points* (zero-based).</span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_character%3ACodePointPosition"><span class="annot"><span class="annottext">CodePointPosition -&gt; UInt
</span><a href="Language.LSP.VFS.html#%24sel%3A_character%3ACodePointPosition"><span class="hs-identifier hs-var hs-var">_character</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.UInt</span></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209779"><span id="local-6989586621679209781"><span id="local-6989586621679209787"><span class="annot"><span class="annottext">Int -&gt; CodePointPosition -&gt; ShowS
[CodePointPosition] -&gt; ShowS
CodePointPosition -&gt; [Char]
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CodePointPosition] -&gt; ShowS
$cshowList :: [CodePointPosition] -&gt; ShowS
show :: CodePointPosition -&gt; [Char]
$cshow :: CodePointPosition -&gt; [Char]
showsPrec :: Int -&gt; CodePointPosition -&gt; ShowS
$cshowsPrec :: Int -&gt; CodePointPosition -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209759"><span id="local-6989586621679209772"><span id="local-6989586621679209775"><span id="local-6989586621679209777"><span class="annot"><span class="annottext">ReadPrec [CodePointPosition]
ReadPrec CodePointPosition
Int -&gt; ReadS CodePointPosition
ReadS [CodePointPosition]
forall a.
(Int -&gt; ReadS a)
-&gt; ReadS [a] -&gt; ReadPrec a -&gt; ReadPrec [a] -&gt; Read a
readListPrec :: ReadPrec [CodePointPosition]
$creadListPrec :: ReadPrec [CodePointPosition]
readPrec :: ReadPrec CodePointPosition
$creadPrec :: ReadPrec CodePointPosition
readList :: ReadS [CodePointPosition]
$creadList :: ReadS [CodePointPosition]
readsPrec :: Int -&gt; ReadS CodePointPosition
$creadsPrec :: Int -&gt; ReadS CodePointPosition
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Read</span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209750"><span id="local-6989586621679209755"><span class="annot"><span class="annottext">CodePointPosition -&gt; CodePointPosition -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c/= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
== :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c== :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209725"><span id="local-6989586621679209727"><span id="local-6989586621679209730"><span id="local-6989586621679209733"><span id="local-6989586621679209736"><span id="local-6989586621679209740"><span id="local-6989586621679209745"><span class="annot"><span class="annottext">Eq CodePointPosition
CodePointPosition -&gt; CodePointPosition -&gt; Bool
CodePointPosition -&gt; CodePointPosition -&gt; Ordering
CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
$cmin :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
max :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
$cmax :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
&gt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c&gt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
&gt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c&gt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
&lt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c&lt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
&lt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c&lt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
compare :: CodePointPosition -&gt; CodePointPosition -&gt; Ordering
$ccompare :: CodePointPosition -&gt; CodePointPosition -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="hs-comment">-- | A range, like a 'J.Range', but where the offsets in the line are measured in</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- Unicode code points instead of UTF-16 code units.</span><span>
</span><span id="line-380"></span><span class="hs-keyword">data</span><span> </span><span id="CodePointRange"><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-var">CodePointRange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-381"></span><span>  </span><span id="CodePointRange"><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-var">CodePointRange</span></a></span></span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3A_start%3ACodePointRange"><span class="annot"><span class="annottext">CodePointRange -&gt; CodePointPosition
</span><a href="Language.LSP.VFS.html#%24sel%3A_start%3ACodePointRange"><span class="hs-identifier hs-var hs-var">_start</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span> </span><span class="hs-comment">-- ^ The range's start position.</span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_end%3ACodePointRange"><span class="annot"><span class="annottext">CodePointRange -&gt; CodePointPosition
</span><a href="Language.LSP.VFS.html#%24sel%3A_end%3ACodePointRange"><span class="hs-identifier hs-var hs-var">_end</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span> </span><span class="hs-comment">-- ^ The range's end position.</span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209712"><span id="local-6989586621679209714"><span id="local-6989586621679209719"><span class="annot"><span class="annottext">Int -&gt; CodePointRange -&gt; ShowS
[CodePointRange] -&gt; ShowS
CodePointRange -&gt; [Char]
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CodePointRange] -&gt; ShowS
$cshowList :: [CodePointRange] -&gt; ShowS
show :: CodePointRange -&gt; [Char]
$cshow :: CodePointRange -&gt; [Char]
showsPrec :: Int -&gt; CodePointRange -&gt; ShowS
$cshowsPrec :: Int -&gt; CodePointRange -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209694"><span id="local-6989586621679209705"><span id="local-6989586621679209708"><span id="local-6989586621679209710"><span class="annot"><span class="annottext">ReadPrec [CodePointRange]
ReadPrec CodePointRange
Int -&gt; ReadS CodePointRange
ReadS [CodePointRange]
forall a.
(Int -&gt; ReadS a)
-&gt; ReadS [a] -&gt; ReadPrec a -&gt; ReadPrec [a] -&gt; Read a
readListPrec :: ReadPrec [CodePointRange]
$creadListPrec :: ReadPrec [CodePointRange]
readPrec :: ReadPrec CodePointRange
$creadPrec :: ReadPrec CodePointRange
readList :: ReadS [CodePointRange]
$creadList :: ReadS [CodePointRange]
readsPrec :: Int -&gt; ReadS CodePointRange
$creadsPrec :: Int -&gt; ReadS CodePointRange
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Read</span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209687"><span id="local-6989586621679209691"><span class="annot"><span class="annottext">CodePointRange -&gt; CodePointRange -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c/= :: CodePointRange -&gt; CodePointRange -&gt; Bool
== :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c== :: CodePointRange -&gt; CodePointRange -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209664"><span id="local-6989586621679209666"><span id="local-6989586621679209669"><span id="local-6989586621679209672"><span id="local-6989586621679209675"><span id="local-6989586621679209679"><span id="local-6989586621679209683"><span class="annot"><span class="annottext">Eq CodePointRange
CodePointRange -&gt; CodePointRange -&gt; Bool
CodePointRange -&gt; CodePointRange -&gt; Ordering
CodePointRange -&gt; CodePointRange -&gt; CodePointRange
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
$cmin :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
max :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
$cmax :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
&gt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c&gt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
&gt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c&gt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
&lt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c&lt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
&lt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c&lt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
compare :: CodePointRange -&gt; CodePointRange -&gt; Ordering
$ccompare :: CodePointRange -&gt; CodePointRange -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span id="local-6989586621679209658"><span id="local-6989586621679209662"><span id="character"><span id="line"><span id="HasCharacter"><span id="local-6989586621679210656"><span id="local-6989586621679210657"><span id="HasLine"><span id="local-6989586621679210659"><span id="local-6989586621679210660"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">CodePointPosition</span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-387"></span><span id="local-6989586621679209638"><span id="local-6989586621679209642"><span id="end"><span id="start"><span id="HasEnd"><span id="local-6989586621679210648"><span id="local-6989586621679210649"><span id="HasStart"><span id="local-6989586621679210651"><span id="local-6989586621679210652"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">CodePointRange</span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="hs-comment">{- Note [Converting between code points and code units]
This is inherently a somewhat expensive operation, but we take some care to minimize the cost.
In particular, we use the good asymptotics of 'Rope' to our advantage:
- We extract the single line that we are interested in in time logarithmic in the number of lines.
- We then split the line at the given position, and check how long the prefix is, which takes
linear time in the length of the (single) line.

We also may need to convert the line back and forth between ropes with different indexing. Again
this is linear time in the length of the line.

So the overall process is logarithmic in the number of lines, and linear in the length of the specific
line. Which is okay-ish, so long as we don't have very long lines.
-}</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span class="hs-comment">-- | Extracts a specific line from a 'Rope.Rope'.</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- Logarithmic in the number of lines.</span><span>
</span><span id="line-405"></span><span class="annot"><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-type">extractLine</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Rope</span></span><span>
</span><span id="line-406"></span><span id="extractLine"><span class="annot"><span class="annottext">extractLine :: Rope -&gt; Word -&gt; Maybe Rope
</span><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-var hs-var">extractLine</span></a></span></span><span> </span><span id="local-6989586621679209622"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209622"><span class="hs-identifier hs-var">rope</span></a></span></span><span> </span><span id="local-6989586621679209621"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209621"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-comment">-- Check for the line being out of bounds</span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209620"><span class="annot"><span class="annottext">lastLine :: Word
</span><a href="#local-6989586621679209620"><span class="hs-identifier hs-var hs-var">lastLine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Word
</span><span class="hs-identifier hs-var">Rope.posLine</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Position
</span><span class="hs-identifier hs-var">Rope.lengthAsPosition</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209622"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209621"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209620"><span class="hs-identifier hs-var">lastLine</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209616"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209616"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209621"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209622"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-412"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679209614"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209614"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209616"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-413"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209614"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span class="hs-comment">-- | Translate a code-point offset into a code-unit offset.</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- Linear in the length of the rope.</span><span>
</span><span id="line-417"></span><span class="annot"><a href="Language.LSP.VFS.html#codePointOffsetToCodeUnitOffset"><span class="hs-identifier hs-type">codePointOffsetToCodeUnitOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">URope.Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-418"></span><span id="codePointOffsetToCodeUnitOffset"><span class="annot"><span class="annottext">codePointOffsetToCodeUnitOffset :: Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codePointOffsetToCodeUnitOffset"><span class="hs-identifier hs-var hs-var">codePointOffsetToCodeUnitOffset</span></a></span></span><span> </span><span id="local-6989586621679209612"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209612"><span class="hs-identifier hs-var">rope</span></a></span></span><span> </span><span id="local-6989586621679209611"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209611"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-comment">-- Check for the position being out of bounds</span><span>
</span><span id="line-420"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209611"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">URope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209612"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-comment">-- Split at the given position in *code points*</span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209609"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209609"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">URope.splitAt</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209611"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209612"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-423"></span><span>      </span><span class="hs-comment">-- Convert the prefix to a rope using *code units*</span><span>
</span><span id="line-424"></span><span>      </span><span id="local-6989586621679209607"><span class="annot"><span class="annottext">utf16Prefix :: Rope
</span><a href="#local-6989586621679209607"><span class="hs-identifier hs-var hs-var">utf16Prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">URope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209609"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-425"></span><span>      </span><span class="hs-comment">-- Get the length of the prefix in *code units*</span><span>
</span><span id="line-426"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">Rope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209607"><span class="hs-identifier hs-var">utf16Prefix</span></a></span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="hs-comment">-- | Translate a UTF-16 code-unit offset into a code-point offset.</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- Linear in the length of the rope.</span><span>
</span><span id="line-430"></span><span class="annot"><a href="Language.LSP.VFS.html#codeUnitOffsetToCodePointOffset"><span class="hs-identifier hs-type">codeUnitOffsetToCodePointOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-431"></span><span id="codeUnitOffsetToCodePointOffset"><span class="annot"><span class="annottext">codeUnitOffsetToCodePointOffset :: Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codeUnitOffsetToCodePointOffset"><span class="hs-identifier hs-var hs-var">codeUnitOffsetToCodePointOffset</span></a></span></span><span> </span><span id="local-6989586621679209603"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209603"><span class="hs-identifier hs-var">rope</span></a></span></span><span> </span><span id="local-6989586621679209602"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209602"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-comment">-- Check for the position being out of bounds</span><span>
</span><span id="line-433"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209602"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">Rope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209603"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-comment">-- Split at the given position in *code units*</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679209601"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209601"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAt</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209602"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209603"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-comment">-- Convert the prefix to a rope using *code points*</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209599"><span class="annot"><span class="annottext">utfPrefix :: Rope
</span><a href="#local-6989586621679209599"><span class="hs-identifier hs-var hs-var">utfPrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">URope.fromText</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209601"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-comment">-- Get the length of the prefix in *code points*</span><span>
</span><span id="line-439"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">URope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209599"><span class="hs-identifier hs-var">utfPrefix</span></a></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="hs-comment">-- | Given a virtual file, translate a 'CodePointPosition' in that file into a 'J.Position' in that file.</span><span>
</span><span id="line-442"></span><span class="hs-comment">--</span><span>
</span><span id="line-443"></span><span class="hs-comment">-- Will return 'Nothing' if the requested position is out of bounds of the document.</span><span>
</span><span id="line-444"></span><span class="hs-comment">--</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- Logarithmic in the number of lines in the document, and linear in the length of the line containing</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- the position.</span><span>
</span><span id="line-447"></span><span class="annot"><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-type">codePointPositionToPosition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span>
</span><span id="line-448"></span><span id="codePointPositionToPosition"><span class="annot"><span class="annottext">codePointPositionToPosition :: VirtualFile -&gt; CodePointPosition -&gt; Maybe Position
</span><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-var hs-var">codePointPositionToPosition</span></a></span></span><span> </span><span id="local-6989586621679209597"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209597"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span> </span><span id="local-6989586621679209596"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209596"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679209595"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209595"><span class="hs-identifier hs-var">cpc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-comment">-- See Note [Converting between code points and code units]</span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209594"><span class="annot"><span class="annottext">text :: Rope
</span><a href="#local-6989586621679209594"><span class="hs-identifier hs-var hs-var">text</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209597"><span class="hs-identifier hs-var">vFile</span></a></span><span>
</span><span id="line-451"></span><span>  </span><span id="local-6989586621679209593"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209593"><span class="hs-identifier hs-var">utf16Line</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Rope
</span><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-var">extractLine</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209594"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209596"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-comment">-- Convert the line a rope using *code points*</span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209592"><span class="annot"><span class="annottext">utfLine :: Rope
</span><a href="#local-6989586621679209592"><span class="hs-identifier hs-var hs-var">utfLine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">URope.fromText</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209593"><span class="hs-identifier hs-var">utf16Line</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span>  </span><span id="local-6989586621679209591"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209591"><span class="hs-identifier hs-var">cuc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codePointOffsetToCodeUnitOffset"><span class="hs-identifier hs-var">codePointOffsetToCodeUnitOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209592"><span class="hs-identifier hs-var">utfLine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209595"><span class="hs-identifier hs-var">cpc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">J.Position</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209596"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209591"><span class="hs-identifier hs-var">cuc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span class="hs-comment">-- | Given a virtual file, translate a 'CodePointRange' in that file into a 'J.Range' in that file.</span><span>
</span><span id="line-459"></span><span class="hs-comment">--</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- Will return 'Nothing' if any of the positions are out of bounds of the document.</span><span>
</span><span id="line-461"></span><span class="hs-comment">--</span><span>
</span><span id="line-462"></span><span class="hs-comment">-- Logarithmic in the number of lines in the document, and linear in the length of the lines containing</span><span>
</span><span id="line-463"></span><span class="hs-comment">-- the positions.</span><span>
</span><span id="line-464"></span><span class="annot"><a href="Language.LSP.VFS.html#codePointRangeToRange"><span class="hs-identifier hs-type">codePointRangeToRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-type">CodePointRange</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span>
</span><span id="line-465"></span><span id="codePointRangeToRange"><span class="annot"><span class="annottext">codePointRangeToRange :: VirtualFile -&gt; CodePointRange -&gt; Maybe Range
</span><a href="Language.LSP.VFS.html#codePointRangeToRange"><span class="hs-identifier hs-var hs-var">codePointRangeToRange</span></a></span></span><span> </span><span id="local-6989586621679209590"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209590"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-type">CodePointRange</span></a></span><span> </span><span id="local-6989586621679209589"><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679209589"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679209588"><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679209588"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-466"></span><span>  </span><span class="annot"><span class="annottext">Position -&gt; Position -&gt; Range
</span><span class="hs-identifier hs-var">J.Range</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; CodePointPosition -&gt; Maybe Position
</span><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-var">codePointPositionToPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209590"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679209589"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; CodePointPosition -&gt; Maybe Position
</span><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-var">codePointPositionToPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209590"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679209588"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="hs-comment">-- | Given a virtual file, translate a 'J.Position' in that file into a 'CodePointPosition' in that file.</span><span>
</span><span id="line-469"></span><span class="hs-comment">--</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- Will return 'Nothing' if the requested position lies inside a code point, or if it is out of bounds of the document.</span><span>
</span><span id="line-471"></span><span class="hs-comment">--</span><span>
</span><span id="line-472"></span><span class="hs-comment">-- Logarithmic in the number of lines in the document, and linear in the length of the line containing</span><span>
</span><span id="line-473"></span><span class="hs-comment">-- the position.</span><span>
</span><span id="line-474"></span><span class="annot"><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-type">positionToCodePointPosition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span>
</span><span id="line-475"></span><span id="positionToCodePointPosition"><span class="annot"><span class="annottext">positionToCodePointPosition :: VirtualFile -&gt; Position -&gt; Maybe CodePointPosition
</span><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-var hs-var">positionToCodePointPosition</span></a></span></span><span> </span><span id="local-6989586621679209586"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209586"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679209585"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209585"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679209584"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209584"><span class="hs-identifier hs-var">cuc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-comment">-- See Note [Converting between code points and code units]</span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209583"><span class="annot"><span class="annottext">text :: Rope
</span><a href="#local-6989586621679209583"><span class="hs-identifier hs-var hs-var">text</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209586"><span class="hs-identifier hs-var">vFile</span></a></span><span>
</span><span id="line-478"></span><span>  </span><span id="local-6989586621679209582"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209582"><span class="hs-identifier hs-var">utf16Line</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Rope
</span><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-var">extractLine</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209583"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209585"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>  </span><span id="local-6989586621679209581"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209581"><span class="hs-identifier hs-var">cpc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codeUnitOffsetToCodePointOffset"><span class="hs-identifier hs-var">codeUnitOffsetToCodePointOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209582"><span class="hs-identifier hs-var">utf16Line</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209584"><span class="hs-identifier hs-var">cuc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; CodePointPosition
</span><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-var">CodePointPosition</span></a></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209585"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679209581"><span class="hs-identifier hs-var">cpc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span class="hs-comment">-- | Given a virtual file, translate a 'J.Range' in that file into a 'CodePointRange' in that file.</span><span>
</span><span id="line-484"></span><span class="hs-comment">--</span><span>
</span><span id="line-485"></span><span class="hs-comment">-- Will return 'Nothing' if any of the positions are out of bounds of the document.</span><span>
</span><span id="line-486"></span><span class="hs-comment">--</span><span>
</span><span id="line-487"></span><span class="hs-comment">-- Logarithmic in the number of lines in the document, and linear in the length of the lines containing</span><span>
</span><span id="line-488"></span><span class="hs-comment">-- the positions.</span><span>
</span><span id="line-489"></span><span class="annot"><a href="Language.LSP.VFS.html#rangeToCodePointRange"><span class="hs-identifier hs-type">rangeToCodePointRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-type">CodePointRange</span></a></span><span>
</span><span id="line-490"></span><span id="rangeToCodePointRange"><span class="annot"><span class="annottext">rangeToCodePointRange :: VirtualFile -&gt; Range -&gt; Maybe CodePointRange
</span><a href="Language.LSP.VFS.html#rangeToCodePointRange"><span class="hs-identifier hs-var hs-var">rangeToCodePointRange</span></a></span></span><span> </span><span id="local-6989586621679209580"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209580"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span id="local-6989586621679209579"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209579"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679209578"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209578"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-491"></span><span>  </span><span class="annot"><span class="annottext">CodePointPosition -&gt; CodePointPosition -&gt; CodePointRange
</span><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-var">CodePointRange</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Position -&gt; Maybe CodePointPosition
</span><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-var">positionToCodePointPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209580"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209579"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Position -&gt; Maybe CodePointPosition
</span><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-var">positionToCodePointPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679209580"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209578"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="hs-comment">-- TODO:AZ:move this to somewhere sane</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- | Describes the line at the current cursor position</span><span>
</span><span id="line-497"></span><span class="hs-keyword">data</span><span> </span><span id="PosPrefixInfo"><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PosPrefixInfo"><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span></span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AfullLine%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Text
</span><a href="Language.LSP.VFS.html#%24sel%3AfullLine%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">fullLine</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-comment">-- ^ The full contents of the line the cursor is at</span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AprefixModule%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Text
</span><a href="Language.LSP.VFS.html#%24sel%3AprefixModule%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">prefixModule</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">-- ^ If any, the module name that was typed right before the cursor position.</span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">--  For example, if the user has typed &quot;Data.Maybe.from&quot;, then this property</span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">--  will be &quot;Data.Maybe&quot;</span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AprefixText%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Text
</span><a href="Language.LSP.VFS.html#%24sel%3AprefixText%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">prefixText</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-comment">-- ^ The word right before the cursor position, after removing the module part.</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-comment">-- For example if the user has typed &quot;Data.Maybe.from&quot;,</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-comment">-- then this property will be &quot;from&quot;</span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AcursorPos%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Position
</span><a href="Language.LSP.VFS.html#%24sel%3AcursorPos%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">cursorPos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-comment">-- ^ The cursor position</span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209560"><span id="local-6989586621679209562"><span id="local-6989586621679209571"><span class="annot"><span class="annottext">Int -&gt; PosPrefixInfo -&gt; ShowS
[PosPrefixInfo] -&gt; ShowS
PosPrefixInfo -&gt; [Char]
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PosPrefixInfo] -&gt; ShowS
$cshowList :: [PosPrefixInfo] -&gt; ShowS
show :: PosPrefixInfo -&gt; [Char]
$cshow :: PosPrefixInfo -&gt; [Char]
showsPrec :: Int -&gt; PosPrefixInfo -&gt; ShowS
$cshowsPrec :: Int -&gt; PosPrefixInfo -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span id="local-6989586621679209550"><span id="local-6989586621679209558"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
$c/= :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
== :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
$c== :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span id="local-6989586621679210637"><span class="annot"><a href="Language.LSP.VFS.html#getCompletionPrefix"><span class="hs-identifier hs-type">getCompletionPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679210637"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210637"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-type">PosPrefixInfo</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-515"></span><span id="getCompletionPrefix"><span class="annot"><span class="annottext">getCompletionPrefix :: forall (m :: * -&gt; *).
Monad m =&gt;
Position -&gt; VirtualFile -&gt; m (Maybe PosPrefixInfo)
</span><a href="Language.LSP.VFS.html#getCompletionPrefix"><span class="hs-identifier hs-var hs-var">getCompletionPrefix</span></a></span></span><span> </span><span id="local-6989586621679209534"><span class="annot"><span class="annottext">pos :: Position
</span><a href="#local-6989586621679209534"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679209533"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209533"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679209532"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209532"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679209531"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209531"><span class="hs-identifier hs-var">ropetext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-516"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text -&gt; Position -&gt; PosPrefixInfo
</span><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209534"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Maybe monad</span><span>
</span><span id="line-517"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209529"><span class="annot"><span class="annottext">lastMaybe :: [a] -&gt; Maybe a
</span><a href="#local-6989586621679209529"><span class="hs-identifier hs-var hs-var">lastMaybe</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-518"></span><span>            </span><span class="annot"><a href="#local-6989586621679209529"><span class="hs-identifier hs-var">lastMaybe</span></a></span><span> </span><span id="local-6989586621679209528"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679209528"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679209528"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-519"></span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209524"><span class="annot"><span class="annottext">curRope :: Rope
</span><a href="#local-6989586621679209524"><span class="hs-identifier hs-var hs-var">curRope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209533"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209531"><span class="hs-identifier hs-var">ropetext</span></a></span><span>
</span><span id="line-521"></span><span>        </span><span id="local-6989586621679209523"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209523"><span class="hs-identifier hs-var">beforePos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209532"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209524"><span class="hs-identifier hs-var">curRope</span></a></span><span>
</span><span id="line-522"></span><span>        </span><span id="local-6989586621679209522"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209522"><span class="hs-identifier hs-var">curWord</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-523"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><span class="hs-identifier hs-var">T.null</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209523"><span class="hs-identifier hs-var">beforePos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-524"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Char
</span><span class="hs-identifier hs-var">T.last</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209523"><span class="hs-identifier hs-var">beforePos</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-comment">-- don't count abc as the curword in 'abc '</span><span>
</span><span id="line-525"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall {a}. [a] -&gt; Maybe a
</span><a href="#local-6989586621679209529"><span class="hs-identifier hs-var">lastMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; [Text]
</span><span class="hs-identifier hs-var">T.words</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209523"><span class="hs-identifier hs-var">beforePos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209515"><span class="annot"><span class="annottext">parts :: [Text]
</span><a href="#local-6989586621679209515"><span class="hs-identifier hs-var hs-var">parts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Text -&gt; [Text]
</span><span class="hs-identifier hs-var">T.split</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>                      </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Text -&gt; Text
</span><span class="hs-identifier hs-var">T.takeWhileEnd</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679209512"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679209512"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isAlphaNum</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679209512"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679209512"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;._'&quot;</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209522"><span class="hs-identifier hs-var">curWord</span></a></span><span>
</span><span id="line-529"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679209515"><span class="hs-identifier hs-var">parts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-530"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-531"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679209508"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209508"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679209507"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679209507"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-532"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209506"><span class="annot"><span class="annottext">modParts :: [Text]
</span><a href="#local-6989586621679209506"><span class="hs-identifier hs-var hs-var">modParts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">dropWhile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isUpper</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Char
</span><span class="hs-identifier hs-var">T.head</span></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>                                </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><span class="hs-identifier hs-var">T.null</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679209507"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-534"></span><span>                </span><span id="local-6989586621679209501"><span class="annot"><span class="annottext">modName :: Text
</span><a href="#local-6989586621679209501"><span class="hs-identifier hs-var hs-var">modName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679209506"><span class="hs-identifier hs-var">modParts</span></a></span><span>
</span><span id="line-535"></span><span>            </span><span class="hs-comment">-- curRope is already a single line, but it may include an enclosing '\n'</span><span>
</span><span id="line-536"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209498"><span class="annot"><span class="annottext">curLine :: Text
</span><a href="#local-6989586621679209498"><span class="hs-identifier hs-var hs-var">curLine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Text -&gt; Text
</span><span class="hs-identifier hs-var">T.dropWhileEnd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\n'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209524"><span class="hs-identifier hs-var">curRope</span></a></span><span>
</span><span id="line-537"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text -&gt; Position -&gt; PosPrefixInfo
</span><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209498"><span class="hs-identifier hs-var">curLine</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209501"><span class="hs-identifier hs-var">modName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209508"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679209534"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span class="annot"><a href="Language.LSP.VFS.html#rangeLinesFromVfs"><span class="hs-identifier hs-type">rangeLinesFromVfs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-542"></span><span id="rangeLinesFromVfs"><span class="annot"><span class="annottext">rangeLinesFromVfs :: VirtualFile -&gt; Range -&gt; Text
</span><a href="Language.LSP.VFS.html#rangeLinesFromVfs"><span class="hs-identifier hs-var hs-var">rangeLinesFromVfs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679209496"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209496"><span class="hs-identifier hs-var">ropetext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679209495"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209495"><span class="hs-identifier hs-var">lf</span></a></span></span><span> </span><span id="local-6989586621679209494"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209494"><span class="hs-identifier hs-var">_cf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679209493"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209493"><span class="hs-identifier hs-var">lt</span></a></span></span><span> </span><span id="local-6989586621679209492"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209492"><span class="hs-identifier hs-var">_ct</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679209491"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">,</span><span id="local-6989586621679209488"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209488"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209495"><span class="hs-identifier hs-var">lf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209496"><span class="hs-identifier hs-var">ropetext</span></a></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679209484"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209484"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209493"><span class="hs-identifier hs-var">lt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679209495"><span class="hs-identifier hs-var">lf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209488"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span id="local-6989586621679209491"><span class="annot"><span class="annottext">r :: Text
</span><a href="#local-6989586621679209491"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679209484"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-547"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-548"></span></pre></body></html>