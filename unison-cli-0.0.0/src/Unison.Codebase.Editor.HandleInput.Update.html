<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Codebase.Editor.HandleInput.Update</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#handleUpdate"><span class="hs-identifier">handleUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#doSlurpAdds"><span class="hs-identifier">doSlurpAdds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ask</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Foldable</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set.NonEmpty</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NESet</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Queries</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Queries</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ABT</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ABT</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html"><span class="hs-identifier">Unison.Cli.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier">Cli</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html"><span class="hs-identifier">Unison.Cli.Monad</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cli</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Cli.MonadUtils.html"><span class="hs-identifier">Unison.Cli.MonadUtils</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cli</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.NamesUtils.html"><span class="hs-identifier">Unison.Cli.NamesUtils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Cli.NamesUtils.html#displayNames"><span class="hs-identifier">displayNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.PrettyPrintUtils.html"><span class="hs-identifier">Unison.Cli.PrettyPrintUtils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Cli.PrettyPrintUtils.html#prettyPrintEnvDecl"><span class="hs-identifier">prettyPrintEnvDecl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.TypeCheck.html"><span class="hs-identifier">Unison.Cli.TypeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Cli.TypeCheck.html#typecheckFile"><span class="hs-identifier">typecheckFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Codebase</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Branch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Branch0</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Branch</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Branch</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Branch.Names</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Branch</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.BranchUtil</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BranchUtil</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.MetadataUtils.html"><span class="hs-identifier">Unison.Codebase.Editor.HandleInput.MetadataUtils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.MetadataUtils.html#addDefaultMetadata"><span class="hs-identifier">addDefaultMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Input.html"><span class="hs-identifier">Unison.Codebase.Editor.Input</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Output.html"><span class="hs-identifier">Unison.Codebase.Editor.Output</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Propagate.html"><span class="hs-identifier">Unison.Codebase.Editor.Propagate</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Propagate</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Slurp.html"><span class="hs-identifier">Unison.Codebase.Editor.Slurp</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Slurp</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpComponent.html"><span class="hs-identifier">Unison.Codebase.Editor.SlurpComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Editor.SlurpComponent.html#SlurpComponent"><span class="hs-identifier">SlurpComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpComponent.html"><span class="hs-identifier">Unison.Codebase.Editor.SlurpComponent</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SC</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpResult.html"><span class="hs-identifier">Unison.Codebase.Editor.SlurpResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Editor.SlurpResult.html#SlurpResult"><span class="hs-identifier">SlurpResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpResult.html"><span class="hs-identifier">Unison.Codebase.Editor.SlurpResult</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Slurp</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Metadata</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Metadata</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Patch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Patch</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Patch</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Patch</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Path</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Path</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Path</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Path</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.TermEdit</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TermEdit</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.TypeEdit</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TypeEdit</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decl</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Names</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Names</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ann</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnvDecl</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPE</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">biasTo</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Reference</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TermReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TermReferenceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TypeReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TypeReferenceId</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Referent</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Result</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Result</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Runtime.IOSource</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IOSource</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.Name</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeFromVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Term</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Typechecker</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Typechecker</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TypecheckedUnisonFile</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">UnisonFile</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UF</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile.Names</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UF</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UnisonFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UnisonFileId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">remap</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">upsert</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldMapM</span></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Relation</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Var</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Var</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.WatchKind</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">WatchKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.WatchKind</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WK</span></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">-- | Handle an @update@ command.</span><span>
</span><span id="line-78"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#handleUpdate"><span class="hs-identifier hs-type">handleUpdate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Input.html#Input"><span class="hs-identifier hs-type">Input</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Input.html#OptionalPatch"><span class="hs-identifier hs-type">OptionalPatch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier hs-type">Cli</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span id="handleUpdate"><span class="annot"><span class="annottext">handleUpdate :: Input -&gt; OptionalPatch -&gt; Set Name -&gt; Cli ()
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#handleUpdate"><span class="hs-identifier hs-var hs-var">handleUpdate</span></a></span></span><span> </span><span id="local-6989586621679690876"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679690876"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span id="local-6989586621679690875"><span class="annot"><span class="annottext">OptionalPatch
</span><a href="#local-6989586621679690875"><span class="hs-identifier hs-var">optionalPatch</span></a></span></span><span> </span><span id="local-6989586621679690874"><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621679690874"><span class="hs-identifier hs-var">requestedNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><a href="Unison.Cli.Monad.html#Env"><span class="hs-identifier hs-type">Cli.Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679690872"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
</span><a href="Unison.Cli.Monad.html#%24sel%3Acodebase%3AEnv"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-81"></span><span>  </span><span id="local-6989586621679690870"><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690870"><span class="hs-identifier hs-var">currentPath'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli Absolute
</span><a href="Unison.Cli.MonadUtils.html#getCurrentPath"><span class="hs-identifier hs-var">Cli.getCurrentPath</span></a></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690868"><span class="annot"><span class="annottext">patchPath :: Maybe Split'
</span><a href="#local-6989586621679690868"><span class="hs-identifier hs-var hs-var">patchPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OptionalPatch
</span><a href="#local-6989586621679690875"><span class="hs-identifier hs-var">optionalPatch</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-84"></span><span>          </span><span class="annot"><span class="annottext">OptionalPatch
</span><a href="Unison.Codebase.Editor.Input.html#NoPatch"><span class="hs-identifier hs-var">NoPatch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Split'
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-85"></span><span>          </span><span class="annot"><span class="annottext">OptionalPatch
</span><a href="Unison.Codebase.Editor.Input.html#DefaultPatch"><span class="hs-identifier hs-var">DefaultPatch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Split' -&gt; Maybe Split'
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Split'
</span><a href="Unison.Cli.MonadUtils.html#defaultPatchPath"><span class="hs-identifier hs-var">Cli.defaultPatchPath</span></a></span><span>
</span><span id="line-86"></span><span>          </span><span class="annot"><a href="Unison.Codebase.Editor.Input.html#UsePatch"><span class="hs-identifier hs-type">UsePatch</span></a></span><span> </span><span id="local-6989586621679690863"><span class="annot"><span class="annottext">Split'
</span><a href="#local-6989586621679690863"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Split' -&gt; Maybe Split'
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Split'
</span><a href="#local-6989586621679690863"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span id="local-6989586621679690862"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690862"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Branch0 IO -&gt; Names
forall (m :: * -&gt; *). Branch0 m -&gt; Names
</span><span class="hs-identifier hs-var">Branch.toNames</span></span><span> </span><span class="annot"><span class="annottext">(Branch0 IO -&gt; Names) -&gt; Cli (Branch0 IO) -&gt; Cli Names
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Cli (Branch0 IO)
</span><a href="Unison.Cli.MonadUtils.html#getCurrentBranch0"><span class="hs-identifier hs-var">Cli.getCurrentBranch0</span></a></span><span>
</span><span id="line-88"></span><span>  </span><span id="local-6989586621679690858"><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Names -&gt; Cli SlurpResult
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#getSlurpResultForUpdate"><span class="hs-identifier hs-var">getSlurpResultForUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621679690874"><span class="hs-identifier hs-var">requestedNames</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690862"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690856"><span class="hs-identifier hs-type">addsAndUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpComponent.html#SlurpComponent"><span class="hs-identifier hs-type">SlurpComponent</span></a></span><span>
</span><span id="line-90"></span><span>      </span><span id="local-6989586621679690856"><span class="annot"><span class="annottext">addsAndUpdates :: SlurpComponent
</span><a href="#local-6989586621679690856"><span class="hs-identifier hs-var hs-var">addsAndUpdates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlurpResult -&gt; SlurpComponent
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3Aupdates%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.updates</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpComponent -&gt; SlurpComponent -&gt; SlurpComponent
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SlurpResult -&gt; SlurpComponent
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3Aadds%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.adds</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><a href="#local-6989586621679690853"><span class="hs-identifier hs-type">fileNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span>
</span><span id="line-92"></span><span>      </span><span id="local-6989586621679690853"><span class="annot"><span class="annottext">fileNames :: Names
</span><a href="#local-6989586621679690853"><span class="hs-identifier hs-var hs-var">fileNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; Names
forall v a. Var v =&gt; TypecheckedUnisonFile v a -&gt; Names
</span><span class="hs-identifier hs-var">UF.typecheckedToNames</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- todo: display some error if typeEdits or termEdits itself contains a loop</span><span>
</span><span id="line-94"></span><span>      </span><span class="annot"><a href="#local-6989586621679690850"><span class="hs-identifier hs-type">typeEdits</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-95"></span><span>      </span><span id="local-6989586621679690850"><span class="annot"><span class="annottext">typeEdits :: [(Name, Reference, Reference)]
</span><a href="#local-6989586621679690850"><span class="hs-identifier hs-var hs-var">typeEdits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>        </span><span id="local-6989586621679690849"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690849"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; [Symbol]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpComponent -&gt; Set Symbol
</span><a href="Unison.Codebase.Editor.SlurpComponent.html#%24sel%3Atypes%3ASlurpComponent"><span class="hs-identifier hs-var hs-var">SC.types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; SlurpComponent
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3Aupdates%3ASlurpResult"><span class="hs-identifier hs-var hs-var">updates</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690846"><span class="annot"><span class="annottext">n :: Name
</span><a href="#local-6989586621679690846"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeFromVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690849"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690845"><span class="annot"><span class="annottext">oldRefs0 :: Set Reference
</span><a href="#local-6989586621679690845"><span class="hs-identifier hs-var hs-var">oldRefs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Name -&gt; Set Reference
</span><span class="hs-identifier hs-var">Names.typesNamed</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690862"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690846"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690843"><span class="annot"><span class="annottext">newRefs :: Set Reference
</span><a href="#local-6989586621679690843"><span class="hs-identifier hs-var hs-var">newRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Name -&gt; Set Reference
</span><span class="hs-identifier hs-var">Names.typesNamed</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690853"><span class="hs-identifier hs-var">fileNames</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690846"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NESet Reference -&gt; Reference -&gt; (NESet Reference, Reference))
-&gt; Maybe (NESet Reference)
-&gt; Maybe (Reference -&gt; (NESet Reference, Reference))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; Maybe (NESet Reference)
forall a. Set a -&gt; Maybe (NESet a)
</span><span class="hs-identifier hs-var">NESet.nonEmptySet</span></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690845"><span class="hs-identifier hs-var">oldRefs0</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Reference -&gt; (NESet Reference, Reference))
-&gt; Maybe Reference -&gt; Maybe (NESet Reference, Reference)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; Maybe Reference
forall a. Set a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Set.asSingleton</span></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690843"><span class="hs-identifier hs-var">newRefs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-101"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NESet Reference, Reference)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [(Name, Reference, Reference)]
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E722145&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;bad (old,new) names: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Set Reference, Set Reference) -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690845"><span class="hs-identifier hs-var">oldRefs0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690843"><span class="hs-identifier hs-var">newRefs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690837"><span class="annot"><span class="annottext">NESet Reference
</span><a href="#local-6989586621679690837"><span class="hs-identifier hs-var">oldRefs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690836"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690836"><span class="hs-identifier hs-var">newRef</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>            </span><span id="local-6989586621679690835"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690835"><span class="hs-identifier hs-var">oldRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NESet Reference -&gt; [Reference]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">Foldable.toList</span></span><span> </span><span class="annot"><span class="annottext">NESet Reference
</span><a href="#local-6989586621679690837"><span class="hs-identifier hs-var">oldRefs</span></a></span><span>
</span><span id="line-104"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690846"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690835"><span class="hs-identifier hs-var">oldRef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690836"><span class="hs-identifier hs-var">newRef</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-105"></span><span>      </span><span class="annot"><a href="#local-6989586621679690833"><span class="hs-identifier hs-type">hashTerms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>      </span><span id="local-6989586621679690833"><span class="annot"><span class="annottext">hashTerms :: Map Reference (Type Symbol Ann)
</span><a href="#local-6989586621679690833"><span class="hs-identifier hs-var hs-var">hashTerms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Reference, Type Symbol Ann)] -&gt; Map Reference (Type Symbol Ann)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Symbol (Reference, Type Symbol Ann)
-&gt; [(Reference, Type Symbol Ann)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Map Symbol (Reference, Type Symbol Ann)
</span><a href="#local-6989586621679690831"><span class="hs-identifier hs-var">hashTerms0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-108"></span><span>          </span><span id="local-6989586621679690831"><span class="annot"><span class="annottext">hashTerms0 :: Map Symbol (Reference, Type Symbol Ann)
</span><a href="#local-6989586621679690831"><span class="hs-identifier hs-var hs-var">hashTerms0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690830"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690830"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690829"><span class="annot"><span class="annottext">Maybe [Char]
</span><a href="#local-6989586621679690829"><span class="hs-identifier hs-var">_wk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690828"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690828"><span class="hs-identifier hs-var">_tm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690827"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690827"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690830"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690827"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Reference, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
 -&gt; (Reference, Type Symbol Ann))
-&gt; Map
     Symbol (Reference, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
-&gt; Map Symbol (Reference, Type Symbol Ann)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map
     Symbol (Reference, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (Reference, Maybe [Char], Term v a, Type v a)
</span><span class="hs-identifier hs-var">UF.hashTerms</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>      </span><span class="annot"><a href="#local-6989586621679690825"><span class="hs-identifier hs-type">termEdits</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-110"></span><span>      </span><span id="local-6989586621679690825"><span class="annot"><span class="annottext">termEdits :: [(Name, Reference, Reference)]
</span><a href="#local-6989586621679690825"><span class="hs-identifier hs-var hs-var">termEdits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>        </span><span id="local-6989586621679690824"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690824"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; [Symbol]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpComponent -&gt; Set Symbol
</span><a href="Unison.Codebase.Editor.SlurpComponent.html#%24sel%3Aterms%3ASlurpComponent"><span class="hs-identifier hs-var hs-var">SC.terms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; SlurpComponent
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3Aupdates%3ASlurpResult"><span class="hs-identifier hs-var hs-var">updates</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690822"><span class="annot"><span class="annottext">n :: Name
</span><a href="#local-6989586621679690822"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeFromVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690824"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690821"><span class="annot"><span class="annottext">oldRefs0 :: Set Reference
</span><a href="#local-6989586621679690821"><span class="hs-identifier hs-var hs-var">oldRefs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Name -&gt; Set Reference
</span><span class="hs-identifier hs-var">Names.refTermsNamed</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690862"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690822"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-114"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690819"><span class="annot"><span class="annottext">newRefs :: Set Reference
</span><a href="#local-6989586621679690819"><span class="hs-identifier hs-var hs-var">newRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Name -&gt; Set Reference
</span><span class="hs-identifier hs-var">Names.refTermsNamed</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690853"><span class="hs-identifier hs-var">fileNames</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690822"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NESet Reference -&gt; Reference -&gt; (NESet Reference, Reference))
-&gt; Maybe (NESet Reference)
-&gt; Maybe (Reference -&gt; (NESet Reference, Reference))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; Maybe (NESet Reference)
forall a. Set a -&gt; Maybe (NESet a)
</span><span class="hs-identifier hs-var">NESet.nonEmptySet</span></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690821"><span class="hs-identifier hs-var">oldRefs0</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Reference -&gt; (NESet Reference, Reference))
-&gt; Maybe Reference -&gt; Maybe (NESet Reference, Reference)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; Maybe Reference
forall a. Set a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Set.asSingleton</span></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690819"><span class="hs-identifier hs-var">newRefs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-116"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NESet Reference, Reference)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [(Name, Reference, Reference)]
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E936103&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;bad (old,new) names: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Set Reference, Set Reference) -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690821"><span class="hs-identifier hs-var">oldRefs0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690819"><span class="hs-identifier hs-var">newRefs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690818"><span class="annot"><span class="annottext">NESet Reference
</span><a href="#local-6989586621679690818"><span class="hs-identifier hs-var">oldRefs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690817"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690817"><span class="hs-identifier hs-var">newRef</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>            </span><span id="local-6989586621679690816"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690816"><span class="hs-identifier hs-var">oldRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NESet Reference -&gt; [Reference]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">Foldable.toList</span></span><span> </span><span class="annot"><span class="annottext">NESet Reference
</span><a href="#local-6989586621679690818"><span class="hs-identifier hs-var">oldRefs</span></a></span><span>
</span><span id="line-119"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690822"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690816"><span class="hs-identifier hs-var">oldRef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690817"><span class="hs-identifier hs-var">newRef</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><a href="#local-6989586621679690815"><span class="hs-identifier hs-type">termDeprecations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-121"></span><span>      </span><span id="local-6989586621679690815"><span class="annot"><span class="annottext">termDeprecations :: [(Name, Referent)]
</span><a href="#local-6989586621679690815"><span class="hs-identifier hs-var hs-var">termDeprecations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690814"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621679690813"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690812"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690812"><span class="hs-identifier hs-var">oldTypeRef</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690850"><span class="hs-identifier hs-var">typeEdits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679690814"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690814"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690813"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621679690813"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Names -&gt; [(Name, Referent)]
</span><span class="hs-identifier hs-var">Names.constructorsForType</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690812"><span class="hs-identifier hs-var">oldTypeRef</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690862"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span><span>
</span><span id="line-125"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-126"></span><span>  </span><span id="local-6989586621679690810"><span class="annot"><span class="annottext">Maybe (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute)
</span><a href="#local-6989586621679690810"><span class="hs-identifier hs-var">patchOps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Split'
-&gt; (Split' -&gt; Cli (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute))
-&gt; Cli (Maybe (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">Maybe Split'
</span><a href="#local-6989586621679690868"><span class="hs-identifier hs-var">patchPath</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679690808"><span class="annot"><span class="annottext">Split'
</span><a href="#local-6989586621679690808"><span class="hs-identifier hs-var">patchPath</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621679690807"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690807"><span class="hs-identifier hs-var">ye'ol'Patch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Split' -&gt; Cli Patch
</span><a href="Unison.Cli.MonadUtils.html#getPatchAt"><span class="hs-identifier hs-var">Cli.getPatchAt</span></a></span><span> </span><span class="annot"><span class="annottext">Split'
</span><a href="#local-6989586621679690808"><span class="hs-identifier hs-var">patchPath</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-comment">-- If `uf` updates a -&gt; a', we want to replace all (a0 -&gt; a) in patch</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">-- with (a0 -&gt; a') in patch'.</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-comment">-- So for all (a0 -&gt; a) in patch, for all (a -&gt; a') in `uf`,</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- we must know the type of a0, a, a'.</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- we need:</span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-comment">-- all of the `old` references from the `new` edits,</span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-comment">-- plus all of the `old` references for edits from patch we're replacing</span><span>
</span><span id="line-135"></span><span>        </span><span class="annot"><a href="#local-6989586621679690805"><span class="hs-identifier hs-type">collectOldForTyping</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Patch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span>
</span><span id="line-136"></span><span>        </span><span id="local-6989586621679690805"><span class="annot"><span class="annottext">collectOldForTyping :: [(Reference, Reference)] -&gt; Patch -&gt; Set Reference
</span><a href="#local-6989586621679690805"><span class="hs-identifier hs-var hs-var">collectOldForTyping</span></a></span></span><span> </span><span id="local-6989586621679690804"><span class="annot"><span class="annottext">[(Reference, Reference)]
</span><a href="#local-6989586621679690804"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span id="local-6989586621679690803"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690803"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set Reference -&gt; (Reference, Reference) -&gt; Set Reference)
-&gt; Set Reference -&gt; [(Reference, Reference)] -&gt; Set Reference
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; (Reference, Reference) -&gt; Set Reference
forall a b. Ord a =&gt; Set a -&gt; (a, b) -&gt; Set a
</span><a href="#local-6989586621679690801"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Set Reference
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Reference, Reference)]
</span><a href="#local-6989586621679690804"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">[(Reference, Reference)]
-&gt; [(Reference, Reference)] -&gt; [(Reference, Reference)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(Reference, Reference)]
</span><a href="#local-6989586621679690800"><span class="hs-identifier hs-var">fromOld</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-138"></span><span>            </span><span id="local-6989586621679690801"><span class="annot"><span class="annottext">f :: Set a -&gt; (a, b) -&gt; Set a
</span><a href="#local-6989586621679690801"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679690799"><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621679690799"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690798"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679690798"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690797"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679690797"><span class="hs-identifier hs-var">_r'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Set a -&gt; Set a
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679690798"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Set a
</span><a href="#local-6989586621679690799"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-139"></span><span>            </span><span id="local-6989586621679690795"><span class="annot"><span class="annottext">newLHS :: Set Reference
</span><a href="#local-6989586621679690795"><span class="hs-identifier hs-var hs-var">newLHS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Reference] -&gt; Set Reference
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Reference] -&gt; Set Reference)
-&gt; ([(Reference, Reference)] -&gt; [Reference])
-&gt; [(Reference, Reference)]
-&gt; Set Reference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Reference, Reference) -&gt; Reference)
-&gt; [(Reference, Reference)] -&gt; [Reference]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Reference, Reference) -&gt; Reference
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Reference, Reference)] -&gt; Set Reference)
-&gt; [(Reference, Reference)] -&gt; Set Reference
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Reference, Reference)]
</span><a href="#local-6989586621679690804"><span class="hs-identifier hs-var">new</span></a></span><span>
</span><span id="line-140"></span><span>            </span><span class="annot"><a href="#local-6989586621679690800"><span class="hs-identifier hs-type">fromOld</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-141"></span><span>            </span><span id="local-6989586621679690800"><span class="annot"><span class="annottext">fromOld :: [(Reference, Reference)]
</span><a href="#local-6989586621679690800"><span class="hs-identifier hs-var hs-var">fromOld</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690792"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690791"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690792"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690792"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermEdit.Replace</span></span><span> </span><span id="local-6989586621679690791"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690791"><span class="hs-identifier hs-var">r'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Typing
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Relation Reference TermEdit -&gt; [(Reference, TermEdit)]
forall a b. Relation a b -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">R.toList</span></span><span> </span><span class="annot"><span class="annottext">(Relation Reference TermEdit -&gt; [(Reference, TermEdit)])
-&gt; (Patch -&gt; Relation Reference TermEdit)
-&gt; Patch
-&gt; [(Reference, TermEdit)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Patch -&gt; Relation Reference TermEdit
</span><span class="hs-identifier hs-var hs-var">Patch._termEdits</span></span><span> </span><span class="annot"><span class="annottext">(Patch -&gt; [(Reference, TermEdit)])
-&gt; Patch -&gt; [(Reference, TermEdit)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690803"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Set Reference -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690791"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690795"><span class="hs-identifier hs-var">newLHS</span></a></span><span>
</span><span id="line-143"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-144"></span><span>        </span><span id="local-6989586621679690786"><span class="annot"><span class="annottext">neededTypes :: Set Reference
</span><a href="#local-6989586621679690786"><span class="hs-identifier hs-var hs-var">neededTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Reference, Reference)] -&gt; Patch -&gt; Set Reference
</span><a href="#local-6989586621679690805"><span class="hs-identifier hs-var">collectOldForTyping</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, Reference, Reference) -&gt; (Reference, Reference))
-&gt; [(Name, Reference, Reference)] -&gt; [(Reference, Reference)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690785"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690785"><span class="hs-identifier hs-var">old</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690784"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690784"><span class="hs-identifier hs-var">new</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690785"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690784"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690825"><span class="hs-identifier hs-var">termEdits</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690807"><span class="hs-identifier hs-var">ye'ol'Patch</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621679690783"><span id="local-6989586621679690782"><span class="annot"><span class="annottext">Map Reference (Type Symbol Ann)
</span><a href="#local-6989586621679690782"><span class="hs-identifier hs-var">allTypes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621679690783"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Map Reference (Type Symbol Ann))
-&gt; Cli (Map Reference (Type Symbol Ann))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Map Reference (Type Symbol Ann))
 -&gt; Cli (Map Reference (Type Symbol Ann)))
-&gt; (Transaction (Map Reference (Type Symbol Ann))
    -&gt; IO (Map Reference (Type Symbol Ann)))
-&gt; Transaction (Map Reference (Type Symbol Ann))
-&gt; Cli (Map Reference (Type Symbol Ann))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Transaction (Map Reference (Type Symbol Ann))
-&gt; IO (Map Reference (Type Symbol Ann))
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690872"><span class="hs-identifier hs-var">codebase</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><span class="annottext">([(Reference, Type Symbol Ann)] -&gt; Map Reference (Type Symbol Ann))
-&gt; Transaction [(Reference, Type Symbol Ann)]
-&gt; Transaction (Map Reference (Type Symbol Ann))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(Reference, Type Symbol Ann)] -&gt; Map Reference (Type Symbol Ann)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">(Transaction [(Reference, Type Symbol Ann)]
 -&gt; Transaction (Map Reference (Type Symbol Ann)))
-&gt; ((Reference -&gt; Transaction (Reference, Type Symbol Ann))
    -&gt; Transaction [(Reference, Type Symbol Ann)])
-&gt; (Reference -&gt; Transaction (Reference, Type Symbol Ann))
-&gt; Transaction (Map Reference (Type Symbol Ann))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Reference]
-&gt; (Reference -&gt; Transaction (Reference, Type Symbol Ann))
-&gt; Transaction [(Reference, Type Symbol Ann)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690786"><span class="hs-identifier hs-var">neededTypes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Reference -&gt; Transaction (Reference, Type Symbol Ann))
 -&gt; Transaction (Map Reference (Type Symbol Ann)))
-&gt; (Reference -&gt; Transaction (Reference, Type Symbol Ann))
-&gt; Transaction (Map Reference (Type Symbol Ann))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679690779"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690779"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690779"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Type Symbol Ann -&gt; (Reference, Type Symbol Ann))
-&gt; (Maybe (Type Symbol Ann) -&gt; Type Symbol Ann)
-&gt; Maybe (Type Symbol Ann)
-&gt; (Reference, Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Maybe (Type Symbol Ann) -&gt; Type Symbol Ann
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann -&gt; Text -&gt; Type Symbol Ann
forall v a. Ord v =&gt; a -&gt; Text -&gt; Type v a
</span><span class="hs-identifier hs-var">Type.builtin</span></span><span> </span><span class="annot"><span class="annottext">Ann
</span><span class="hs-identifier hs-var">External</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unknown type&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>            </span><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann) -&gt; (Reference, Type Symbol Ann))
-&gt; Transaction (Maybe (Type Symbol Ann))
-&gt; Transaction (Reference, Type Symbol Ann)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Reference -&gt; Transaction (Maybe (Type Symbol Ann))
forall a (m :: * -&gt; *).
BuiltinAnnotation a =&gt;
Codebase m Symbol a
-&gt; Reference -&gt; Transaction (Maybe (Type Symbol a))
</span><span class="hs-identifier hs-var">Codebase.getTypeOfTerm</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690872"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690779"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690774"><span class="annot"><span class="annottext">typing :: Reference -&gt; Reference -&gt; Typing
</span><a href="#local-6989586621679690774"><span class="hs-identifier hs-var hs-var">typing</span></a></span></span><span> </span><span id="local-6989586621679690773"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690773"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621679690772"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690772"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference
-&gt; Map Reference (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690773"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Map Reference (Type Symbol Ann)
</span><a href="#local-6989586621679690782"><span class="hs-identifier hs-var">allTypes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference
-&gt; Map Reference (Type Symbol Ann) -&gt; Maybe (Type Symbol Ann)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690772"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">Map Reference (Type Symbol Ann)
</span><a href="#local-6989586621679690833"><span class="hs-identifier hs-var">hashTerms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690770"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690770"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690769"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690769"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Type Symbol Ann -&gt; Bool
forall v loc. Var v =&gt; Type v loc -&gt; Type v loc -&gt; Bool
</span><span class="hs-identifier hs-var">Typechecker.isEqual</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690770"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690769"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Typing
</span><span class="hs-identifier hs-var">TermEdit.Same</span></span><span>
</span><span id="line-155"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Type Symbol Ann -&gt; Bool
forall v loc. Var v =&gt; Type v loc -&gt; Type v loc -&gt; Bool
</span><span class="hs-identifier hs-var">Typechecker.isSubtype</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690770"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690769"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Typing
</span><span class="hs-identifier hs-var">TermEdit.Subtype</span></span><span>
</span><span id="line-156"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Typing
</span><span class="hs-identifier hs-var">TermEdit.Different</span></span><span>
</span><span id="line-157"></span><span>          </span><span id="local-6989586621679690763"><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann), Maybe (Type Symbol Ann))
</span><a href="#local-6989586621679690763"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; Typing
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Typing) -&gt; [Char] -&gt; Typing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-159"></span><span>              </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;compiler bug: typing map not constructed properly\n&quot;</span></span><span>
</span><span id="line-160"></span><span>                </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;typing &quot;</span></span><span>
</span><span id="line-161"></span><span>                </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690773"><span class="hs-identifier hs-var">r1</span></a></span><span>
</span><span id="line-162"></span><span>                </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; &quot;</span></span><span>
</span><span id="line-163"></span><span>                </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690772"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-164"></span><span>                </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; : &quot;</span></span><span>
</span><span id="line-165"></span><span>                </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann), Maybe (Type Symbol Ann)) -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Type Symbol Ann), Maybe (Type Symbol Ann))
</span><a href="#local-6989586621679690763"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><a href="#local-6989586621679690762"><span class="hs-identifier hs-type">updatePatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Patch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Patch</span></span><span>
</span><span id="line-168"></span><span>        </span><span id="local-6989586621679690762"><span class="annot"><span class="annottext">updatePatch :: Patch -&gt; Patch
</span><a href="#local-6989586621679690762"><span class="hs-identifier hs-var hs-var">updatePatch</span></a></span></span><span> </span><span id="local-6989586621679690761"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690761"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Patch -&gt; (Name, Reference, Reference) -&gt; Patch)
-&gt; Patch -&gt; [(Name, Reference, Reference)] -&gt; Patch
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Patch -&gt; (Name, Reference, Reference) -&gt; Patch
</span><a href="#local-6989586621679690760"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690759"><span class="hs-identifier hs-var">p'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690825"><span class="hs-identifier hs-var">termEdits</span></a></span><span>
</span><span id="line-169"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>            </span><span id="local-6989586621679690759"><span class="annot"><span class="annottext">p' :: Patch
</span><a href="#local-6989586621679690759"><span class="hs-identifier hs-var hs-var">p'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Patch -&gt; (Name, Reference, Reference) -&gt; Patch)
-&gt; Patch -&gt; [(Name, Reference, Reference)] -&gt; Patch
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Patch -&gt; (Name, Reference, Reference) -&gt; Patch
forall a. Patch -&gt; (a, Reference, Reference) -&gt; Patch
</span><a href="#local-6989586621679690758"><span class="hs-identifier hs-var">step1</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690761"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690850"><span class="hs-identifier hs-var">typeEdits</span></a></span><span>
</span><span id="line-171"></span><span>            </span><span id="local-6989586621679690758"><span class="annot"><span class="annottext">step1 :: Patch -&gt; (a, Reference, Reference) -&gt; Patch
</span><a href="#local-6989586621679690758"><span class="hs-identifier hs-var hs-var">step1</span></a></span></span><span> </span><span id="local-6989586621679690757"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690757"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690756"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690756"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690755"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690755"><span class="hs-identifier hs-var">r'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; TypeEdit -&gt; Patch -&gt; Patch
</span><span class="hs-identifier hs-var">Patch.updateType</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690756"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; TypeEdit
</span><span class="hs-identifier hs-var">TypeEdit.Replace</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690755"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690757"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-172"></span><span>            </span><span id="local-6989586621679690760"><span class="annot"><span class="annottext">step2 :: Patch -&gt; (Name, Reference, Reference) -&gt; Patch
</span><a href="#local-6989586621679690760"><span class="hs-identifier hs-var hs-var">step2</span></a></span></span><span> </span><span id="local-6989586621679690752"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690752"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690751"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690751"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690750"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690750"><span class="hs-identifier hs-var">r'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Reference -&gt; Typing)
-&gt; Reference -&gt; TermEdit -&gt; Patch -&gt; Patch
</span><span class="hs-identifier hs-var">Patch.updateTerm</span></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Reference -&gt; Typing
</span><a href="#local-6989586621679690774"><span class="hs-identifier hs-var">typing</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690751"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Typing -&gt; TermEdit
</span><span class="hs-identifier hs-var">TermEdit.Replace</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690750"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Reference -&gt; Typing
</span><a href="#local-6989586621679690774"><span class="hs-identifier hs-var">typing</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690751"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690750"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690752"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679690748"><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690748"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690747"><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679690747"><span class="hs-identifier hs-var">seg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Absolute -&gt; Split' -&gt; (Absolute, NameSegment)
forall a. Absolute -&gt; (Path', a) -&gt; (Absolute, a)
</span><span class="hs-identifier hs-var">Path.toAbsoluteSplit</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690870"><span class="hs-identifier hs-var">currentPath'</span></a></span><span> </span><span class="annot"><span class="annottext">Split'
</span><a href="#local-6989586621679690808"><span class="hs-identifier hs-var">patchPath</span></a></span><span>
</span><span id="line-174"></span><span>        </span><span id="local-6989586621679691104"><span class="annot"><a href="#local-6989586621679690745"><span class="hs-identifier hs-type">updatePatches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679691104"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691104"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679691104"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691104"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-175"></span><span>        </span><span id="local-6989586621679690745"><span class="annot"><span class="annottext">updatePatches :: Branch0 m -&gt; m (Branch0 m)
</span><a href="#local-6989586621679690745"><span class="hs-identifier hs-var hs-var">updatePatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameSegment -&gt; (Patch -&gt; Patch) -&gt; Branch0 m -&gt; m (Branch0 m)
forall (m :: * -&gt; *).
Monad m =&gt;
NameSegment -&gt; (Patch -&gt; Patch) -&gt; Branch0 m -&gt; m (Branch0 m)
</span><span class="hs-identifier hs-var">Branch.modifyPatches</span></span><span> </span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679690747"><span class="hs-identifier hs-var">seg</span></a></span><span> </span><span class="annot"><span class="annottext">Patch -&gt; Patch
</span><a href="#local-6989586621679690762"><span class="hs-identifier hs-var">updatePatch</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><span class="annottext">(Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute)
-&gt; Cli (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch -&gt; Patch
</span><a href="#local-6989586621679690762"><span class="hs-identifier hs-var">updatePatch</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690807"><span class="hs-identifier hs-var">ye'ol'Patch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Branch0 IO -&gt; IO (Branch0 IO)
forall (m :: * -&gt; *). Monad m =&gt; Branch0 m -&gt; m (Branch0 m)
</span><a href="#local-6989586621679690745"><span class="hs-identifier hs-var">updatePatches</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690748"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Cli () -&gt; Cli ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; Bool
</span><a href="Unison.Codebase.Editor.SlurpResult.html#hasAddsOrUpdates"><span class="hs-identifier hs-var">Slurp.hasAddsOrUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Cli () -&gt; Cli ()) -&gt; Cli () -&gt; Cli ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-comment">-- take a look at the `updates` from the SlurpResult</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-comment">-- and make a patch diff to record a replacement from the old to new references</span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">[(Path, Branch0 IO -&gt; IO (Branch0 IO))] -&gt; Cli ()
forall (f :: * -&gt; *).
Foldable f =&gt;
f (Path, Branch0 IO -&gt; IO (Branch0 IO)) -&gt; Cli ()
</span><a href="Unison.Cli.MonadUtils.html#stepManyAtMNoSync"><span class="hs-identifier hs-var">Cli.stepManyAtMNoSync</span></a></span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Absolute -&gt; Path
</span><span class="hs-identifier hs-var hs-var">Path.unabsolute</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690870"><span class="hs-identifier hs-var">currentPath'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-183"></span><span>            </span><span class="annot"><span class="annottext">Branch0 IO -&gt; IO (Branch0 IO)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Branch0 IO -&gt; IO (Branch0 IO))
-&gt; (Branch0 IO -&gt; Branch0 IO) -&gt; Branch0 IO -&gt; IO (Branch0 IO)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
-&gt; [(Name, Reference, Reference)]
-&gt; [(Name, Referent)]
-&gt; Branch0 IO
-&gt; Branch0 IO
forall (m :: * -&gt; *).
Monad m =&gt;
[(Name, Reference, Reference)]
-&gt; [(Name, Reference, Reference)]
-&gt; [(Name, Referent)]
-&gt; Branch0 m
-&gt; Branch0 m
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#doSlurpUpdates"><span class="hs-identifier hs-var">doSlurpUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690850"><span class="hs-identifier hs-var">typeEdits</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690825"><span class="hs-identifier hs-var">termEdits</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621679690815"><span class="hs-identifier hs-var">termDeprecations</span></a></span><span>
</span><span id="line-184"></span><span>          </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-185"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Absolute -&gt; Path
</span><span class="hs-identifier hs-var hs-var">Path.unabsolute</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690870"><span class="hs-identifier hs-var">currentPath'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>            </span><span class="annot"><span class="annottext">Branch0 IO -&gt; IO (Branch0 IO)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Branch0 IO -&gt; IO (Branch0 IO))
-&gt; (Branch0 IO -&gt; Branch0 IO) -&gt; Branch0 IO -&gt; IO (Branch0 IO)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SlurpComponent
-&gt; TypecheckedUnisonFile Symbol Ann -&gt; Branch0 IO -&gt; Branch0 IO
forall (m :: * -&gt; *).
Monad m =&gt;
SlurpComponent
-&gt; TypecheckedUnisonFile Symbol Ann -&gt; Branch0 m -&gt; Branch0 m
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#doSlurpAdds"><span class="hs-identifier hs-var">doSlurpAdds</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpComponent
</span><a href="#local-6989586621679690856"><span class="hs-identifier hs-var">addsAndUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-189"></span><span>          </span><span class="annot"><span class="annottext">[(Path, Branch0 IO -&gt; IO (Branch0 IO))]
-&gt; [(Path, Branch0 IO -&gt; IO (Branch0 IO))]
-&gt; [(Path, Branch0 IO -&gt; IO (Branch0 IO))]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute)
</span><a href="#local-6989586621679690810"><span class="hs-identifier hs-var">patchOps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-190"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-191"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690738"><span class="annot"><span class="annottext">Branch0 IO -&gt; IO (Branch0 IO)
</span><a href="#local-6989586621679690738"><span class="hs-identifier hs-var">update</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690737"><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690737"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Absolute -&gt; Path
</span><span class="hs-identifier hs-var hs-var">Path.unabsolute</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690737"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Branch0 IO -&gt; IO (Branch0 IO)
</span><a href="#local-6989586621679690738"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">Transaction () -&gt; Cli ()
forall a. Transaction a -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#runTransaction"><span class="hs-identifier hs-var">Cli.runTransaction</span></a></span><span>
</span><span id="line-194"></span><span>      </span><span class="annot"><span class="annottext">(Transaction () -&gt; Cli ())
-&gt; (TypecheckedUnisonFile Symbol Ann -&gt; Transaction ())
-&gt; TypecheckedUnisonFile Symbol Ann
-&gt; Cli ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; TypecheckedUnisonFile Symbol Ann -&gt; Transaction ()
forall (m :: * -&gt; *) v a.
(Var v, Show a) =&gt;
Codebase m v a -&gt; TypecheckedUnisonFile v a -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Codebase.addDefsToCodebase</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690872"><span class="hs-identifier hs-var">codebase</span></a></span><span>
</span><span id="line-195"></span><span>      </span><span class="annot"><span class="annottext">(TypecheckedUnisonFile Symbol Ann -&gt; Transaction ())
-&gt; (TypecheckedUnisonFile Symbol Ann
    -&gt; TypecheckedUnisonFile Symbol Ann)
-&gt; TypecheckedUnisonFile Symbol Ann
-&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SlurpResult
-&gt; TypecheckedUnisonFile Symbol Ann
-&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#filterUnisonFile"><span class="hs-identifier hs-var">Slurp.filterUnisonFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><span class="annottext">(TypecheckedUnisonFile Symbol Ann -&gt; Cli ())
-&gt; TypecheckedUnisonFile Symbol Ann -&gt; Cli ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span id="local-6989586621679690733"><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621679690733"><span class="hs-identifier hs-var">ppe</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NamesWithHistory -&gt; Cli PrettyPrintEnvDecl
</span><a href="Unison.Cli.PrettyPrintUtils.html#prettyPrintEnvDecl"><span class="hs-identifier hs-var">prettyPrintEnvDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(NamesWithHistory -&gt; Cli PrettyPrintEnvDecl)
-&gt; Cli NamesWithHistory -&gt; Cli PrettyPrintEnvDecl
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; Cli NamesWithHistory
forall v a.
Var v =&gt;
TypecheckedUnisonFile v a -&gt; Cli NamesWithHistory
</span><a href="Unison.Cli.NamesUtils.html#displayNames"><span class="hs-identifier hs-var">displayNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><span class="annottext">Output -&gt; Cli ()
</span><a href="Unison.Cli.Monad.html#respond"><span class="hs-identifier hs-var">Cli.respond</span></a></span><span> </span><span class="annot"><span class="annottext">(Output -&gt; Cli ()) -&gt; Output -&gt; Cli ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; PrettyPrintEnv -&gt; SlurpResult -&gt; Output
</span><a href="Unison.Codebase.Editor.Output.html#SlurpOutput"><span class="hs-identifier hs-var">SlurpOutput</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621679690876"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrettyPrintEnvDecl -&gt; PrettyPrintEnv
</span><span class="hs-identifier hs-var hs-var">PPE.suffixifiedPPE</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621679690733"><span class="hs-identifier hs-var">ppe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690858"><span class="hs-identifier hs-var">sr</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute)
-&gt; ((Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute) -&gt; Cli ())
-&gt; Cli ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><span class="hs-identifier hs-var">whenJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Patch, Branch0 IO -&gt; IO (Branch0 IO), Absolute)
</span><a href="#local-6989586621679690810"><span class="hs-identifier hs-var">patchOps</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690727"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690727"><span class="hs-identifier hs-var">updatedPatch</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Branch0 IO -&gt; IO (Branch0 IO)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Absolute
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="annottext">Cli Bool -&gt; Cli ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Cli Bool -&gt; Cli ()) -&gt; Cli Bool -&gt; Cli ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Patch -&gt; Absolute -&gt; Cli Bool
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#propagatePatchNoSync"><span class="hs-identifier hs-var">propagatePatchNoSync</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690727"><span class="hs-identifier hs-var">updatedPatch</span></a></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690870"><span class="hs-identifier hs-var">currentPath'</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">SlurpComponent -&gt; Cli ()
</span><a href="Unison.Codebase.Editor.HandleInput.MetadataUtils.html#addDefaultMetadata"><span class="hs-identifier hs-var">addDefaultMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpComponent
</span><a href="#local-6989586621679690856"><span class="hs-identifier hs-var">addsAndUpdates</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Cli ()
</span><a href="Unison.Cli.MonadUtils.html#syncRoot"><span class="hs-identifier hs-var">Cli.syncRoot</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Split'
</span><a href="#local-6989586621679690868"><span class="hs-identifier hs-var">patchPath</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="annottext">Maybe Split'
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;update.nopatch&quot;</span></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690723"><span class="annot"><span class="annottext">Split'
</span><a href="#local-6989586621679690723"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-205"></span><span>      </span><span class="annot"><span class="annottext">Split'
</span><a href="#local-6989586621679690723"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-206"></span><span>        </span><span class="annot"><span class="annottext">Split' -&gt; (Split' -&gt; Path') -&gt; Path'
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Split' -&gt; Path'
</span><span class="hs-identifier hs-var">Path.unsplit'</span></span><span>
</span><span id="line-207"></span><span>        </span><span class="annot"><span class="annottext">Path' -&gt; (Path' -&gt; Absolute) -&gt; Absolute
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Absolute -&gt; Path' -&gt; Absolute
forall l r o. Resolve l r o =&gt; l -&gt; r -&gt; o
</span><span class="hs-identifier hs-var">Path.resolve</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Path.Absolute</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690870"><span class="hs-identifier hs-var">currentPath'</span></a></span><span>
</span><span id="line-208"></span><span>        </span><span class="annot"><span class="annottext">Absolute -&gt; (Absolute -&gt; Text) -&gt; Text
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Absolute -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#getSlurpResultForUpdate"><span class="hs-identifier hs-type">getSlurpResultForUpdate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier hs-type">Cli</span></a></span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpResult.html#SlurpResult"><span class="hs-identifier hs-type">SlurpResult</span></a></span><span>
</span><span id="line-211"></span><span id="getSlurpResultForUpdate"><span class="annot"><span class="annottext">getSlurpResultForUpdate :: Set Name -&gt; Names -&gt; Cli SlurpResult
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#getSlurpResultForUpdate"><span class="hs-identifier hs-var hs-var">getSlurpResultForUpdate</span></a></span></span><span> </span><span id="local-6989586621679690718"><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621679690718"><span class="hs-identifier hs-var">requestedNames</span></a></span></span><span> </span><span id="local-6989586621679690717"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690717"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690716"><span class="hs-identifier hs-type">slurp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpResult.html#SlurpResult"><span class="hs-identifier hs-type">SlurpResult</span></a></span><span>
</span><span id="line-213"></span><span>      </span><span id="local-6989586621679690716"><span class="annot"><span class="annottext">slurp :: TypecheckedUnisonFile Symbol Ann -&gt; SlurpResult
</span><a href="#local-6989586621679690716"><span class="hs-identifier hs-var hs-var">slurp</span></a></span></span><span> </span><span id="local-6989586621679690715"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690715"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-214"></span><span>        </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Set Symbol -&gt; SlurpOp -&gt; Names -&gt; SlurpResult
</span><a href="Unison.Codebase.Editor.Slurp.html#slurpFile"><span class="hs-identifier hs-var">Slurp.slurpFile</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690715"><span class="hs-identifier hs-var">file</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Symbol) -&gt; Set Name -&gt; Set Symbol
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Symbol
forall v. Var v =&gt; Name -&gt; v
</span><span class="hs-identifier hs-var">Name.toVar</span></span><span> </span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621679690718"><span class="hs-identifier hs-var">requestedNames</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlurpOp
</span><a href="Unison.Codebase.Editor.Slurp.html#UpdateOp"><span class="hs-identifier hs-var">Slurp.UpdateOp</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690717"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690711"><span class="hs-identifier hs-type">termRefToNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span>
</span><span id="line-217"></span><span>      </span><span id="local-6989586621679690711"><span class="annot"><span class="annottext">termRefToNames :: TermReferenceId -&gt; Set Symbol
</span><a href="#local-6989586621679690711"><span class="hs-identifier hs-var hs-var">termRefToNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">(Name -&gt; Symbol) -&gt; Set Name -&gt; Set Symbol
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Symbol
forall v. Var v =&gt; Name -&gt; v
</span><span class="hs-identifier hs-var">Name.toVar</span></span><span> </span><span class="annot"><span class="annottext">(Set Name -&gt; Set Symbol)
-&gt; (TermReferenceId -&gt; Set Name) -&gt; TermReferenceId -&gt; Set Symbol
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Referent -&gt; Set Name
</span><span class="hs-identifier hs-var">Names.namesForReferent</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690717"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Referent -&gt; Set Name)
-&gt; (TermReferenceId -&gt; Referent) -&gt; TermReferenceId -&gt; Set Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; Referent
</span><span class="hs-identifier hs-var">Referent.fromTermReferenceId</span></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690708"><span class="hs-identifier hs-type">nameToTermRefs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span>
</span><span id="line-221"></span><span>      </span><span id="local-6989586621679690708"><span class="annot"><span class="annottext">nameToTermRefs :: Symbol -&gt; Set Reference
</span><a href="#local-6989586621679690708"><span class="hs-identifier hs-var hs-var">nameToTermRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Name -&gt; Set Reference
</span><span class="hs-identifier hs-var">Names.refTermsNamed</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690717"><span class="hs-identifier hs-var">slurpCheckNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Set Reference)
-&gt; (Symbol -&gt; Name) -&gt; Symbol -&gt; Set Reference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeFromVar</span></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>  </span><span id="local-6989586621679690707"><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690707"><span class="hs-identifier hs-var">slurp1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><a href="Unison.Cli.Monad.html#Env"><span class="hs-identifier hs-type">Cli.Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679690706"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
</span><a href="#local-6989586621679690706"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621679690705"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690705"><span class="hs-identifier hs-var">unisonFile0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli (TypecheckedUnisonFile Symbol Ann)
</span><a href="Unison.Cli.MonadUtils.html#expectLatestTypecheckedFile"><span class="hs-identifier hs-var">Cli.expectLatestTypecheckedFile</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">-- Here, we identify whether there are any &quot;implicit terms&quot;, which are terms that should be brought into the latest</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-comment">-- typechecked Unsion file and re-typechecked, which also re-discovers components.</span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">-- The running example here will be one in which the current namespace already has the following terms stored.</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-comment">-- (For simplicity, we will ignore the limitation that mutually recursive definitions must be top-level arrows;</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- pretend this is Haskell's let).</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-comment">--   ping = pong + 1   (reference = #pingpong.ping)</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-comment">--   pong = ping + 2   (reference = #pingpong.pong)</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-comment">--   wham = pong + 3   (reference = #wham)</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-comment">-- The user re-defines &quot;ping&quot; in their scratch file thus:</span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">--   ping = wham + 4   (reference = #newping)</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-comment">-- Note that, pre-update, we had two components [ping,pong] and [wham]. But after the update, since the new `ping`</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-comment">-- refers to the old `wham`, which refers to the old `pong`, which refers to the old `ping`, we really want to end</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-comment">-- up with a single component in the end, [ping,pong,wham].</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-comment">-- First, compute an initial slurp, which will identify the initial set of definitions we are updating ({&quot;ping&quot;}).</span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-comment">-- Also, this will be the slurp that we fall back on, in case re-typechecking another Unison file with implicit</span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-comment">-- terms in it fails.</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690703"><span class="annot"><span class="annottext">slurp0 :: SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var hs-var">slurp0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; SlurpResult
</span><a href="#local-6989586621679690716"><span class="hs-identifier hs-var">slurp</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690705"><span class="hs-identifier hs-var">unisonFile0</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- Grab some interim info out of the original slurp.</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-comment">--   &quot;ping&quot; =&gt; (#newping, Nothing, &lt;#wham + 4&gt;, &lt;Nat&gt;)</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690702"><span class="hs-identifier hs-type">nameToInterimInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">WatchKind</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>        </span><span id="local-6989586621679690702"><span class="annot"><span class="annottext">nameToInterimInfo :: Map
  Symbol
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690702"><span class="hs-identifier hs-var hs-var">nameToInterimInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-258"></span><span>          </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map
     Symbol
     (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (TermReferenceId, Maybe [Char], Term v a, Type v a)
</span><span class="hs-identifier hs-var hs-var">UF.hashTermsId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var">slurp0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- Get the set of names that are being updated.</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-comment">--   { &quot;ping&quot; }</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690700"><span class="hs-identifier hs-type">namesBeingUpdated</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span>
</span><span id="line-266"></span><span>        </span><span id="local-6989586621679690700"><span class="annot"><span class="annottext">namesBeingUpdated :: Set Symbol
</span><a href="#local-6989586621679690700"><span class="hs-identifier hs-var hs-var">namesBeingUpdated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-267"></span><span>          </span><span class="annot"><span class="annottext">SlurpComponent -&gt; Set Symbol
</span><a href="Unison.Codebase.Editor.SlurpComponent.html#%24sel%3Aterms%3ASlurpComponent"><span class="hs-identifier hs-var hs-var">SC.terms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; SlurpComponent
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3Aupdates%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.updates</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var">slurp0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-comment">-- Associate each such name with the set of old (already in the codebase) and new (in the scratch file) references</span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-comment">-- that it's associated with.</span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-comment">--   &quot;ping&quot; =&gt; ({ #pingpong.ping }, #newping)</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690699"><span class="hs-identifier hs-type">updatedNameToRefs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>        </span><span id="local-6989586621679690699"><span class="annot"><span class="annottext">updatedNameToRefs :: Map Symbol (Set Reference, TermReferenceId)
</span><a href="#local-6989586621679690699"><span class="hs-identifier hs-var hs-var">updatedNameToRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-277"></span><span>          </span><span class="annot"><span class="annottext">(Symbol -&gt; (Set Reference, TermReferenceId))
-&gt; Set Symbol -&gt; Map Symbol (Set Reference, TermReferenceId)
forall k a. (k -&gt; a) -&gt; Set k -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromSet</span></span><span>
</span><span id="line-278"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679690697"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690697"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-279"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Symbol
-&gt; Map
     Symbol
     (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
-&gt; Maybe
     (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690697"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  Symbol
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690702"><span class="hs-identifier hs-var">nameToInterimInfo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-280"></span><span>                  </span><span class="annot"><span class="annottext">Maybe
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; (Set Reference, TermReferenceId)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E798907&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;no interim ref for name&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690696"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690696"><span class="hs-identifier hs-var">interimRef</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe [Char]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Set Reference
</span><a href="#local-6989586621679690708"><span class="hs-identifier hs-var">nameToTermRefs</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690697"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690696"><span class="hs-identifier hs-var">interimRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>            </span><span class="annot"><span class="annottext">Set Symbol
</span><a href="#local-6989586621679690700"><span class="hs-identifier hs-var">namesBeingUpdated</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-comment">-- Identify all of the implicit terms, which are:</span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-comment">--   - Both:</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-comment">--     - Either:</span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-comment">--         - (A) A component-mate of a term that's being updated.</span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-comment">--         - Both:</span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-comment">--           - (B) A dependent of a term that's being updated.</span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-comment">--           - (C) A dependency of the new term.</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-comment">--     - (D) Not being updated.</span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- FIXME Additionally, we have one more temporary requirement.</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-comment">--   - (E) The term has at least one unambiguous (unconflicted) name in the codebase.</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- This works around two fixable issues:</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-comment">--   1. If the term has no names in the namespace, then we can't successfully put it into the Unison file anyway and</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-comment">--      forward it through the typecheck + slurp process, because slurping currently assumes that it can freely</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-comment">--      convert back-and-forth between vars and names.</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">--   2. If the term has only ambiguous/conflicted names, then putting one of them in the Unison file and proceeding</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">--      to do an update would have the undesirable side-effect of resolving the conflict.</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- FIXME don't bother for type-changing updates</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- In our running example, the full list of component-mates (A) of the terms being updated is:</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">--   [ #pingpong.ping, #pingpong.pong ]</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- And because #pingpong.ping is being updated, due to (D), only #pingpong.pong remains.</span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- Furthermore, #wham is both a dependent of #pingpong (B), and a dependency of #newping, so it too is an implicit</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">-- term.</span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">--   #pingpong.pong =&gt; (&lt;#pingpong.ping + 2&gt;, &quot;pong&quot;)</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">--   #wham          =&gt; (&lt;#pingpong.pong + 3&gt;, &quot;wham&quot;)</span><span>
</span><span id="line-323"></span><span>    </span><span id="local-6989586621679690695"><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690695"><span class="hs-identifier hs-var">implicitTerms</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><span class="annottext">IO (Map TermReferenceId (Term Symbol Ann, Symbol))
-&gt; Cli (Map TermReferenceId (Term Symbol Ann, Symbol))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>        </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; (Connection
    -&gt; IO (Map TermReferenceId (Term Symbol Ann, Symbol)))
-&gt; IO (Map TermReferenceId (Term Symbol Ann, Symbol))
forall (m :: * -&gt; *) v a.
Codebase m v a -&gt; forall x. (Connection -&gt; m x) -&gt; m x
</span><span class="hs-identifier hs-var hs-var">Codebase.withConnection</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690706"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679690693"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679690693"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-326"></span><span>          </span><span class="annot"><span class="annottext">Connection
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
-&gt; IO (Map TermReferenceId (Term Symbol Ann, Symbol))
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Connection -&gt; Transaction a -&gt; m a
</span><span class="hs-identifier hs-var">Sqlite.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679690693"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-327"></span><span>            </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-328"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-329"></span><span>            </span><span class="hs-comment">--   #pingpong =&gt; #newping</span><span>
</span><span id="line-330"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690691"><span class="hs-identifier hs-type">oldHashToInterimHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-331"></span><span>                </span><span id="local-6989586621679690691"><span class="annot"><span class="annottext">oldHashToInterimHash :: Map Hash Hash
</span><a href="#local-6989586621679690691"><span class="hs-identifier hs-var hs-var">oldHashToInterimHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>                  </span><span class="annot"><span class="annottext">Map Symbol (Set Reference, TermReferenceId)
</span><a href="#local-6989586621679690699"><span class="hs-identifier hs-var">updatedNameToRefs</span></a></span><span> </span><span class="annot"><span class="annottext">Map Symbol (Set Reference, TermReferenceId)
-&gt; (Map Symbol (Set Reference, TermReferenceId) -&gt; Map Hash Hash)
-&gt; Map Hash Hash
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Set Reference, TermReferenceId) -&gt; Map Hash Hash)
-&gt; Map Symbol (Set Reference, TermReferenceId) -&gt; Map Hash Hash
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690689"><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690689"><span class="hs-identifier hs-var">oldRefs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690688"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690688"><span class="hs-identifier hs-var">interimRef</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-333"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690687"><span class="annot"><span class="annottext">interimHash :: Hash
</span><a href="#local-6989586621679690687"><span class="hs-identifier hs-var hs-var">interimHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; Hash
</span><span class="hs-identifier hs-var">Reference.idToHash</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690688"><span class="hs-identifier hs-var">interimRef</span></a></span><span>
</span><span id="line-334"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[(Hash, Hash)] -&gt; Map Hash Hash
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Hash, Hash)] -&gt; Map Hash Hash)
-&gt; [(Hash, Hash)] -&gt; Map Hash Hash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-335"></span><span>                          </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690689"><span class="hs-identifier hs-var">oldRefs</span></a></span><span>
</span><span id="line-336"></span><span>                            </span><span class="annot"><span class="annottext">Set Reference -&gt; (Set Reference -&gt; [Reference]) -&gt; [Reference]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span>
</span><span id="line-337"></span><span>                            </span><span class="annot"><span class="annottext">[Reference] -&gt; ([Reference] -&gt; [Hash]) -&gt; [Hash]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Maybe Hash) -&gt; [Reference] -&gt; [Hash]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Maybe Hash
</span><span class="hs-identifier hs-var">Reference.toHash</span></span><span>
</span><span id="line-338"></span><span>                            </span><span class="annot"><span class="annottext">[Hash] -&gt; ([Hash] -&gt; [(Hash, Hash)]) -&gt; [(Hash, Hash)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; (Hash, Hash)) -&gt; [Hash] -&gt; [(Hash, Hash)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690687"><span class="hs-identifier hs-var">interimHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690683"><span class="hs-identifier hs-type">hashToImplicitTerms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>                </span><span id="local-6989586621679690683"><span class="annot"><span class="annottext">hashToImplicitTerms :: Hash -&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
</span><a href="#local-6989586621679690683"><span class="hs-identifier hs-var hs-var">hashToImplicitTerms</span></a></span></span><span> </span><span id="local-6989586621679690682"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690682"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-342"></span><span>                  </span><span class="hs-comment">-- Running example (for `oldHash` iteration):</span><span>
</span><span id="line-343"></span><span>                  </span><span class="hs-comment">--</span><span>
</span><span id="line-344"></span><span>                  </span><span class="hs-comment">--   [ (&lt;#pingpong.pong + 1&gt;, &lt;Nat&gt;),</span><span>
</span><span id="line-345"></span><span>                  </span><span class="hs-comment">--     (&lt;#pingpong.ping + 2&gt;, &lt;Nat&gt;)</span><span>
</span><span id="line-346"></span><span>                  </span><span class="hs-comment">--   ]</span><span>
</span><span id="line-347"></span><span>                  </span><span id="local-6989586621679690681"><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621679690681"><span class="hs-identifier hs-var">terms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Hash -&gt; Transaction [(Term Symbol Ann, Type Symbol Ann)]
forall (m :: * -&gt; *) v a.
HasCallStack =&gt;
Codebase m v a -&gt; Hash -&gt; Transaction [(Term v a, Type v a)]
</span><span class="hs-identifier hs-var">Codebase.unsafeGetTermComponent</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690706"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690682"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-348"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690679"><span class="hs-identifier hs-type">keep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span>
</span><span id="line-349"></span><span>                      </span><span id="local-6989586621679690679"><span class="annot"><span class="annottext">keep :: TermReferenceId -&gt; Maybe Symbol
</span><a href="#local-6989586621679690679"><span class="hs-identifier hs-var hs-var">keep</span></a></span></span><span> </span><span id="local-6989586621679690678"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690678"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-350"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; Bool
</span><a href="#local-6989586621679690677"><span class="hs-identifier hs-var">notBeingUpdated</span></a></span><span> </span><span class="annot"><span class="annottext">Set Symbol
</span><a href="#local-6989586621679690676"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-351"></span><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Symbol -&gt; Bool) -&gt; Set Symbol -&gt; Maybe Symbol
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Foldable.find</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Bool
</span><a href="#local-6989586621679690674"><span class="hs-identifier hs-var">nameIsUnconflicted</span></a></span><span> </span><span class="annot"><span class="annottext">Set Symbol
</span><a href="#local-6989586621679690676"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-comment">-- (E)</span><span>
</span><span id="line-352"></span><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Symbol
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-353"></span><span>                        </span><span class="hs-keyword">where</span><span>
</span><span id="line-354"></span><span>                          </span><span class="hs-comment">-- (D) After getting the entire component of `oldHash`, which has at least one member being</span><span>
</span><span id="line-355"></span><span>                          </span><span class="hs-comment">-- updated, we want to keep only the members that are *not* being updated (i.e. those who have</span><span>
</span><span id="line-356"></span><span>                          </span><span class="hs-comment">-- no name that is being updated).</span><span>
</span><span id="line-357"></span><span>                          </span><span class="hs-comment">--</span><span>
</span><span id="line-358"></span><span>                          </span><span class="hs-comment">-- Running example, first time through (processing #pingpong.ping):</span><span>
</span><span id="line-359"></span><span>                          </span><span class="hs-comment">--</span><span>
</span><span id="line-360"></span><span>                          </span><span class="hs-comment">--   Set.disjoint { &quot;ping&quot; } { &quot;ping&quot; } is false, so don't add to the map.</span><span>
</span><span id="line-361"></span><span>                          </span><span class="hs-comment">--</span><span>
</span><span id="line-362"></span><span>                          </span><span class="hs-comment">-- Running example, second time through (processing #pingpong.pong):</span><span>
</span><span id="line-363"></span><span>                          </span><span class="hs-comment">--</span><span>
</span><span id="line-364"></span><span>                          </span><span class="hs-comment">--   Set.disjoint { &quot;ping&quot; } { &quot;pong&quot; } is true, so add</span><span>
</span><span id="line-365"></span><span>                          </span><span class="hs-comment">--   #pingpong.pong =&gt; (&lt;#pingpong.ping + 2&gt;, { &quot;pong&quot; })) to the map.</span><span>
</span><span id="line-366"></span><span>                          </span><span id="local-6989586621679690677"><span class="annot"><span class="annottext">notBeingUpdated :: Set Symbol -&gt; Bool
</span><a href="#local-6989586621679690677"><span class="hs-identifier hs-var hs-var">notBeingUpdated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; Set Symbol -&gt; Bool
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.disjoint</span></span><span> </span><span class="annot"><span class="annottext">Set Symbol
</span><a href="#local-6989586621679690700"><span class="hs-identifier hs-var">namesBeingUpdated</span></a></span><span>
</span><span id="line-367"></span><span>                          </span><span id="local-6989586621679690674"><span class="annot"><span class="annottext">nameIsUnconflicted :: Symbol -&gt; Bool
</span><a href="#local-6989586621679690674"><span class="hs-identifier hs-var hs-var">nameIsUnconflicted</span></a></span></span><span> </span><span id="local-6989586621679690672"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690672"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; Int
forall a. Set a -&gt; Int
</span><span class="hs-identifier hs-var">Set.size</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Set Reference
</span><a href="#local-6989586621679690708"><span class="hs-identifier hs-var">nameToTermRefs</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690672"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-368"></span><span>                          </span><span id="local-6989586621679690676"><span class="annot"><span class="annottext">names :: Set Symbol
</span><a href="#local-6989586621679690676"><span class="hs-identifier hs-var hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; Set Symbol
</span><a href="#local-6989586621679690711"><span class="hs-identifier hs-var">termRefToNames</span></a></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690678"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-369"></span><span>                  </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Map TermReferenceId (Term Symbol Ann, Symbol)
 -&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol)))
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-370"></span><span>                    </span><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621679690681"><span class="hs-identifier hs-var">terms</span></a></span><span>
</span><span id="line-371"></span><span>                      </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-372"></span><span>                      </span><span class="hs-comment">--</span><span>
</span><span id="line-373"></span><span>                      </span><span class="hs-comment">--   [ (#pingpong.ping, (&lt;#pingpong.pong + 1&gt;, &lt;Nat&gt;)),</span><span>
</span><span id="line-374"></span><span>                      </span><span class="hs-comment">--     (#pingpong.pong, (&lt;#pingpong.ping + 2&gt;, &lt;Nat&gt;))</span><span>
</span><span id="line-375"></span><span>                      </span><span class="hs-comment">--   ]</span><span>
</span><span id="line-376"></span><span>                      </span><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
-&gt; ([(Term Symbol Ann, Type Symbol Ann)]
    -&gt; [(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))])
-&gt; [(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Hash
-&gt; [(Term Symbol Ann, Type Symbol Ann)]
-&gt; [(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
forall a. Hash -&gt; [a] -&gt; [(TermReferenceId, a)]
</span><span class="hs-identifier hs-var">Reference.componentFor</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690682"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-377"></span><span>                      </span><span class="annot"><span class="annottext">[(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
-&gt; ([(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
    -&gt; Map TermReferenceId (Term Symbol Ann, Symbol))
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Map TermReferenceId (Term Symbol Ann, Symbol)
 -&gt; (TermReferenceId, (Term Symbol Ann, Type Symbol Ann))
 -&gt; Map TermReferenceId (Term Symbol Ann, Symbol))
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; [(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">List.foldl'</span></span><span>
</span><span id="line-378"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679690669"><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690669"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690668"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690668"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690667"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690667"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690666"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690666"><span class="hs-identifier hs-var">_typ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-379"></span><span>                            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; Maybe Symbol
</span><a href="#local-6989586621679690679"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690668"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-380"></span><span>                              </span><span class="annot"><span class="annottext">Maybe Symbol
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690669"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-381"></span><span>                              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690665"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690665"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermReferenceId
-&gt; (Term Symbol Ann, Symbol)
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690668"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690667"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690665"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690669"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-382"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>                        </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Map Hash Hash -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.null</span></span><span> </span><span class="annot"><span class="annottext">Map Hash Hash
</span><a href="#local-6989586621679690691"><span class="hs-identifier hs-var">oldHashToInterimHash</span></a></span><span>
</span><span id="line-386"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-387"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>                </span><span class="annot"><span class="annottext">Transaction
  (Either
     (Map TermReferenceId (Term Symbol Ann, Symbol))
     (Map TermReferenceId (Term Symbol Ann, Symbol)))
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
forall a. Transaction (Either a a) -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.savepoint</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-389"></span><span>                  </span><span class="hs-comment">-- Compute the actual interim decl/term components in the latest typechecked file. These aren't quite</span><span>
</span><span id="line-390"></span><span>                  </span><span class="hs-comment">-- given in the unison file structure itself - in the `topLevelComponents'` field we have the</span><span>
</span><span id="line-391"></span><span>                  </span><span class="hs-comment">-- components in some arbitrary order (I *think*), each tagged with its stringy name, and in the</span><span>
</span><span id="line-392"></span><span>                  </span><span class="hs-comment">-- `hashTermsId` field we have all of the individual terms organized by reference.</span><span>
</span><span id="line-393"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690660"><span class="hs-identifier hs-type">interimDeclComponents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-394"></span><span>                      </span><span id="local-6989586621679690660"><span class="annot"><span class="annottext">interimDeclComponents :: [(Hash, [Decl Symbol Ann])]
</span><a href="#local-6989586621679690660"><span class="hs-identifier hs-var hs-var">interimDeclComponents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>                        </span><span class="annot"><span class="annottext">(TypecheckedUnisonFile Symbol Ann
 -&gt; Map Symbol (TermReferenceId, DataDeclaration Symbol Ann))
-&gt; (DataDeclaration Symbol Ann -&gt; Decl Symbol Ann)
-&gt; [(Hash, [Decl Symbol Ann])]
forall decl.
(TypecheckedUnisonFile Symbol Ann
 -&gt; Map Symbol (TermReferenceId, decl))
-&gt; (decl -&gt; Decl Symbol Ann) -&gt; [(Hash, [Decl Symbol Ann])]
</span><a href="#local-6989586621679690659"><span class="hs-identifier hs-var">decls</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (TermReferenceId, DataDeclaration Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (TermReferenceId, DataDeclaration v a)
</span><span class="hs-identifier hs-var hs-var">UF.dataDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">[(Hash, [Decl Symbol Ann])]
-&gt; [(Hash, [Decl Symbol Ann])] -&gt; [(Hash, [Decl Symbol Ann])]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(TypecheckedUnisonFile Symbol Ann
 -&gt; Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann))
-&gt; (EffectDeclaration Symbol Ann -&gt; Decl Symbol Ann)
-&gt; [(Hash, [Decl Symbol Ann])]
forall decl.
(TypecheckedUnisonFile Symbol Ann
 -&gt; Map Symbol (TermReferenceId, decl))
-&gt; (decl -&gt; Decl Symbol Ann) -&gt; [(Hash, [Decl Symbol Ann])]
</span><a href="#local-6989586621679690659"><span class="hs-identifier hs-var">decls</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (TermReferenceId, EffectDeclaration v a)
</span><span class="hs-identifier hs-var hs-var">UF.effectDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">EffectDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span>
</span><span id="line-396"></span><span>                        </span><span class="hs-keyword">where</span><span>
</span><span id="line-397"></span><span>                          </span><span id="local-6989586621679691033"><span class="annot"><a href="#local-6989586621679690659"><span class="hs-identifier hs-type">decls</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-398"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679691033"><span class="hs-identifier hs-type">decl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-399"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679691033"><span class="hs-identifier hs-type">decl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-400"></span><span>                            </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-401"></span><span>                          </span><span id="local-6989586621679690659"><span class="annot"><span class="annottext">decls :: (TypecheckedUnisonFile Symbol Ann
 -&gt; Map Symbol (TermReferenceId, decl))
-&gt; (decl -&gt; Decl Symbol Ann) -&gt; [(Hash, [Decl Symbol Ann])]
</span><a href="#local-6989586621679690659"><span class="hs-identifier hs-var hs-var">decls</span></a></span></span><span> </span><span id="local-6989586621679690656"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (TermReferenceId, decl)
</span><a href="#local-6989586621679690656"><span class="hs-identifier hs-var">project</span></a></span></span><span> </span><span id="local-6989586621679690655"><span class="annot"><span class="annottext">decl -&gt; Decl Symbol Ann
</span><a href="#local-6989586621679690655"><span class="hs-identifier hs-var">inject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>                            </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var">slurp0</span></a></span><span>
</span><span id="line-403"></span><span>                              </span><span class="annot"><span class="annottext">SlurpResult
-&gt; (SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann)
-&gt; TypecheckedUnisonFile Symbol Ann
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span>
</span><span id="line-404"></span><span>                              </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; (TypecheckedUnisonFile Symbol Ann
    -&gt; Map Symbol (TermReferenceId, decl))
-&gt; Map Symbol (TermReferenceId, decl)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (TermReferenceId, decl)
</span><a href="#local-6989586621679690656"><span class="hs-identifier hs-var">project</span></a></span><span>
</span><span id="line-405"></span><span>                              </span><span class="annot"><span class="annottext">Map Symbol (TermReferenceId, decl)
-&gt; (Map Symbol (TermReferenceId, decl)
    -&gt; [(TermReferenceId, decl)])
-&gt; [(TermReferenceId, decl)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map Symbol (TermReferenceId, decl) -&gt; [(TermReferenceId, decl)]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">Map.elems</span></span><span>
</span><span id="line-406"></span><span>                              </span><span class="annot"><span class="annottext">[(TermReferenceId, decl)]
-&gt; ([(TermReferenceId, decl)] -&gt; [(Hash, [decl])])
-&gt; [(Hash, [decl])]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(TermReferenceId, decl)] -&gt; [(Hash, [decl])]
forall a. [(TermReferenceId, a)] -&gt; [(Hash, [a])]
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#recomponentize"><span class="hs-identifier hs-var">recomponentize</span></a></span><span>
</span><span id="line-407"></span><span>                              </span><span class="annot"><span class="annottext">[(Hash, [decl])]
-&gt; ([(Hash, [decl])] -&gt; [(Hash, [Decl Symbol Ann])])
-&gt; [(Hash, [Decl Symbol Ann])]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  [(Hash, [decl])] [(Hash, [Decl Symbol Ann])] decl (Decl Symbol Ann)
-&gt; (decl -&gt; Decl Symbol Ann)
-&gt; [(Hash, [decl])]
-&gt; [(Hash, [Decl Symbol Ann])]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Hash, [decl]) -&gt; Identity (Hash, [Decl Symbol Ann]))
-&gt; [(Hash, [decl])] -&gt; Identity [(Hash, [Decl Symbol Ann])]
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span> </span><span class="annot"><span class="annottext">(((Hash, [decl]) -&gt; Identity (Hash, [Decl Symbol Ann]))
 -&gt; [(Hash, [decl])] -&gt; Identity [(Hash, [Decl Symbol Ann])])
-&gt; ((decl -&gt; Identity (Decl Symbol Ann))
    -&gt; (Hash, [decl]) -&gt; Identity (Hash, [Decl Symbol Ann]))
-&gt; ASetter
     [(Hash, [decl])] [(Hash, [Decl Symbol Ann])] decl (Decl Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([decl] -&gt; Identity [Decl Symbol Ann])
-&gt; (Hash, [decl]) -&gt; Identity (Hash, [Decl Symbol Ann])
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">(([decl] -&gt; Identity [Decl Symbol Ann])
 -&gt; (Hash, [decl]) -&gt; Identity (Hash, [Decl Symbol Ann]))
-&gt; ((decl -&gt; Identity (Decl Symbol Ann))
    -&gt; [decl] -&gt; Identity [Decl Symbol Ann])
-&gt; (decl -&gt; Identity (Decl Symbol Ann))
-&gt; (Hash, [decl])
-&gt; Identity (Hash, [Decl Symbol Ann])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(decl -&gt; Identity (Decl Symbol Ann))
-&gt; [decl] -&gt; Identity [Decl Symbol Ann]
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">decl -&gt; Decl Symbol Ann
</span><a href="#local-6989586621679690655"><span class="hs-identifier hs-var">inject</span></a></span><span>
</span><span id="line-408"></span><span>                      </span><span class="annot"><a href="#local-6989586621679690649"><span class="hs-identifier hs-type">interimTermComponents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-409"></span><span>                      </span><span id="local-6989586621679690649"><span class="annot"><span class="annottext">interimTermComponents :: [(Hash, [(Term Symbol Ann, Type Symbol Ann)])]
</span><a href="#local-6989586621679690649"><span class="hs-identifier hs-var hs-var">interimTermComponents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>                        </span><span class="annot"><span class="annottext">Map
  Symbol
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690702"><span class="hs-identifier hs-var">nameToInterimInfo</span></a></span><span>
</span><span id="line-411"></span><span>                          </span><span class="annot"><span class="annottext">Map
  Symbol
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
-&gt; (Map
      Symbol
      (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
    -&gt; [(TermReferenceId, Maybe [Char], Term Symbol Ann,
         Type Symbol Ann)])
-&gt; [(TermReferenceId, Maybe [Char], Term Symbol Ann,
     Type Symbol Ann)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map
  Symbol
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
-&gt; [(TermReferenceId, Maybe [Char], Term Symbol Ann,
     Type Symbol Ann)]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">Map.elems</span></span><span>
</span><span id="line-412"></span><span>                          </span><span class="annot"><span class="annottext">[(TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)]
-&gt; ([(TermReferenceId, Maybe [Char], Term Symbol Ann,
      Type Symbol Ann)]
    -&gt; [(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))])
-&gt; [(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
 -&gt; (TermReferenceId, (Term Symbol Ann, Type Symbol Ann)))
-&gt; [(TermReferenceId, Maybe [Char], Term Symbol Ann,
     Type Symbol Ann)]
-&gt; [(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690648"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690648"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690647"><span class="annot"><span class="annottext">Maybe [Char]
</span><a href="#local-6989586621679690647"><span class="hs-identifier hs-var">_wk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690646"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690646"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690645"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690645"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690648"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690646"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690645"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>                          </span><span class="annot"><span class="annottext">[(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
-&gt; ([(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
    -&gt; Map Hash (Map Pos (Term Symbol Ann, Type Symbol Ann)))
-&gt; Map Hash (Map Pos (Term Symbol Ann, Type Symbol Ann))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(TermReferenceId, (Term Symbol Ann, Type Symbol Ann))]
-&gt; Map Hash (Map Pos (Term Symbol Ann, Type Symbol Ann))
forall a. [(TermReferenceId, a)] -&gt; Map Hash (Map Pos a)
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#componentize"><span class="hs-identifier hs-var">componentize</span></a></span><span>
</span><span id="line-414"></span><span>                          </span><span class="annot"><span class="annottext">Map Hash (Map Pos (Term Symbol Ann, Type Symbol Ann))
-&gt; (Map Hash (Map Pos (Term Symbol Ann, Type Symbol Ann))
    -&gt; [(Hash, [(Term Symbol Ann, Type Symbol Ann)])])
-&gt; [(Hash, [(Term Symbol Ann, Type Symbol Ann)])]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map Hash (Map Pos (Term Symbol Ann, Type Symbol Ann))
-&gt; [(Hash, [(Term Symbol Ann, Type Symbol Ann)])]
forall a. Map Hash (Map Pos a) -&gt; [(Hash, [a])]
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#uncomponentize"><span class="hs-identifier hs-var">uncomponentize</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>                  </span><span class="hs-comment">-- Insert each interim component into the codebase proper. Note: this relies on the codebase interface</span><span>
</span><span id="line-417"></span><span>                  </span><span class="hs-comment">-- being smart enough to handle out-of-order components (i.e. inserting a dependent before a</span><span>
</span><span id="line-418"></span><span>                  </span><span class="hs-comment">-- dependency). That's currently how the codebase interface works, but maybe in the future it'll grow</span><span>
</span><span id="line-419"></span><span>                  </span><span class="hs-comment">-- a precondition that components can only be inserted after their dependencies.</span><span>
</span><span id="line-420"></span><span>                  </span><span class="annot"><span class="annottext">[(Hash, [Decl Symbol Ann])]
-&gt; ((Hash, [Decl Symbol Ann]) -&gt; Transaction ()) -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(Hash, [Decl Symbol Ann])]
</span><a href="#local-6989586621679690660"><span class="hs-identifier hs-var">interimDeclComponents</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690641"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690641"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690640"><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621679690640"><span class="hs-identifier hs-var">decls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Hash -&gt; [Decl Symbol Ann] -&gt; Transaction ()
forall (m :: * -&gt; *) v a.
Codebase m v a -&gt; Hash -&gt; [Decl v a] -&gt; Transaction ()
</span><span class="hs-identifier hs-var hs-var">Codebase.putTypeDeclarationComponent</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690706"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690641"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621679690640"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-421"></span><span>                  </span><span class="annot"><span class="annottext">[(Hash, [(Term Symbol Ann, Type Symbol Ann)])]
-&gt; ((Hash, [(Term Symbol Ann, Type Symbol Ann)]) -&gt; Transaction ())
-&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(Hash, [(Term Symbol Ann, Type Symbol Ann)])]
</span><a href="#local-6989586621679690649"><span class="hs-identifier hs-var">interimTermComponents</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690638"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690638"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690637"><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621679690637"><span class="hs-identifier hs-var">terms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Hash -&gt; [(Term Symbol Ann, Type Symbol Ann)] -&gt; Transaction ()
forall (m :: * -&gt; *) v a.
Codebase m v a -&gt; Hash -&gt; [(Term v a, Type v a)] -&gt; Transaction ()
</span><span class="hs-identifier hs-var hs-var">Codebase.putTermComponent</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690706"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690638"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621679690637"><span class="hs-identifier hs-var">terms</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span>                  </span><span id="local-6989586621679690635"><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690635"><span class="hs-identifier hs-var">terms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-424"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690634"><span class="hs-identifier hs-type">interimHashes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-425"></span><span>                        </span><span id="local-6989586621679690634"><span class="annot"><span class="annottext">interimHashes :: Set Hash
</span><a href="#local-6989586621679690634"><span class="hs-identifier hs-var hs-var">interimHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; Set Hash
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Hash, [(Term Symbol Ann, Type Symbol Ann)]) -&gt; Hash)
-&gt; [(Hash, [(Term Symbol Ann, Type Symbol Ann)])] -&gt; [Hash]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Hash, [(Term Symbol Ann, Type Symbol Ann)]) -&gt; Hash
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Hash, [(Term Symbol Ann, Type Symbol Ann)])]
</span><a href="#local-6989586621679690649"><span class="hs-identifier hs-var">interimTermComponents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Map Hash Hash -&gt; [(Hash, Hash)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map Hash Hash
</span><a href="#local-6989586621679690691"><span class="hs-identifier hs-var">oldHashToInterimHash</span></a></span><span> </span><span class="annot"><span class="annottext">[(Hash, Hash)]
-&gt; ([(Hash, Hash)]
    -&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol)))
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Hash, Hash)
 -&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol)))
-&gt; [(Hash, Hash)]
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
forall (m :: * -&gt; *) (f :: * -&gt; *) b a.
(Monad m, Foldable f, Monoid b) =&gt;
(a -&gt; m b) -&gt; f a -&gt; m b
</span><span class="hs-identifier hs-var">foldMapM</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690632"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690632"><span class="hs-identifier hs-var">oldHash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690631"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690631"><span class="hs-identifier hs-var">interimHash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>                          </span><span id="local-6989586621679690630"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621679690630"><span class="hs-identifier hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-428"></span><span>                            </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Maybe ObjectId)
</span><span class="hs-identifier hs-var">Queries.loadObjectIdForAnyHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690632"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe ObjectId)
-&gt; (Maybe ObjectId -&gt; Transaction (Set Hash))
-&gt; Transaction (Set Hash)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-429"></span><span>                              </span><span class="hs-comment">-- better would be to short-circuit all the way to the user and say, actually we can't</span><span>
</span><span id="line-430"></span><span>                              </span><span class="hs-comment">-- perform this update at all, due to some intervening delete (e.g. some sort of</span><span>
</span><span id="line-431"></span><span>                              </span><span class="hs-comment">-- hard-reset or garbage collection on the codebase)</span><span>
</span><span id="line-432"></span><span>                              </span><span class="annot"><span class="annottext">Maybe ObjectId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Transaction (Set Hash)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span>
</span><span id="line-433"></span><span>                              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690627"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621679690627"><span class="hs-identifier hs-var">oldOid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-434"></span><span>                                </span><span id="local-6989586621679690626"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621679690626"><span class="hs-identifier hs-var">interimOid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">Queries.expectObjectIdForPrimaryHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690631"><span class="hs-identifier hs-var">interimHash</span></a></span><span>
</span><span id="line-435"></span><span>                                </span><span id="local-6989586621679690624"><span class="annot"><span class="annottext">Set ObjectId
</span><a href="#local-6989586621679690624"><span class="hs-identifier hs-var">betweenOids</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; ObjectId -&gt; Transaction (Set ObjectId)
</span><span class="hs-identifier hs-var">Queries.getDependenciesBetweenTerms</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621679690626"><span class="hs-identifier hs-var">interimOid</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621679690627"><span class="hs-identifier hs-var">oldOid</span></a></span><span>
</span><span id="line-436"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Hash -&gt; Set Hash -&gt; Set Hash
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">Set.\\</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621679690634"><span class="hs-identifier hs-var">interimHashes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Set Hash -&gt; Set Hash)
-&gt; Transaction (Set Hash) -&gt; Transaction (Set Hash)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(ObjectId -&gt; Transaction Hash)
-&gt; Set ObjectId -&gt; Transaction (Set Hash)
forall (f :: * -&gt; *) b a.
(Applicative f, Ord b) =&gt;
(a -&gt; f b) -&gt; Set a -&gt; f (Set b)
</span><span class="hs-identifier hs-var">Set.traverse</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Transaction Hash
</span><span class="hs-identifier hs-var">Queries.expectPrimaryHashByObjectId</span></span><span> </span><span class="annot"><span class="annottext">Set ObjectId
</span><a href="#local-6989586621679690624"><span class="hs-identifier hs-var">betweenOids</span></a></span><span>
</span><span id="line-437"></span><span>                          </span><span class="annot"><span class="annottext">(Hash
 -&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol)))
-&gt; [Hash]
-&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
forall (m :: * -&gt; *) (f :: * -&gt; *) b a.
(Monad m, Foldable f, Monoid b) =&gt;
(a -&gt; m b) -&gt; f a -&gt; m b
</span><span class="hs-identifier hs-var">foldMapM</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Map TermReferenceId (Term Symbol Ann, Symbol))
</span><a href="#local-6989586621679690683"><span class="hs-identifier hs-var">hashToImplicitTerms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690632"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; [Hash] -&gt; [Hash]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621679690630"><span class="hs-identifier hs-var">hashes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>                  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; Either
     (Map TermReferenceId (Term Symbol Ann, Symbol))
     (Map TermReferenceId (Term Symbol Ann, Symbol))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690635"><span class="hs-identifier hs-var">terms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- left = rollback to savepoint</span><span>
</span><span id="line-439"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol) -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.null</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690695"><span class="hs-identifier hs-var">implicitTerms</span></a></span><span>
</span><span id="line-440"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SlurpResult -&gt; Cli SlurpResult
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var">slurp0</span></a></span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-comment">-- We found some implicit terms, so it's time to:</span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-comment">--   1. Reconstruct a new unison file out of the latest typechecked unison file, plus all of the implicit terms,</span><span>
</span><span id="line-445"></span><span>        </span><span class="hs-comment">--      taking care to adjust their references to each other, so that the proper components are discovered.</span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-comment">--   2. Re-typecheck, and if it that succeeds, use the resulting typechecked unison file and slurp.</span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>        </span><span class="hs-comment">-- Remap the references contained in each implicit term, then add back in the slurped interim terms and unhash</span><span>
</span><span id="line-450"></span><span>        </span><span class="hs-comment">-- the collection. The unhashing process will invent a fresh variable name for each term.</span><span>
</span><span id="line-451"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-452"></span><span>        </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-453"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-comment">--   #newping       =&gt; (&quot;fresh1&quot;, &lt;&quot;fresh3&quot; + 4&gt;)</span><span>
</span><span id="line-455"></span><span>        </span><span class="hs-comment">--   #pingpong.pong =&gt; (&quot;fresh2&quot;, &lt;&quot;fresh1&quot; + 2&gt;)</span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-comment">--   #wham          =&gt; (&quot;fresh3&quot;, &lt;&quot;fresh2&quot; + 3&gt;)</span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690619"><span class="hs-identifier hs-type">refToGeneratedNameAndTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-458"></span><span>            </span><span id="local-6989586621679690619"><span class="annot"><span class="annottext">refToGeneratedNameAndTerm :: Map TermReferenceId (Symbol, Term Symbol Ann)
</span><a href="#local-6989586621679690619"><span class="hs-identifier hs-var hs-var">refToGeneratedNameAndTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-459"></span><span>              </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-460"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-461"></span><span>              </span><span class="hs-comment">--   #pingpong.pong =&gt; (&lt;#pingpong.ping + 2&gt;, { &quot;pong&quot; })</span><span>
</span><span id="line-462"></span><span>              </span><span class="hs-comment">--   #wham          =&gt; (&lt;#pingpong.pong + 3&gt;, { &quot;wham&quot; })</span><span>
</span><span id="line-463"></span><span>              </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690695"><span class="hs-identifier hs-var">implicitTerms</span></a></span><span>
</span><span id="line-464"></span><span>                </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-465"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-466"></span><span>                </span><span class="hs-comment">--   #pingpong.pong =&gt; &lt;#newping + 2&gt;</span><span>
</span><span id="line-467"></span><span>                </span><span class="hs-comment">--   #wham          =&gt; &lt;#pingpong.pong + 3&gt;</span><span>
</span><span id="line-468"></span><span>                </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; (Map TermReferenceId (Term Symbol Ann, Symbol)
    -&gt; Map TermReferenceId (Term Symbol Ann))
-&gt; Map TermReferenceId (Term Symbol Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Term Symbol Ann, Symbol) -&gt; Term Symbol Ann)
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; Map TermReferenceId (Term Symbol Ann)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690617"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690617"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690616"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690616"><span class="hs-identifier hs-var">_names</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Term Symbol Ann
</span><a href="#local-6989586621679690615"><span class="hs-identifier hs-var">rewrite</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690617"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>                </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-470"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-471"></span><span>                </span><span class="hs-comment">--   #newping       =&gt; &lt;#wham + 4&gt;</span><span>
</span><span id="line-472"></span><span>                </span><span class="hs-comment">--   #pingpong.pong =&gt; &lt;#newping + 2&gt;</span><span>
</span><span id="line-473"></span><span>                </span><span class="hs-comment">--   #wham          =&gt; &lt;#pingpong.pong + 3&gt;</span><span>
</span><span id="line-474"></span><span>                </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
-&gt; (Map TermReferenceId (Term Symbol Ann)
    -&gt; Map TermReferenceId (Term Symbol Ann))
-&gt; Map TermReferenceId (Term Symbol Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
-&gt; Map TermReferenceId (Term Symbol Ann)
-&gt; Map TermReferenceId (Term Symbol Ann)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.union</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
</span><a href="#local-6989586621679690613"><span class="hs-identifier hs-var">interimRefToTerm</span></a></span><span>
</span><span id="line-475"></span><span>                </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
-&gt; (Map TermReferenceId (Term Symbol Ann)
    -&gt; Map TermReferenceId (Symbol, Term Symbol Ann))
-&gt; Map TermReferenceId (Symbol, Term Symbol Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
-&gt; Map TermReferenceId (Symbol, Term Symbol Ann)
forall v a.
Var v =&gt;
Map TermReferenceId (Term v a) -&gt; Map TermReferenceId (v, Term v a)
</span><span class="hs-identifier hs-var">Term.unhashComponent</span></span><span>
</span><span id="line-476"></span><span>              </span><span class="hs-keyword">where</span><span>
</span><span id="line-477"></span><span>                </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-478"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-479"></span><span>                </span><span class="hs-comment">--   #newping =&gt; &lt;#wham + 4&gt;</span><span>
</span><span id="line-480"></span><span>                </span><span class="annot"><a href="#local-6989586621679690613"><span class="hs-identifier hs-type">interimRefToTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>                </span><span id="local-6989586621679690613"><span class="annot"><span class="annottext">interimRefToTerm :: Map TermReferenceId (Term Symbol Ann)
</span><a href="#local-6989586621679690613"><span class="hs-identifier hs-var hs-var">interimRefToTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-482"></span><span>                  </span><span class="annot"><span class="annottext">((Symbol,
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann))
 -&gt; (TermReferenceId, Term Symbol Ann))
-&gt; Map
     Symbol
     (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
-&gt; Map TermReferenceId (Term Symbol Ann)
forall k1 k0 v0 v1.
Ord k1 =&gt;
((k0, v0) -&gt; (k1, v1)) -&gt; Map k0 v0 -&gt; Map k1 v1
</span><span class="hs-identifier hs-var">Map.remap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690611"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690611"><span class="hs-identifier hs-var">_var</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690610"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690610"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690609"><span class="annot"><span class="annottext">Maybe [Char]
</span><a href="#local-6989586621679690609"><span class="hs-identifier hs-var">_wk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690608"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690608"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690607"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690607"><span class="hs-identifier hs-var">_typ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690610"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690608"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map
  Symbol
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690702"><span class="hs-identifier hs-var">nameToInterimInfo</span></a></span><span>
</span><span id="line-483"></span><span>                </span><span class="hs-comment">-- Running example: apply the following reference mapping everwhere in a term:</span><span>
</span><span id="line-484"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-485"></span><span>                </span><span class="hs-comment">--   #pingpong.ping -&gt; #newping</span><span>
</span><span id="line-486"></span><span>                </span><span class="hs-comment">--   ref            -&gt; ref</span><span>
</span><span id="line-487"></span><span>                </span><span class="annot"><a href="#local-6989586621679690615"><span class="hs-identifier hs-type">rewrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span>
</span><span id="line-488"></span><span>                </span><span id="local-6989586621679690615"><span class="annot"><span class="annottext">rewrite :: Term Symbol Ann -&gt; Term Symbol Ann
</span><a href="#local-6989586621679690615"><span class="hs-identifier hs-var hs-var">rewrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-489"></span><span>                  </span><span class="annot"><span class="annottext">Map Reference TermReferenceId -&gt; Term Symbol Ann -&gt; Term Symbol Ann
forall v a.
Ord v =&gt;
Map Reference TermReferenceId -&gt; Term v a -&gt; Term v a
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#rewriteTermReferences"><span class="hs-identifier hs-var">rewriteTermReferences</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Set Reference, TermReferenceId) -&gt; Map Reference TermReferenceId)
-&gt; Map Symbol (Set Reference, TermReferenceId)
-&gt; Map Reference TermReferenceId
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">(Set Reference, TermReferenceId) -&gt; Map Reference TermReferenceId
</span><a href="#local-6989586621679690605"><span class="hs-identifier hs-var">toMapping</span></a></span><span> </span><span class="annot"><span class="annottext">Map Symbol (Set Reference, TermReferenceId)
</span><a href="#local-6989586621679690699"><span class="hs-identifier hs-var">updatedNameToRefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>                  </span><span class="hs-keyword">where</span><span>
</span><span id="line-491"></span><span>                    </span><span class="annot"><a href="#local-6989586621679690605"><span class="hs-identifier hs-type">toMapping</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-492"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-493"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span>
</span><span id="line-494"></span><span>                    </span><span id="local-6989586621679690605"><span class="annot"><span class="annottext">toMapping :: (Set Reference, TermReferenceId) -&gt; Map Reference TermReferenceId
</span><a href="#local-6989586621679690605"><span class="hs-identifier hs-var hs-var">toMapping</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690604"><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690604"><span class="hs-identifier hs-var">oldRefs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690603"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690603"><span class="hs-identifier hs-var">interimRef</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-495"></span><span>                      </span><span class="annot"><span class="annottext">(Reference -&gt; Map Reference TermReferenceId)
-&gt; Set Reference -&gt; Map Reference TermReferenceId
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679690602"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690602"><span class="hs-identifier hs-var">oldRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; TermReferenceId -&gt; Map Reference TermReferenceId
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690602"><span class="hs-identifier hs-var">oldRef</span></a></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690603"><span class="hs-identifier hs-var">interimRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621679690604"><span class="hs-identifier hs-var">oldRefs</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690600"><span class="hs-identifier hs-type">unisonFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span>
</span><span id="line-498"></span><span>            </span><span id="local-6989586621679690600"><span class="annot"><span class="annottext">unisonFile :: UnisonFile Symbol Ann
</span><a href="#local-6989586621679690600"><span class="hs-identifier hs-var hs-var">unisonFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-499"></span><span>              </span><span class="annot"><span class="annottext">UnisonFileId :: forall v a.
Map v (TermReferenceId, DataDeclaration v a)
-&gt; Map v (TermReferenceId, EffectDeclaration v a)
-&gt; [(v, Term v a)]
-&gt; Map [Char] [(v, Term v a)]
-&gt; UnisonFile v a
</span><span class="hs-identifier hs-type">UnisonFileId</span></span><span>
</span><span id="line-500"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:dataDeclarationsId:UnisonFileId :: Map Symbol (TermReferenceId, DataDeclaration Symbol Ann)
</span><span class="hs-identifier hs-var">dataDeclarationsId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (TermReferenceId, DataDeclaration Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (TermReferenceId, DataDeclaration v a)
</span><span class="hs-identifier hs-var hs-var">UF.dataDeclarationsId'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var">slurp0</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-501"></span><span>                  </span><span class="annot"><span class="annottext">$sel:effectDeclarationsId:UnisonFileId :: Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann)
</span><span class="hs-identifier hs-var">effectDeclarationsId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (TermReferenceId, EffectDeclaration v a)
</span><span class="hs-identifier hs-var hs-var">UF.effectDeclarationsId'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpResult -&gt; TypecheckedUnisonFile Symbol Ann
</span><a href="Unison.Codebase.Editor.SlurpResult.html#%24sel%3AoriginalFile%3ASlurpResult"><span class="hs-identifier hs-var hs-var">Slurp.originalFile</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var">slurp0</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-502"></span><span>                  </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-503"></span><span>                  </span><span class="hs-comment">--</span><span>
</span><span id="line-504"></span><span>                  </span><span class="hs-comment">--   fresh1 = fresh3 + 4</span><span>
</span><span id="line-505"></span><span>                  </span><span class="hs-comment">--   fresh2 = fresh1 + 2</span><span>
</span><span id="line-506"></span><span>                  </span><span class="hs-comment">--   fresh3 = fresh2 + 3</span><span>
</span><span id="line-507"></span><span>                  </span><span class="annot"><span class="annottext">$sel:terms:UnisonFileId :: [(Symbol, Term Symbol Ann)]
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Symbol, Term Symbol Ann)
-&gt; [(Symbol, Term Symbol Ann)]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">Map.elems</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Symbol, Term Symbol Ann)
</span><a href="#local-6989586621679690619"><span class="hs-identifier hs-var">refToGeneratedNameAndTerm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-508"></span><span>                  </span><span class="hs-comment">-- In the context of this update, whatever watches were in the latest typechecked Unison file are</span><span>
</span><span id="line-509"></span><span>                  </span><span class="hs-comment">-- irrelevant, so we don't need to copy them over.</span><span>
</span><span id="line-510"></span><span>                  </span><span class="annot"><span class="annottext">$sel:watches:UnisonFileId :: Map [Char] [(Symbol, Term Symbol Ann)]
</span><span class="hs-identifier hs-var">watches</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map [Char] [(Symbol, Term Symbol Ann)]
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-511"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-512"></span><span>        </span><span id="local-6989586621679690595"><span class="annot"><span class="annottext">Result
  (Seq (Note Symbol Ann))
  (Either Names (TypecheckedUnisonFile Symbol Ann))
</span><a href="#local-6989586621679690595"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  (Result
     (Seq (Note Symbol Ann))
     (Either Names (TypecheckedUnisonFile Symbol Ann)))
-&gt; Cli
     (Result
        (Seq (Note Symbol Ann))
        (Either Names (TypecheckedUnisonFile Symbol Ann)))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Transaction
     (Result
        (Seq (Note Symbol Ann))
        (Either Names (TypecheckedUnisonFile Symbol Ann)))
-&gt; IO
     (Result
        (Seq (Note Symbol Ann))
        (Either Names (TypecheckedUnisonFile Symbol Ann)))
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690706"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; [Type Symbol Ann]
-&gt; UnisonFile Symbol Ann
-&gt; Transaction
     (Result
        (Seq (Note Symbol Ann))
        (Either Names (TypecheckedUnisonFile Symbol Ann)))
forall (m :: * -&gt; *).
Codebase m Symbol Ann
-&gt; [Type Symbol Ann]
-&gt; UnisonFile Symbol Ann
-&gt; Transaction
     (Result
        (Seq (Note Symbol Ann))
        (Either Names (TypecheckedUnisonFile Symbol Ann)))
</span><a href="Unison.Cli.TypeCheck.html#typecheckFile"><span class="hs-identifier hs-var">typecheckFile</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679690706"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">UnisonFile Symbol Ann
</span><a href="#local-6989586621679690600"><span class="hs-identifier hs-var">unisonFile</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Identity (Maybe (Either Names (TypecheckedUnisonFile Symbol Ann)))
-&gt; Maybe (Either Names (TypecheckedUnisonFile Symbol Ann))
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
  (Seq (Note Symbol Ann))
  (Either Names (TypecheckedUnisonFile Symbol Ann))
-&gt; Identity
     (Maybe (Either Names (TypecheckedUnisonFile Symbol Ann)))
forall (f :: * -&gt; *) note a.
Functor f =&gt;
ResultT note f a -&gt; f (Maybe a)
</span><span class="hs-identifier hs-var">Result.toMaybe</span></span><span> </span><span class="annot"><span class="annottext">Result
  (Seq (Note Symbol Ann))
  (Either Names (TypecheckedUnisonFile Symbol Ann))
</span><a href="#local-6989586621679690595"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-514"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679690592"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690592"><span class="hs-identifier hs-var">file0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>            </span><span class="hs-comment">-- Map each name generated by unhashing back to the name it should have in the Unison file we're going to</span><span>
</span><span id="line-516"></span><span>            </span><span class="hs-comment">-- typecheck.</span><span>
</span><span id="line-517"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-518"></span><span>            </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-519"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-520"></span><span>            </span><span class="hs-comment">--   &quot;fresh1&quot; -&gt; &quot;ping&quot;</span><span>
</span><span id="line-521"></span><span>            </span><span class="hs-comment">--   &quot;fresh2&quot; -&gt; &quot;pong&quot;</span><span>
</span><span id="line-522"></span><span>            </span><span class="hs-comment">--   &quot;fresh3&quot; -&gt; &quot;wham&quot;</span><span>
</span><span id="line-523"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690591"><span class="hs-identifier hs-type">generatedNameToName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span>
</span><span id="line-524"></span><span>                </span><span id="local-6989586621679690591"><span class="annot"><span class="annottext">generatedNameToName :: Map Symbol Symbol
</span><a href="#local-6989586621679690591"><span class="hs-identifier hs-var hs-var">generatedNameToName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-525"></span><span>                  </span><span class="annot"><span class="annottext">Map TermReferenceId (Symbol, Term Symbol Ann)
</span><a href="#local-6989586621679690619"><span class="hs-identifier hs-var">refToGeneratedNameAndTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Symbol, Term Symbol Ann)
-&gt; (Map TermReferenceId (Symbol, Term Symbol Ann)
    -&gt; Map Symbol Symbol)
-&gt; Map Symbol Symbol
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((TermReferenceId, (Symbol, Term Symbol Ann)) -&gt; (Symbol, Symbol))
-&gt; Map TermReferenceId (Symbol, Term Symbol Ann)
-&gt; Map Symbol Symbol
forall k1 k0 v0 v1.
Ord k1 =&gt;
((k0, v0) -&gt; (k1, v1)) -&gt; Map k0 v0 -&gt; Map k1 v1
</span><span class="hs-identifier hs-var">Map.remap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690590"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690590"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690589"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690589"><span class="hs-identifier hs-var">generatedName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690588"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690588"><span class="hs-identifier hs-var">_term</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690589"><span class="hs-identifier hs-var">generatedName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-527"></span><span>                      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; Map TermReferenceId Symbol -&gt; Maybe Symbol
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690590"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId Symbol
</span><a href="#local-6989586621679690587"><span class="hs-identifier hs-var">interimRefToName</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-528"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690586"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690586"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690586"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-529"></span><span>                        </span><span class="annot"><span class="annottext">Maybe Symbol
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-530"></span><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TermReferenceId
-&gt; Map TermReferenceId (Term Symbol Ann, Symbol)
-&gt; Maybe (Term Symbol Ann, Symbol)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690590"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann, Symbol)
</span><a href="#local-6989586621679690695"><span class="hs-identifier hs-var">implicitTerms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-531"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690585"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690585"><span class="hs-identifier hs-var">_term</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690584"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690584"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690584"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-532"></span><span>                            </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann, Symbol)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Symbol
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E836680&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ref not interim nor implicit&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>                  </span><span class="hs-keyword">where</span><span>
</span><span id="line-535"></span><span>                    </span><span class="hs-comment">-- Associate each term name being updated with its interim reference.</span><span>
</span><span id="line-536"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-537"></span><span>                    </span><span class="hs-comment">-- Running example:</span><span>
</span><span id="line-538"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-539"></span><span>                    </span><span class="hs-comment">--   #newping =&gt; &quot;ping&quot;</span><span>
</span><span id="line-540"></span><span>                    </span><span class="annot"><a href="#local-6989586621679690587"><span class="hs-identifier hs-type">interimRefToName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span>
</span><span id="line-541"></span><span>                    </span><span id="local-6989586621679690587"><span class="annot"><span class="annottext">interimRefToName :: Map TermReferenceId Symbol
</span><a href="#local-6989586621679690587"><span class="hs-identifier hs-var hs-var">interimRefToName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-542"></span><span>                      </span><span class="annot"><span class="annottext">((Symbol,
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann))
 -&gt; (TermReferenceId, Symbol))
-&gt; Map
     Symbol
     (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
-&gt; Map TermReferenceId Symbol
forall k1 k0 v0 v1.
Ord k1 =&gt;
((k0, v0) -&gt; (k1, v1)) -&gt; Map k0 v0 -&gt; Map k1 v1
</span><span class="hs-identifier hs-var">Map.remap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679690583"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690583"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690582"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690582"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690581"><span class="annot"><span class="annottext">Maybe [Char]
</span><a href="#local-6989586621679690581"><span class="hs-identifier hs-var">_wk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690580"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690580"><span class="hs-identifier hs-var">_term</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690579"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690579"><span class="hs-identifier hs-var">_typ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690582"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690583"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map
  Symbol
  (TermReferenceId, Maybe [Char], Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690702"><span class="hs-identifier hs-var">nameToInterimInfo</span></a></span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690578"><span class="hs-identifier hs-type">renameTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-545"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-546"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>                </span><span id="local-6989586621679690578"><span class="annot"><span class="annottext">renameTerm :: (Symbol, Term Symbol Ann, Type Symbol Ann)
-&gt; (Symbol, Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690578"><span class="hs-identifier hs-var hs-var">renameTerm</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690577"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690577"><span class="hs-identifier hs-var">generatedName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690576"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690576"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690575"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690575"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-548"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Map Symbol Symbol -&gt; Maybe Symbol
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690577"><span class="hs-identifier hs-var">generatedName</span></a></span><span> </span><span class="annot"><span class="annottext">Map Symbol Symbol
</span><a href="#local-6989586621679690591"><span class="hs-identifier hs-var">generatedNameToName</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-549"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690574"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690574"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690574"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-550"></span><span>                      </span><span class="annot"><span class="annottext">Maybe Symbol
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Symbol
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E440546&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;no name for generated name&quot;</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-551"></span><span>                    </span><span class="annot"><span class="annottext">Map Symbol Symbol -&gt; Term Symbol Ann -&gt; Term Symbol Ann
forall (f :: * -&gt; *) v a.
(Foldable f, Functor f, Var v) =&gt;
Map v v -&gt; Term f v a -&gt; Term f v a
</span><span class="hs-identifier hs-var">ABT.renames</span></span><span> </span><span class="annot"><span class="annottext">Map Symbol Symbol
</span><a href="#local-6989586621679690591"><span class="hs-identifier hs-var">generatedNameToName</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679690576"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-552"></span><span>                    </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621679690575"><span class="hs-identifier hs-var">typ</span></a></span><span>
</span><span id="line-553"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679690572"><span class="hs-identifier hs-type">file1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span>
</span><span id="line-556"></span><span>                </span><span id="local-6989586621679690572"><span class="annot"><span class="annottext">file1 :: TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690572"><span class="hs-identifier hs-var hs-var">file1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-557"></span><span>                  </span><span class="annot"><span class="annottext">Map Symbol (TermReferenceId, DataDeclaration Symbol Ann)
-&gt; Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann)
-&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
-&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
-&gt; TypecheckedUnisonFile Symbol Ann
forall v a.
Var v =&gt;
Map v (TermReferenceId, DataDeclaration v a)
-&gt; Map v (TermReferenceId, EffectDeclaration v a)
-&gt; [[(v, Term v a, Type v a)]]
-&gt; [([Char], [(v, Term v a, Type v a)])]
-&gt; TypecheckedUnisonFile v a
</span><span class="hs-identifier hs-var">UF.typecheckedUnisonFile</span></span><span>
</span><span id="line-558"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690592"><span class="hs-identifier hs-var">file0</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Getting
     (Map Symbol (TermReferenceId, DataDeclaration Symbol Ann))
     (TypecheckedUnisonFile Symbol Ann)
     (Map Symbol (TermReferenceId, DataDeclaration Symbol Ann))
-&gt; Map Symbol (TermReferenceId, DataDeclaration Symbol Ann)
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;dataDeclarationsId'&quot;
  (Getting
     (Map Symbol (TermReferenceId, DataDeclaration Symbol Ann))
     (TypecheckedUnisonFile Symbol Ann)
     (Map Symbol (TermReferenceId, DataDeclaration Symbol Ann)))
Getting
  (Map Symbol (TermReferenceId, DataDeclaration Symbol Ann))
  (TypecheckedUnisonFile Symbol Ann)
  (Map Symbol (TermReferenceId, DataDeclaration Symbol Ann))
</span><a href="#local-6989586621679690569"><span class="hs-var">#dataDeclarationsId'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690592"><span class="hs-identifier hs-var">file0</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Getting
     (Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann))
     (TypecheckedUnisonFile Symbol Ann)
     (Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann))
-&gt; Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann)
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;effectDeclarationsId'&quot;
  (Getting
     (Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann))
     (TypecheckedUnisonFile Symbol Ann)
     (Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann)))
Getting
  (Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann))
  (TypecheckedUnisonFile Symbol Ann)
  (Map Symbol (TermReferenceId, EffectDeclaration Symbol Ann))
</span><a href="#local-6989586621679690568"><span class="hs-var">#effectDeclarationsId'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>                    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690592"><span class="hs-identifier hs-var">file0</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Getting
     [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
     (TypecheckedUnisonFile Symbol Ann)
     [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
-&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;topLevelComponents'&quot;
  (Getting
     [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
     (TypecheckedUnisonFile Symbol Ann)
     [[(Symbol, Term Symbol Ann, Type Symbol Ann)]])
Getting
  [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
  (TypecheckedUnisonFile Symbol Ann)
  [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
</span><a href="#local-6989586621679690567"><span class="hs-var">#topLevelComponents'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
-&gt; ([[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
    -&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]])
-&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
  [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
  (Symbol, Term Symbol Ann, Type Symbol Ann)
  (Symbol, Term Symbol Ann, Type Symbol Ann)
-&gt; ((Symbol, Term Symbol Ann, Type Symbol Ann)
    -&gt; (Symbol, Term Symbol Ann, Type Symbol Ann))
-&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
-&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(Symbol, Term Symbol Ann, Type Symbol Ann)]
 -&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)])
-&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
-&gt; Identity [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span> </span><span class="annot"><span class="annottext">(([(Symbol, Term Symbol Ann, Type Symbol Ann)]
  -&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)])
 -&gt; [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
 -&gt; Identity [[(Symbol, Term Symbol Ann, Type Symbol Ann)]])
-&gt; (((Symbol, Term Symbol Ann, Type Symbol Ann)
     -&gt; Identity (Symbol, Term Symbol Ann, Type Symbol Ann))
    -&gt; [(Symbol, Term Symbol Ann, Type Symbol Ann)]
    -&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)])
-&gt; ASetter
     [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
     [[(Symbol, Term Symbol Ann, Type Symbol Ann)]]
     (Symbol, Term Symbol Ann, Type Symbol Ann)
     (Symbol, Term Symbol Ann, Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Symbol, Term Symbol Ann, Type Symbol Ann)
 -&gt; Identity (Symbol, Term Symbol Ann, Type Symbol Ann))
-&gt; [(Symbol, Term Symbol Ann, Type Symbol Ann)]
-&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Symbol, Term Symbol Ann, Type Symbol Ann)
-&gt; (Symbol, Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690578"><span class="hs-identifier hs-var">renameTerm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-561"></span><span>                    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690592"><span class="hs-identifier hs-var">file0</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Getting
     [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
     (TypecheckedUnisonFile Symbol Ann)
     [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
-&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;watchComponents&quot;
  (Getting
     [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
     (TypecheckedUnisonFile Symbol Ann)
     [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])])
Getting
  [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
  (TypecheckedUnisonFile Symbol Ann)
  [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
</span><a href="#local-6989586621679690566"><span class="hs-var">#watchComponents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
-&gt; ([([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
    -&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])])
-&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
  [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
  (Symbol, Term Symbol Ann, Type Symbol Ann)
  (Symbol, Term Symbol Ann, Type Symbol Ann)
-&gt; ((Symbol, Term Symbol Ann, Type Symbol Ann)
    -&gt; (Symbol, Term Symbol Ann, Type Symbol Ann))
-&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
-&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
 -&gt; Identity ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)]))
-&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
-&gt; Identity
     [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span> </span><span class="annot"><span class="annottext">((([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
  -&gt; Identity ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)]))
 -&gt; [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
 -&gt; Identity
      [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])])
-&gt; (((Symbol, Term Symbol Ann, Type Symbol Ann)
     -&gt; Identity (Symbol, Term Symbol Ann, Type Symbol Ann))
    -&gt; ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
    -&gt; Identity ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)]))
-&gt; ASetter
     [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
     [([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])]
     (Symbol, Term Symbol Ann, Type Symbol Ann)
     (Symbol, Term Symbol Ann, Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([(Symbol, Term Symbol Ann, Type Symbol Ann)]
 -&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)])
-&gt; ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
-&gt; Identity ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">(([(Symbol, Term Symbol Ann, Type Symbol Ann)]
  -&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)])
 -&gt; ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
 -&gt; Identity ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)]))
-&gt; (((Symbol, Term Symbol Ann, Type Symbol Ann)
     -&gt; Identity (Symbol, Term Symbol Ann, Type Symbol Ann))
    -&gt; [(Symbol, Term Symbol Ann, Type Symbol Ann)]
    -&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)])
-&gt; ((Symbol, Term Symbol Ann, Type Symbol Ann)
    -&gt; Identity (Symbol, Term Symbol Ann, Type Symbol Ann))
-&gt; ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
-&gt; Identity ([Char], [(Symbol, Term Symbol Ann, Type Symbol Ann)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Symbol, Term Symbol Ann, Type Symbol Ann)
 -&gt; Identity (Symbol, Term Symbol Ann, Type Symbol Ann))
-&gt; [(Symbol, Term Symbol Ann, Type Symbol Ann)]
-&gt; Identity [(Symbol, Term Symbol Ann, Type Symbol Ann)]
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Symbol, Term Symbol Ann, Type Symbol Ann)
-&gt; (Symbol, Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621679690578"><span class="hs-identifier hs-var">renameTerm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span>            </span><span class="annot"><span class="annottext">SlurpResult -&gt; Cli SlurpResult
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; SlurpResult
</span><a href="#local-6989586621679690716"><span class="hs-identifier hs-var">slurp</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690572"><span class="hs-identifier hs-var">file1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Either Names (TypecheckedUnisonFile Symbol Ann))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlurpResult -&gt; Cli SlurpResult
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690703"><span class="hs-identifier hs-var">slurp0</span></a></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">SlurpResult
</span><a href="#local-6989586621679690707"><span class="hs-identifier hs-var">slurp1</span></a></span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span id="local-6989586621679690965"><span id="local-6989586621679690966"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#rewriteTermReferences"><span class="hs-identifier hs-type">rewriteTermReferences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679690966"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679690966"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679690965"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679690966"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679690965"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-569"></span><span id="rewriteTermReferences"><span class="annot"><span class="annottext">rewriteTermReferences :: Map Reference TermReferenceId -&gt; Term v a -&gt; Term v a
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#rewriteTermReferences"><span class="hs-identifier hs-var hs-var">rewriteTermReferences</span></a></span></span><span> </span><span id="local-6989586621679690565"><span class="annot"><span class="annottext">Map Reference TermReferenceId
</span><a href="#local-6989586621679690565"><span class="hs-identifier hs-var">mapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-570"></span><span>  </span><span class="annot"><span class="annottext">(F v a a (Term v a) -&gt; F v a a (Term v a)) -&gt; Term v a -&gt; Term v a
forall v (f :: * -&gt; *) a.
(Ord v, Foldable f, Functor f) =&gt;
(f (Term f v a) -&gt; f (Term f v a)) -&gt; Term f v a -&gt; Term f v a
</span><span class="hs-identifier hs-var">ABT.rebuildUp</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679690563"><span class="annot"><span class="annottext">F v a a (Term v a)
</span><a href="#local-6989586621679690563"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-571"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">F v a a (Term v a)
</span><a href="#local-6989586621679690563"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-572"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Ref</span></span><span> </span><span id="local-6989586621679690561"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690561"><span class="hs-identifier hs-var">ref0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-573"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Map Reference TermReferenceId -&gt; Maybe TermReferenceId
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690561"><span class="hs-identifier hs-var">ref0</span></a></span><span> </span><span class="annot"><span class="annottext">Map Reference TermReferenceId
</span><a href="#local-6989586621679690565"><span class="hs-identifier hs-var">mapping</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-574"></span><span>          </span><span class="annot"><span class="annottext">Maybe TermReferenceId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">F v a a (Term v a)
</span><a href="#local-6989586621679690563"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-575"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690560"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690560"><span class="hs-identifier hs-var">ref1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; F v a a (Term v a)
forall typeVar typeAnn patternAnn a.
Reference -&gt; F typeVar typeAnn patternAnn a
</span><span class="hs-identifier hs-var">Term.Ref</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermReferenceId -&gt; Reference
</span><span class="hs-identifier hs-var">Reference.fromId</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679690560"><span class="hs-identifier hs-var">ref1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>      </span><span class="annot"><span class="annottext">F v a a (Term v a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">F v a a (Term v a)
</span><a href="#local-6989586621679690563"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span class="hs-comment">-- updates the namespace for adding `slurp`</span><span>
</span><span id="line-579"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#doSlurpAdds"><span class="hs-identifier hs-type">doSlurpAdds</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679691099"><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-582"></span><span>  </span><span class="annot"><a href="Unison.Codebase.Editor.SlurpComponent.html#SlurpComponent"><span class="hs-identifier hs-type">SlurpComponent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-583"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span id="doSlurpAdds"><span class="annot"><span class="annottext">doSlurpAdds :: SlurpComponent
-&gt; TypecheckedUnisonFile Symbol Ann -&gt; Branch0 m -&gt; Branch0 m
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#doSlurpAdds"><span class="hs-identifier hs-var hs-var">doSlurpAdds</span></a></span></span><span> </span><span id="local-6989586621679690558"><span class="annot"><span class="annottext">SlurpComponent
</span><a href="#local-6989586621679690558"><span class="hs-identifier hs-var">slurp</span></a></span></span><span> </span><span id="local-6989586621679690557"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690557"><span class="hs-identifier hs-var">uf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)] -&gt; Branch0 m -&gt; Branch0 m
forall (f :: * -&gt; *) (m :: * -&gt; *).
(Monad m, Foldable f) =&gt;
f (Path, Branch0 m -&gt; Branch0 m) -&gt; Branch0 m -&gt; Branch0 m
</span><span class="hs-identifier hs-var">Branch.batchUpdates</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690555"><span class="hs-identifier hs-var">typeActions</span></a></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690554"><span class="hs-identifier hs-var">termActions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-587"></span><span>    </span><span id="local-6989586621679690555"><span class="annot"><span class="annottext">typeActions :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690555"><span class="hs-identifier hs-var hs-var">typeActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; [Symbol] -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621679690553"><span class="hs-identifier hs-var">doType</span></a></span><span> </span><span class="annot"><span class="annottext">([Symbol] -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; (Set Symbol -&gt; [Symbol])
-&gt; Set Symbol
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; [Symbol]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">(Set Symbol -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; Set Symbol -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlurpComponent -&gt; Set Symbol
</span><a href="Unison.Codebase.Editor.SlurpComponent.html#%24sel%3Atypes%3ASlurpComponent"><span class="hs-identifier hs-var hs-var">SC.types</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpComponent
</span><a href="#local-6989586621679690558"><span class="hs-identifier hs-var">slurp</span></a></span><span>
</span><span id="line-588"></span><span>    </span><span id="local-6989586621679690554"><span class="annot"><span class="annottext">termActions :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690554"><span class="hs-identifier hs-var hs-var">termActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-589"></span><span>      </span><span class="annot"><span class="annottext">(Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; [Symbol] -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621679690552"><span class="hs-identifier hs-var">doTerm</span></a></span><span> </span><span class="annot"><span class="annottext">([Symbol] -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; (Set Symbol -&gt; [Symbol])
-&gt; Set Symbol
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; [Symbol]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">(Set Symbol -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; Set Symbol -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-590"></span><span>        </span><span class="annot"><span class="annottext">SlurpComponent -&gt; Set Symbol
</span><a href="Unison.Codebase.Editor.SlurpComponent.html#%24sel%3Aterms%3ASlurpComponent"><span class="hs-identifier hs-var hs-var">SC.terms</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpComponent
</span><a href="#local-6989586621679690558"><span class="hs-identifier hs-var">slurp</span></a></span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; Set Symbol -&gt; Set Symbol
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Symbol -&gt; TypecheckedUnisonFile Symbol Ann -&gt; Set Symbol
forall v a. Ord v =&gt; Set v -&gt; TypecheckedUnisonFile v a -&gt; Set v
</span><span class="hs-identifier hs-var">UF.constructorsForDecls</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlurpComponent -&gt; Set Symbol
</span><a href="Unison.Codebase.Editor.SlurpComponent.html#%24sel%3Atypes%3ASlurpComponent"><span class="hs-identifier hs-var hs-var">SC.types</span></a></span><span> </span><span class="annot"><span class="annottext">SlurpComponent
</span><a href="#local-6989586621679690558"><span class="hs-identifier hs-var">slurp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690557"><span class="hs-identifier hs-var">uf</span></a></span><span>
</span><span id="line-591"></span><span>    </span><span id="local-6989586621679690550"><span class="annot"><span class="annottext">names :: Names
</span><a href="#local-6989586621679690550"><span class="hs-identifier hs-var hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; Names
forall v a. Var v =&gt; TypecheckedUnisonFile v a -&gt; Names
</span><span class="hs-identifier hs-var">UF.typecheckedToNames</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690557"><span class="hs-identifier hs-var">uf</span></a></span><span>
</span><span id="line-592"></span><span>    </span><span id="local-6989586621679690549"><span class="annot"><span class="annottext">tests :: Set Symbol
</span><a href="#local-6989586621679690549"><span class="hs-identifier hs-var hs-var">tests</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Symbol] -&gt; Set Symbol
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Symbol] -&gt; Set Symbol) -&gt; [Symbol] -&gt; Set Symbol
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Symbol, Term Symbol Ann) -&gt; Symbol
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Symbol, Term Symbol Ann) -&gt; Symbol)
-&gt; [(Symbol, Term Symbol Ann)] -&gt; [Symbol]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; UnisonFile Symbol Ann -&gt; [(Symbol, Term Symbol Ann)]
forall v a. [Char] -&gt; UnisonFile v a -&gt; [(v, Term v a)]
</span><span class="hs-identifier hs-var">UF.watchesOfKind</span></span><span> </span><span class="annot"><span class="annottext">[Char]
forall a. (Eq a, IsString a) =&gt; a
</span><span class="hs-identifier hs-var">WK.TestWatch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; UnisonFile Symbol Ann
forall v a. TypecheckedUnisonFile v a -&gt; UnisonFile v a
</span><span class="hs-identifier hs-var">UF.discardTypes</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690557"><span class="hs-identifier hs-var">uf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-593"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679690545"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690545"><span class="hs-identifier hs-var">isTestType</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690544"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690544"><span class="hs-identifier hs-var">isTestValue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reference, Reference)
</span><span class="hs-identifier hs-var">IOSource.isTest</span></span><span>
</span><span id="line-594"></span><span>    </span><span id="local-6989586621679690542"><span class="annot"><span class="annottext">md :: Symbol -&gt; Metadata
</span><a href="#local-6989586621679690542"><span class="hs-identifier hs-var hs-var">md</span></a></span></span><span> </span><span id="local-6989586621679690541"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690541"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-595"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Set Symbol -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690541"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Set Symbol
</span><a href="#local-6989586621679690549"><span class="hs-identifier hs-var">tests</span></a></span><span>
</span><span id="line-596"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Reference -&gt; Metadata
</span><span class="hs-identifier hs-var">Metadata.singleton</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690545"><span class="hs-identifier hs-var">isTestType</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690544"><span class="hs-identifier hs-var">isTestValue</span></a></span><span>
</span><span id="line-597"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><span class="hs-identifier hs-var">Metadata.empty</span></span><span>
</span><span id="line-598"></span><span>    </span><span class="annot"><a href="#local-6989586621679690552"><span class="hs-identifier hs-type">doTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>    </span><span id="local-6989586621679690552"><span class="annot"><span class="annottext">doTerm :: Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621679690552"><span class="hs-identifier hs-var hs-var">doTerm</span></a></span></span><span> </span><span id="local-6989586621679690538"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690538"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Set Referent -&gt; [Referent]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Name -&gt; Set Referent
</span><span class="hs-identifier hs-var">Names.termsNamed</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690550"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeFromVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690538"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-600"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621679690536"><span class="hs-identifier hs-var">errorMissingVar</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690538"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-601"></span><span>      </span><span class="hs-special">[</span><span id="local-6989586621679690535"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621679690535"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-602"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690534"><span class="annot"><span class="annottext">split :: Split
</span><a href="#local-6989586621679690534"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Split
</span><span class="hs-identifier hs-var">Path.splitFromName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeFromVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690538"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Split -&gt; Referent -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *).
Split -&gt; Referent -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAddTermName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690534"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621679690535"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Metadata
</span><a href="#local-6989586621679690542"><span class="hs-identifier hs-var">md</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690538"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span>      </span><span id="local-6989586621679690531"><span class="annot"><span class="annottext">[Referent]
</span><a href="#local-6989586621679690531"><span class="hs-identifier hs-var">wha</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-605"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; [Char] -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-606"></span><span>          </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Unison bug, typechecked file w/ multiple terms named &quot;</span></span><span>
</span><span id="line-607"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; [Char]
forall v. Var v =&gt; v -&gt; [Char]
</span><span class="hs-identifier hs-var">Var.nameStr</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690538"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-608"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;: &quot;</span></span><span>
</span><span id="line-609"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Referent] -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Referent]
</span><a href="#local-6989586621679690531"><span class="hs-identifier hs-var">wha</span></a></span><span>
</span><span id="line-610"></span><span>    </span><span class="annot"><a href="#local-6989586621679690553"><span class="hs-identifier hs-type">doType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691099"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>    </span><span id="local-6989586621679690553"><span class="annot"><span class="annottext">doType :: Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621679690553"><span class="hs-identifier hs-var hs-var">doType</span></a></span></span><span> </span><span id="local-6989586621679690529"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690529"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Name -&gt; Set Reference
</span><span class="hs-identifier hs-var">Names.typesNamed</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679690550"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeFromVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690529"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-612"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621679690536"><span class="hs-identifier hs-var">errorMissingVar</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690529"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-613"></span><span>      </span><span class="hs-special">[</span><span id="local-6989586621679690528"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690528"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-614"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690527"><span class="annot"><span class="annottext">split :: Split
</span><a href="#local-6989586621679690527"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Split
</span><span class="hs-identifier hs-var">Path.splitFromName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeFromVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690529"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Split -&gt; Reference -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *).
Split -&gt; Reference -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAddTypeName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690527"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690528"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><span class="hs-identifier hs-var">Metadata.empty</span></span><span>
</span><span id="line-616"></span><span>      </span><span id="local-6989586621679690525"><span class="annot"><span class="annottext">[Reference]
</span><a href="#local-6989586621679690525"><span class="hs-identifier hs-var">wha</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-617"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; [Char] -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-618"></span><span>          </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Unison bug, typechecked file w/ multiple types named &quot;</span></span><span>
</span><span id="line-619"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; [Char]
forall v. Var v =&gt; v -&gt; [Char]
</span><span class="hs-identifier hs-var">Var.nameStr</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690529"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-620"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;: &quot;</span></span><span>
</span><span id="line-621"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Reference] -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Reference]
</span><a href="#local-6989586621679690525"><span class="hs-identifier hs-var">wha</span></a></span><span>
</span><span id="line-622"></span><span>    </span><span id="local-6989586621679690536"><span class="annot"><span class="annottext">errorMissingVar :: Symbol -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621679690536"><span class="hs-identifier hs-var hs-var">errorMissingVar</span></a></span></span><span> </span><span id="local-6989586621679690524"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690524"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; [Char] -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;expected to find &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679690524"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; in &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621679690557"><span class="hs-identifier hs-var">uf</span></a></span><span>
</span><span id="line-623"></span><span>
</span><span id="line-624"></span><span id="local-6989586621679691100"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#doSlurpUpdates"><span class="hs-identifier hs-type">doSlurpUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679691100"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-627"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-628"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-629"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679691100"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-630"></span><span id="doSlurpUpdates"><span class="annot"><span class="annottext">doSlurpUpdates :: [(Name, Reference, Reference)]
-&gt; [(Name, Reference, Reference)]
-&gt; [(Name, Referent)]
-&gt; Branch0 m
-&gt; Branch0 m
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#doSlurpUpdates"><span class="hs-identifier hs-var hs-var">doSlurpUpdates</span></a></span></span><span> </span><span id="local-6989586621679690523"><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690523"><span class="hs-identifier hs-var">typeEdits</span></a></span></span><span> </span><span id="local-6989586621679690522"><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690522"><span class="hs-identifier hs-var">termEdits</span></a></span></span><span> </span><span id="local-6989586621679690521"><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621679690521"><span class="hs-identifier hs-var">deprecated</span></a></span></span><span> </span><span id="local-6989586621679690520"><span class="annot"><span class="annottext">Branch0 m
</span><a href="#local-6989586621679690520"><span class="hs-identifier hs-var">b0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)] -&gt; Branch0 m -&gt; Branch0 m
forall (f :: * -&gt; *) (m :: * -&gt; *).
(Monad m, Foldable f) =&gt;
f (Path, Branch0 m -&gt; Branch0 m) -&gt; Branch0 m -&gt; Branch0 m
</span><span class="hs-identifier hs-var">Branch.batchUpdates</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690519"><span class="hs-identifier hs-var">typeActions</span></a></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690518"><span class="hs-identifier hs-var">termActions</span></a></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690517"><span class="hs-identifier hs-var">deprecateActions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Branch0 m
</span><a href="#local-6989586621679690520"><span class="hs-identifier hs-var">b0</span></a></span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-633"></span><span>    </span><span id="local-6989586621679690519"><span class="annot"><span class="annottext">typeActions :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690519"><span class="hs-identifier hs-var hs-var">typeActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[(Path, Branch0 m -&gt; Branch0 m)]]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">([[(Path, Branch0 m -&gt; Branch0 m)]]
 -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; ([(Name, Reference, Reference)]
    -&gt; [[(Path, Branch0 m -&gt; Branch0 m)]])
-&gt; [(Name, Reference, Reference)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Name, Reference, Reference)]
-&gt; [[(Path, Branch0 m -&gt; Branch0 m)]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *).
(Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690516"><span class="hs-identifier hs-var">doType</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, Reference, Reference)]
 -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Name, Reference, Reference)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690523"><span class="hs-identifier hs-var">typeEdits</span></a></span><span>
</span><span id="line-634"></span><span>    </span><span id="local-6989586621679690518"><span class="annot"><span class="annottext">termActions :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690518"><span class="hs-identifier hs-var hs-var">termActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[(Path, Branch0 m -&gt; Branch0 m)]]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">([[(Path, Branch0 m -&gt; Branch0 m)]]
 -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; ([(Name, Reference, Reference)]
    -&gt; [[(Path, Branch0 m -&gt; Branch0 m)]])
-&gt; [(Name, Reference, Reference)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Name, Reference, Reference)]
-&gt; [[(Path, Branch0 m -&gt; Branch0 m)]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *).
(Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690515"><span class="hs-identifier hs-var">doTerm</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, Reference, Reference)]
 -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Name, Reference, Reference)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference, Reference)]
</span><a href="#local-6989586621679690522"><span class="hs-identifier hs-var">termEdits</span></a></span><span>
</span><span id="line-635"></span><span>    </span><span id="local-6989586621679690517"><span class="annot"><span class="annottext">deprecateActions :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690517"><span class="hs-identifier hs-var hs-var">deprecateActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[(Path, Branch0 m -&gt; Branch0 m)]]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">([[(Path, Branch0 m -&gt; Branch0 m)]]
 -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; ([(Name, Referent)] -&gt; [[(Path, Branch0 m -&gt; Branch0 m)]])
-&gt; [(Name, Referent)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Name, Referent) -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Name, Referent)] -&gt; [[(Path, Branch0 m -&gt; Branch0 m)]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, Referent) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *).
(Name, Referent) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690514"><span class="hs-identifier hs-var">doDeprecate</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, Referent)] -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Name, Referent)] -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621679690521"><span class="hs-identifier hs-var">deprecated</span></a></span><span>
</span><span id="line-636"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-637"></span><span>        </span><span id="local-6989586621679690514"><span class="annot"><span class="annottext">doDeprecate :: (Name, Referent) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690514"><span class="hs-identifier hs-var hs-var">doDeprecate</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690513"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690513"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690512"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621679690512"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Split -&gt; Referent -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *).
Split -&gt; Referent -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeDeleteTermName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Split
</span><span class="hs-identifier hs-var">Path.splitFromName</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690513"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621679690512"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-comment">-- we copy over the metadata on the old thing</span><span>
</span><span id="line-640"></span><span>    </span><span class="hs-comment">-- todo: if the thing being updated, m, is metadata for something x in b0</span><span>
</span><span id="line-641"></span><span>    </span><span class="hs-comment">-- update x's md to reference `m`</span><span>
</span><span id="line-642"></span><span>    </span><span id="local-6989586621679690912"><span class="annot"><a href="#local-6989586621679690516"><span class="hs-identifier hs-type">doType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679690912"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679690912"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-643"></span><span>    </span><span id="local-6989586621679690516"><span class="annot"><span class="annottext">doType :: (Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690516"><span class="hs-identifier hs-var hs-var">doType</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690510"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690510"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690509"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690509"><span class="hs-identifier hs-var">old</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690508"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690508"><span class="hs-identifier hs-var">new</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-644"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679690507"><span class="annot"><span class="annottext">split :: Split
</span><a href="#local-6989586621679690507"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Split
</span><span class="hs-identifier hs-var">Path.splitFromName</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690510"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-645"></span><span>          </span><span id="local-6989586621679690506"><span class="annot"><span class="annottext">oldMd :: Metadata
</span><a href="#local-6989586621679690506"><span class="hs-identifier hs-var hs-var">oldMd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Split -&gt; Reference -&gt; Branch0 m -&gt; Metadata
forall a (m :: * -&gt; *).
(Path, a) -&gt; Reference -&gt; Branch0 m -&gt; Metadata
</span><span class="hs-identifier hs-var">BranchUtil.getTypeMetadataAt</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690507"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690509"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">Branch0 m
</span><a href="#local-6989586621679690520"><span class="hs-identifier hs-var">b0</span></a></span><span>
</span><span id="line-646"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Split -&gt; Reference -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *).
Split -&gt; Reference -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeDeleteTypeName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690507"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690509"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-647"></span><span>            </span><span class="annot"><span class="annottext">Split -&gt; Reference -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *).
Split -&gt; Reference -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAddTypeName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690507"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690508"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621679690506"><span class="hs-identifier hs-var">oldMd</span></a></span><span>
</span><span id="line-648"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-649"></span><span>    </span><span id="local-6989586621679690503"><span class="annot"><a href="#local-6989586621679690515"><span class="hs-identifier hs-type">doTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679690503"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621679690503"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-650"></span><span>    </span><span id="local-6989586621679690515"><span class="annot"><span class="annottext">doTerm :: (Name, Reference, Reference) -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621679690515"><span class="hs-identifier hs-var hs-var">doTerm</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679690502"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690502"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690501"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690501"><span class="hs-identifier hs-var">old</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690500"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690500"><span class="hs-identifier hs-var">new</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-651"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Split -&gt; Referent -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *).
Split -&gt; Referent -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeDeleteTermName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690499"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Referent
</span><span class="hs-identifier hs-var">Referent.Ref</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690501"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-652"></span><span>        </span><span class="annot"><span class="annottext">Split -&gt; Referent -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *).
Split -&gt; Referent -&gt; Metadata -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAddTermName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690499"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Referent
</span><span class="hs-identifier hs-var">Referent.Ref</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690500"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621679690497"><span class="hs-identifier hs-var">oldMd</span></a></span><span>
</span><span id="line-653"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-654"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-655"></span><span>        </span><span id="local-6989586621679690499"><span class="annot"><span class="annottext">split :: Split
</span><a href="#local-6989586621679690499"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Split
</span><span class="hs-identifier hs-var">Path.splitFromName</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679690502"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-656"></span><span>        </span><span class="hs-comment">-- oldMd is the metadata linked to the old definition</span><span>
</span><span id="line-657"></span><span>        </span><span class="hs-comment">-- we relink it to the new definition</span><span>
</span><span id="line-658"></span><span>        </span><span id="local-6989586621679690497"><span class="annot"><span class="annottext">oldMd :: Metadata
</span><a href="#local-6989586621679690497"><span class="hs-identifier hs-var hs-var">oldMd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Split -&gt; Referent -&gt; Branch0 m -&gt; Metadata
forall a (m :: * -&gt; *).
(Path, a) -&gt; Referent -&gt; Branch0 m -&gt; Metadata
</span><span class="hs-identifier hs-var">BranchUtil.getTermMetadataAt</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621679690499"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Referent
</span><span class="hs-identifier hs-var">Referent.Ref</span></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621679690501"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Branch0 m
</span><a href="#local-6989586621679690520"><span class="hs-identifier hs-var">b0</span></a></span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span class="hs-comment">-- Returns True if the operation changed the namespace, False otherwise.</span><span>
</span><span id="line-661"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#propagatePatchNoSync"><span class="hs-identifier hs-type">propagatePatchNoSync</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Patch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path.Absolute</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier hs-type">Cli</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-662"></span><span id="propagatePatchNoSync"><span class="annot"><span class="annottext">propagatePatchNoSync :: Patch -&gt; Absolute -&gt; Cli Bool
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#propagatePatchNoSync"><span class="hs-identifier hs-var hs-var">propagatePatchNoSync</span></a></span></span><span> </span><span id="local-6989586621679690495"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690495"><span class="hs-identifier hs-var">patch</span></a></span></span><span> </span><span id="local-6989586621679690494"><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690494"><span class="hs-identifier hs-var">scopePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-663"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Cli Bool -&gt; Cli Bool
forall a. [Char] -&gt; Cli a -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#time"><span class="hs-identifier hs-var">Cli.time</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;propagatePatchNoSync&quot;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-664"></span><span>    </span><span class="annot"><span class="annottext">(Path, Branch0 IO -&gt; Cli (Branch0 IO)) -&gt; Cli Bool
</span><a href="Unison.Cli.MonadUtils.html#stepAtNoSync%27"><span class="hs-identifier hs-var">Cli.stepAtNoSync'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Absolute -&gt; Path
</span><span class="hs-identifier hs-var hs-var">Path.unabsolute</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621679690494"><span class="hs-identifier hs-var">scopePath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Patch -&gt; Branch0 IO -&gt; Cli (Branch0 IO)
</span><a href="Unison.Codebase.Editor.Propagate.html#propagateAndApply"><span class="hs-identifier hs-var">Propagate.propagateAndApply</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621679690495"><span class="hs-identifier hs-var">patch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span id="local-6989586621679691022"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#recomponentize"><span class="hs-identifier hs-type">recomponentize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679691022"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679691022"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-667"></span><span id="recomponentize"><span class="annot"><span class="annottext">recomponentize :: [(TermReferenceId, a)] -&gt; [(Hash, [a])]
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#recomponentize"><span class="hs-identifier hs-var hs-var">recomponentize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-668"></span><span>  </span><span class="annot"><span class="annottext">Map Hash (Map Pos a) -&gt; [(Hash, [a])]
forall a. Map Hash (Map Pos a) -&gt; [(Hash, [a])]
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#uncomponentize"><span class="hs-identifier hs-var">uncomponentize</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Hash (Map Pos a) -&gt; [(Hash, [a])])
-&gt; ([(TermReferenceId, a)] -&gt; Map Hash (Map Pos a))
-&gt; [(TermReferenceId, a)]
-&gt; [(Hash, [a])]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(TermReferenceId, a)] -&gt; Map Hash (Map Pos a)
forall a. [(TermReferenceId, a)] -&gt; Map Hash (Map Pos a)
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#componentize"><span class="hs-identifier hs-var">componentize</span></a></span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="hs-comment">-- Misc. helper: convert a component in listy-form to mappy-form.</span><span>
</span><span id="line-671"></span><span id="local-6989586621679691004"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#componentize"><span class="hs-identifier hs-type">componentize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679691004"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Pos</span></span><span> </span><span class="annot"><a href="#local-6989586621679691004"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-672"></span><span id="componentize"><span class="annot"><span class="annottext">componentize :: [(TermReferenceId, a)] -&gt; Map Hash (Map Pos a)
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#componentize"><span class="hs-identifier hs-var hs-var">componentize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-673"></span><span>  </span><span class="annot"><span class="annottext">(Map Hash (Map Pos a)
 -&gt; (TermReferenceId, a) -&gt; Map Hash (Map Pos a))
-&gt; Map Hash (Map Pos a)
-&gt; [(TermReferenceId, a)]
-&gt; Map Hash (Map Pos a)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Map Hash (Map Pos a)
-&gt; (TermReferenceId, a) -&gt; Map Hash (Map Pos a)
forall a.
Map Hash (Map Pos a)
-&gt; (TermReferenceId, a) -&gt; Map Hash (Map Pos a)
</span><a href="#local-6989586621679690489"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Map Hash (Map Pos a)
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-674"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-675"></span><span>    </span><span id="local-6989586621679690899"><span class="annot"><a href="#local-6989586621679690489"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Pos</span></span><span> </span><span class="annot"><a href="#local-6989586621679690899"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679690899"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Pos</span></span><span> </span><span class="annot"><a href="#local-6989586621679690899"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-676"></span><span>    </span><span id="local-6989586621679690489"><span class="annot"><span class="annottext">step :: Map Hash (Map Pos a)
-&gt; (TermReferenceId, a) -&gt; Map Hash (Map Pos a)
</span><a href="#local-6989586621679690489"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679690488"><span class="annot"><span class="annottext">Map Hash (Map Pos a)
</span><a href="#local-6989586621679690488"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621679690486"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690486"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span id="local-6989586621679690485"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679690485"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679690484"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679690484"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-677"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (Map Pos a) -&gt; Map Pos a)
-&gt; Hash -&gt; Map Hash (Map Pos a) -&gt; Map Hash (Map Pos a)
forall k v. Ord k =&gt; (Maybe v -&gt; v) -&gt; k -&gt; Map k v -&gt; Map k v
</span><span class="hs-identifier hs-var">Map.upsert</span></span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-679"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Map Pos a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; a -&gt; Map Pos a
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679690485"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679690484"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-680"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679690483"><span class="annot"><span class="annottext">Map Pos a
</span><a href="#local-6989586621679690483"><span class="hs-identifier hs-var">acc1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; a -&gt; Map Pos a -&gt; Map Pos a
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679690485"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679690484"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos a
</span><a href="#local-6989586621679690483"><span class="hs-identifier hs-var">acc1</span></a></span><span>
</span><span id="line-681"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-682"></span><span>        </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679690486"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-683"></span><span>        </span><span class="annot"><span class="annottext">Map Hash (Map Pos a)
</span><a href="#local-6989586621679690488"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span class="hs-comment">-- Misc. helper: convert a component in mappy-form to listy-form.</span><span>
</span><span id="line-686"></span><span id="local-6989586621679691003"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update.html#uncomponentize"><span class="hs-identifier hs-type">uncomponentize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Pos</span></span><span> </span><span class="annot"><a href="#local-6989586621679691003"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679691003"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-687"></span><span id="uncomponentize"><span class="annot"><span class="annottext">uncomponentize :: Map Hash (Map Pos a) -&gt; [(Hash, [a])]
</span><a href="Unison.Codebase.Editor.HandleInput.Update.html#uncomponentize"><span class="hs-identifier hs-var hs-var">uncomponentize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-688"></span><span>  </span><span class="annot"><span class="annottext">ASetter [(Hash, Map Pos a)] [(Hash, [a])] (Map Pos a) [a]
-&gt; (Map Pos a -&gt; [a]) -&gt; [(Hash, Map Pos a)] -&gt; [(Hash, [a])]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Hash, Map Pos a) -&gt; Identity (Hash, [a]))
-&gt; [(Hash, Map Pos a)] -&gt; Identity [(Hash, [a])]
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span> </span><span class="annot"><span class="annottext">(((Hash, Map Pos a) -&gt; Identity (Hash, [a]))
 -&gt; [(Hash, Map Pos a)] -&gt; Identity [(Hash, [a])])
-&gt; ((Map Pos a -&gt; Identity [a])
    -&gt; (Hash, Map Pos a) -&gt; Identity (Hash, [a]))
-&gt; ASetter [(Hash, Map Pos a)] [(Hash, [a])] (Map Pos a) [a]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Map Pos a -&gt; Identity [a])
-&gt; (Hash, Map Pos a) -&gt; Identity (Hash, [a])
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Pos a -&gt; [a]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">Map.elems</span></span><span> </span><span class="annot"><span class="annottext">([(Hash, Map Pos a)] -&gt; [(Hash, [a])])
-&gt; (Map Hash (Map Pos a) -&gt; [(Hash, Map Pos a)])
-&gt; Map Hash (Map Pos a)
-&gt; [(Hash, [a])]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Hash (Map Pos a) -&gt; [(Hash, Map Pos a)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span>
</span><span id="line-689"></span></pre></body></html>